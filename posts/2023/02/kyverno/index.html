<!doctype html><html lang=en><head><title>kyverno, kubernetes native policy management ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Update on Feb 9th, 2023: this blog article is now on Medium.
I wanted to give Kyverno a try, to learn more about it. Here we are!
When I was attending KubeCon NA 2022, I noticed the maturity and importance of Kyverno. Concrete use cases and advanced scenarios presented by customers and partners piqued my curiosity. With the recent Cloud Native SecurityCon 2023, same feeling.
In this blog post we will illustrate how to:"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2023/02/kyverno/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="kyverno, kubernetes native policy management"><meta name=twitter:description content="let’s see the capabilities of kyverno to manage policies in kubernetes cluster"><meta property="og:title" content="kyverno, kubernetes native policy management"><meta property="og:description" content="let’s see the capabilities of kyverno to manage policies in kubernetes cluster"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2023/02/kyverno/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-20T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-20T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>kyverno, kubernetes native policy management</h1><div class=post-meta><span class=post-date>2023-02-20</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/policies/>#policies</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;</span><div class=post-content><p><em>Update on Feb 9th, 2023: this blog article is now on <a href=https://medium.com/@mabenoit/7ca01fa372a3>Medium</a>.</em></p><p>I wanted to give <a href=https://kyverno.io/>Kyverno</a> a try, to learn more about it. Here we are!</p><p>When I was attending KubeCon NA 2022, I noticed the <a href=https://nirmata.com/2022/11/07/policy-governance-and-automation-crossed-the-chasm-at-kubecon-north-america-2022/>maturity and importance of Kyverno</a>. Concrete use cases and advanced scenarios presented by customers and partners piqued my curiosity. With the recent <a href=https://nirmata.com/2023/02/07/notes-from-cloud-native-securitycon-2023/>Cloud Native SecurityCon 2023</a>, same feeling.</p><p>In this blog post we will illustrate how to:</p><ul><li><a href=#create-a-policy-to-enforce-that-any-pod-should-have-a-required-label>Create a policy to enforce that any <code>Pod</code> should have a required label</a></li><li><a href=#evaluate-the-policy-locally-with-the-kyverno-cli>Evaluate the policy locally with the Kyverno CLI</a></li><li><a href=#evaluate-the-policy-in-a-kubernetes-cluster>Evaluate the policy in a Kubernetes cluster</a></li><li><a href=#create-a-policy-to-enforce-that-any-container-image-should-be-signed-with-cosign>Create a policy to enforce that any container image should be signed with Cosign</a></li><li><a href=#create-a-policy-to-enforce-that-any-namespace-should-have-a-networkpolicy>Create a policy to enforce that any <code>Namespace</code> should have a <code>NetworkPolicy</code></a></li><li><a href=#bundle-and-share-policies-as-oci-images>Bundle and share policies as OCI images</a></li></ul><h2 id=create-a-policy-to-enforce-that-any-pod-should-have-a-required-label>Create a policy to enforce that any <code>Pod</code> should have a required label
<a href=#create-a-policy-to-enforce-that-any-pod-should-have-a-required-label class=h-anchor aria-hidden=true>#</a></h2><p>Create a dedicated folder for the associated files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p policies
</span></span></code></pre></div><p>Define our first policy in <code>enforce</code> mode to require the label <code>app.kubernetes.io/name</code> for any <code>Pods</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; policies/pod-require-name-label.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: kyverno.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ClusterPolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: pod-require-name-label
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  validationFailureAction: Enforce
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  background: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  rules:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - name: check-for-name-label
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    match:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      any:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - resources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          kinds:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - Pod
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    exclude:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      any:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - resources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          namespaces:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - kube-system
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - kyverno
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    validate:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      message: &#34;label &#39;app.kubernetes.io/name&#39; is required&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      pattern:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          labels:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            app.kubernetes.io/name: &#34;?*&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p><em>Note: In this example we also illustrate that we don’t want this policy to be enforced in the <code>kube-system</code> and <code>kyverno</code> namespaces.</em></p><p>Kyverno has a <a href=https://kyverno.io/policies/>library of policies</a>. This library is very helpful, we can deploy the ready-to-use policies as well as taking inspiration of them to write our own custom policies.</p><h2 id=evaluate-the-policy-locally-with-the-kyverno-cli>Evaluate the policy locally with the Kyverno CLI
<a href=#evaluate-the-policy-locally-with-the-kyverno-cli class=h-anchor aria-hidden=true>#</a></h2><p>Define locally a <code>Deployment</code> without the required label:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span>nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --dry-run<span style=color:#f92672>=</span>client <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -o yaml &gt; deploy-without-name-label.yaml
</span></span></code></pre></div><p>Test locally the policy against this <code>Deployment</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kyverno apply policies/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -r deploy-without-name-label.yaml
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Applying 1 policy rule to 1 resource...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>policy pod-require-name-label -&gt; resource default/Deployment/nginx failed:
</span></span><span style=display:flex><span>1. autogen-check-for-name-label: validation error: label &#39;app.kubernetes.io/name&#39; is required. rule autogen-check-for-name-label failed at path /spec/template/metadata/labels/app.kubernetes.io/name/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pass: 0, fail: 1, warn: 0, error: 0, skip: 2
</span></span></code></pre></div><p>Wow, wait! What just happened?!</p><p>We just used the <a href=https://kyverno.io/docs/kyverno-cli>Kyverno CLI</a> to evaluate the policy against our local <code>Deployment</code> file. This client makes it very convenient to test policies without any Kubernetes cluster. We can for example integrate this test during our Continuous Integration (CI) pipelines.</p><p>Another very important concept we just illustrated is the <a href=https://kyverno.io/docs/writing-policies/autogen/>Auto-Gen rules for Pod Controllers</a> feature. In our case, we defined our policy on Pods, but in our test, we evaluate this policy against a Deployment definition. The non compliant <code>Deployment</code> resource is directly blocked.</p><h2 id=evaluate-the-policy-in-a-kubernetes-cluster>Evaluate the policy in a Kubernetes cluster
<a href=#evaluate-the-policy-in-a-kubernetes-cluster class=h-anchor aria-hidden=true>#</a></h2><p><a href=https://kyverno.io/docs/installation/>Install Kyverno</a> in any Kubernetes cluster.</p><p>Deploy a <code>Deployment</code> without the required label that we will reuse later in this post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span>nginx
</span></span></code></pre></div><p>Deploy the policy in the cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f policies/pod-require-name-label.yaml
</span></span></code></pre></div><p>Try to deploy a <code>Deployment</code> without the required label:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span>nginx
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>error: failed to create deployment: admission webhook &#34;validate.kyverno.svc-fail&#34; denied the request: 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>policy Deployment/default/nginx2 for resource violation: 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pod-require-name-label:
</span></span><span style=display:flex><span>  autogen-check-for-name-label: &#39;validation error: label &#39;&#39;app.kubernetes.io/name&#39;&#39;
</span></span><span style=display:flex><span>    is required. rule autogen-check-for-name-label failed at path /spec/template/metadata/labels/app.kubernetes.io/name/&#39;
</span></span></code></pre></div><p>Great, any <code>Pod</code> (or associated resources like <code>Deployment</code>, <code>ReplicaSet</code>, <code>Job</code>, <code>Daemonset</code>, etc.) needs to have this required label, otherwise they can’t be deployed.</p><p>Check that the existing <code>Deployment</code> without the required label is reported too:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get policyreport -A
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>NAMESPACE   NAME                          PASS   FAIL   WARN   ERROR   SKIP   AGE
</span></span><span style=display:flex><span>default     cpol-pod-require-name-label   0      2      0      0       0      5m40s
</span></span></code></pre></div><p>This <a href=https://kyverno.io/docs/policy-reports/>policy report</a> is in place with policies with <a href=https://kyverno.io/docs/writing-policies/background/><code>background: true</code></a>, which is the default value for any policy.</p><p>We can see more details about the error by running the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get policyreport cpol-pod-require-name-label <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -n default <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -o yaml
</span></span></code></pre></div><h2 id=create-a-policy-to-enforce-that-any-container-image-should-be-signed-with-cosign>Create a Policy to enforce that any container image should be signed with Cosign
<a href=#create-a-policy-to-enforce-that-any-container-image-should-be-signed-with-cosign class=h-anchor aria-hidden=true>#</a></h2><p>Let’s now illustrate an advanced scenario where we want to make sure that <a href=https://kyverno.io/docs/writing-policies/verify-images/>any container images deployed in our cluster is signed by Cosign with our own signature</a>.</p><p>Get the <code>nginx</code> container image in our private registry to illustrate this section. We use the <a href=https://oras.land/>ORAS CLI</a> for this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PRIVATE_REGISTRY<span style=color:#f92672>=</span>FIXME
</span></span><span style=display:flex><span>oras cp docker.io/library/nginx:latest $PRIVATE_REGISTRY/nginx:latest
</span></span></code></pre></div><p>Get the associated digest of this image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SHA<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>oras manifest fetch $PRIVATE_REGISTRY/nginx:latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --descriptor <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | jq -r .digest<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>Generate a public-private key pair with <a href=https://docs.sigstore.dev/cosign/overview/>Cosign</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cosign generate-key-pair
</span></span></code></pre></div><p>Sign the container image with Cosign:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cosign sign <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --key cosign.key $PRIVATE_REGISTRY/nginx@$SHA
</span></span></code></pre></div><p>Define the policy in <code>enforce</code> mode to require the appropriate Cosign signature for the container images of any <code>Pods</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; policies/container-images-need-to-be-signed.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: kyverno.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ClusterPolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: container-images-need-to-be-signed
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  validationFailureAction: Enforce
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  background: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  rules:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - name: container-images-need-to-be-signed
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    match:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      any:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - resources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          kinds:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - Pod
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    exclude:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      any:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - resources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          namespaces:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - kube-system
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - kyverno
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    verifyImages:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - imageReferences:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        attestors:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - count: 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          entries:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - keys:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              secret:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                name: cosign-public-key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                namespace: default
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Create the associated <code>Secret</code> with our Cosign signature public key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create secret generic cosign-public-key <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --from-file<span style=color:#f92672>=</span>cosign.pub
</span></span></code></pre></div><p>Deploy this policy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f policies/container-images-need-to-be-signed.yaml
</span></span></code></pre></div><p>Try to deploy a <code>Deployment</code> without the appropriate container image signed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span>nginx
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>error: failed to create deployment: admission webhook &#34;mutate.kyverno.svc-fail&#34; denied the request: 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>policy Deployment/default/nginx2 for resource violation: 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>container-images-need-to-be-signed:
</span></span><span style=display:flex><span>  autogen-container-images-need-to-be-signed: |
</span></span><span style=display:flex><span>    failed to verify image docker.io/nginx:latest: .attestors[0].entries[0].keys: no matching signatures:
</span></span></code></pre></div><p>Great, any <code>Pod</code> (or associated resources like <code>Deployment</code>, <code>ReplicaSet</code>, <code>Job</code>, <code>Daemonset</code>, etc.) needs to have its container images signed by Cosign, otherwise they can’t be deployed.</p><p>Deploy a <code>Pod</code> with the appropriate container image signed earlier and with the required label:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl run nginx3 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image $PRIVATE_REGISTRY/nginx@$SHA <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --labels app.kubernetes.io/name<span style=color:#f92672>=</span>nginx
</span></span></code></pre></div><p>Success! Wow, congrats! We just enforced that any container images deployed in our cluster should be signed.</p><h2 id=create-a-policy-to-enforce-that-any-namespace-should-have-a-networkpolicy>Create a policy to enforce that any <code>Namespace</code> should have a <code>NetworkPolicy</code>
<a href=#create-a-policy-to-enforce-that-any-namespace-should-have-a-networkpolicy class=h-anchor aria-hidden=true>#</a></h2><p>Another use case with Kubernetes policies is to check if a resource exists in a <code>Namespace</code>. For example, we want to guarantee that any <code>Namespace</code> has at least one <code>NetworkPolicy</code>. For this we will <a href=https://kyverno.io/docs/writing-policies/external-data-sources/#variables-from-kubernetes-api-server-calls>check the variables from Kubernetes API Server calls</a>.</p><p>Define the policy in <code>audit</code> mode to require any <code>Namespace</code> should have at least one <code>NetworkPolicy</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; policies/namespace-needs-networkpolicy.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: kyverno.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ClusterPolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: namespace-needs-networkpolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  validationFailureAction: Audit
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  background: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  rules:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - name: namespace-needs-networkpolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    match:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      any:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - resources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          kinds:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - Namespace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    exclude:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      any:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - resources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          namespaces:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - kube-system
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - kube-node-lease
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - kube-public
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - kyverno
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    context:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - name: allnetworkpolicies
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      apiCall:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        urlPath: &#34;/apis/networking.k8s.io/v1/networkpolicies&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        jmesPath: &#34;items[].metadata.namespace&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    validate:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      message: &#34;All Namespaces must have a NetworkPolicy.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      deny:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        conditions:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          all:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - key: &#34;{{request.object.metadata.name}}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            operator: AnyNotIn
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            value: &#34;{{allnetworkpolicies}}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p><em>Tips: We can test this API call by running this command: <code>kubectl get --raw /apis/networking.k8s.io/v1/networkpolicies | jq .items.</code></em></p><p>Check that the existing <code>default</code> <code>Namespace</code> without the required <code>NetworkPolicy</code> is reported:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get clusterpolicyreport -A
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>NAME                                 PASS   FAIL   WARN   ERROR   SKIP   AGE
</span></span><span style=display:flex><span>cpol-namespace-needs-networkpolicy   0      1      0      0       0      62s
</span></span></code></pre></div><p>We can see more details about the error by running the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get clusterpolicyreport cpol-namespace-needs-networkpolicy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -o yaml
</span></span></code></pre></div><h2 id=bundle-and-share-policies-as-oci-images>Bundle and share policies as OCI images
<a href=#bundle-and-share-policies-as-oci-images class=h-anchor aria-hidden=true>#</a></h2><p>Let’s use one more feature of the <a href=https://kyverno.io/docs/kyverno-cli>Kyverno CLI</a>.</p><p>One way to store and share our policies is to store them in a Git repository. But another option is to store them in an OCI registry. The Kyverno CLI allows to <a href=https://kyverno.io/docs/kyverno-cli/#oci><code>push</code> and <code>pull</code> policies as OCI image</a> with our OCI registry.</p><p>Bundle and push our policies in our OCI registry:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kyverno oci push <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -i $PRIVATE_REGISTRY/policies:1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --policy policies/
</span></span></code></pre></div><p>Check the OCI image manifest:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>oras manifest fetch $PRIVATE_REGISTRY/policies:1 --pretty
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;schemaVersion&#34;: 2,
</span></span><span style=display:flex><span>  &#34;mediaType&#34;: &#34;application/vnd.oci.image.manifest.v1+json&#34;,
</span></span><span style=display:flex><span>  &#34;config&#34;: {
</span></span><span style=display:flex><span>    &#34;mediaType&#34;: &#34;application/vnd.cncf.kyverno.config.v1+json&#34;,
</span></span><span style=display:flex><span>    &#34;size&#34;: 233,
</span></span><span style=display:flex><span>    &#34;digest&#34;: &#34;sha256:40d87721b725bf77c87e102d4e4564a2a8efe94140a81eeef0c8d690ab83acec&#34;
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  &#34;layers&#34;: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;mediaType&#34;: &#34;application/vnd.cncf.kyverno.policy.layer.v1+yaml&#34;,
</span></span><span style=display:flex><span>      &#34;size&#34;: 740,
</span></span><span style=display:flex><span>      &#34;digest&#34;: &#34;sha256:83ba733ea934fce32f88be938e12e9ae14f6c3a1c743cde238df02462d1bb2ee&#34;,
</span></span><span style=display:flex><span>      &#34;annotations&#34;: {
</span></span><span style=display:flex><span>        &#34;io.kyverno.image.apiVersion&#34;: &#34;kyverno.io/v1&#34;,
</span></span><span style=display:flex><span>        &#34;io.kyverno.image.kind&#34;: &#34;ClusterPolicy&#34;,
</span></span><span style=display:flex><span>        &#34;io.kyverno.image.name&#34;: &#34;pod-require-name-label&#34;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>From here, we can use <code>kyverno pull</code> to download these policies.</p><h2 id=conclusion>Conclusion
<a href=#conclusion class=h-anchor aria-hidden=true>#</a></h2><p>I’m very impressed by the capabilities of Kyverno. The documentation is very clear, well organized and a lot of code samples are provided to simplify the learning experience. <code>ClusterPolicies</code> are really easy to write.</p><p>Like any policies engine we can manage policies to add more security and governance in our Kubernetes clusters. But Kyverno can do way more than just that, and in a simple manner. The two features illustrated in this post which blow my mind are: <a href=https://kyverno.io/docs/writing-policies/verify-images/>check the image signatures</a> and <a href=https://kyverno.io/docs/writing-policies/autogen/>automatically generate rules for <code>Pod</code> controllers</a>.</p><p>Kyverno has more powerful features we didn’t cover in this post:</p><ul><li><a href=https://kyverno.io/docs/writing-policies/external-data-sources>Use external data sources in Policies</a></li><li><a href=https://kyverno.io/docs/writing-policies/mutate/>Mutate resources</a></li><li><a href=https://kyverno.io/docs/writing-policies/generate/>Generate resources</a></li><li><a href=https://kyverno.io/docs/testing-policies/>Test policies</a></li></ul><p>Happy policies, happy sailing, cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2023/03/chainguard-nginx/><span class=button__icon>←</span>
<span class=button__text>chainguard nginx container image</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2023/02/2022-review/><span class=button__text>2022 in review, first year in devrel</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>