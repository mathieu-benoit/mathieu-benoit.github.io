<!doctype html><html lang=en><head><title>validating admission policies, the future of kubernetes policies ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Update on Jan 23rd, 2023: this blog article is now on Medium.
Kubernetes 1.26 just introduced an alpha feature: Validating Admission Policies.
Validating admission policies use the Common Expression Language (CEL) to offer a declarative, in-process alternative to validating admission webhooks.
CEL was first introduced to Kubernetes for the Validation rules for CustomResourceDefinitions. This enhancement expands the use of CEL in Kubernetes to support a far wider range of admission use cases."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog.io/posts/2023/01/validating-admission-policies/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog.io/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="validating admission policies, the future of kubernetes policies"><meta name=twitter:description content="let's see how to use the new validating admission policies feature in kubernetes 1.26+ and what it brings for the future of kubernetes policies"><meta property="og:title" content="validating admission policies, the future of kubernetes policies"><meta property="og:description" content="let's see how to use the new validating admission policies feature in kubernetes 1.26+ and what it brings for the future of kubernetes policies"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog.io/posts/2023/01/validating-admission-policies/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-12T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-12T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>validating admission policies, the future of kubernetes policies</h1><div class=post-meta><span class=post-date>2023-01-12</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/security/>#security</a>&nbsp;</span><div class=post-content><p><em>Update on Jan 23rd, 2023: this blog article is now on <a href=https://medium.com/google-cloud/ed1321bcf739>Medium</a>.</em></p><p>Kubernetes 1.26 just introduced an alpha feature: <a href=https://kubernetes.io/blog/2022/12/20/validating-admission-policies-alpha/>Validating Admission Policies</a>.</p><blockquote><p>Validating admission policies use the <a href=https://github.com/google/cel-spec>Common Expression Language (CEL)</a> to offer a declarative, in-process alternative to validating admission webhooks.</p></blockquote><blockquote><p>CEL was first introduced to Kubernetes for the Validation rules for CustomResourceDefinitions. This <a href=https://github.com/kubernetes/enhancements/blob/master/keps/sig-api-machinery/3488-cel-admission-control/README.md>enhancement</a> expands the use of CEL in Kubernetes to support a far wider range of admission use cases.</p></blockquote><blockquote><p>Admission webhooks can be burdensome to develop and operate. Webhook developers must implement and maintain a webhook binary to handle admission requests. Also, admission webhooks are complex to operate. Each webhook must be deployed, monitored and have a well defined upgrade and rollback plan. To make matters worse, if a webhook times out or becomes unavailable, the Kubernetes control plane can become unavailable.</p></blockquote><blockquote><p>This enhancement avoids much of this complexity of admission webhooks by embedding CEL expressions into Kubernetes resources instead of calling out to a remote webhook binary.</p></blockquote><p>If you want to learn more about this feature and where it&rsquo;s coming from, I encourage you to watch <a href=https://sched.co/182Q6>Joe Betz&rsquo;s session at KubeCon NA 2022</a>, I found it very insightful:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/gJWMvsC7Mzo style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="Webhook Fatigue? You're Not Alone: Introducing the CEL Expression Language Features Solving This Problem"></iframe></div><p>In this blog article, let&rsquo;s see in actions how we could leverage this new Validating Admission Policies feature. Based on my knowledge with Gatekeeper policies, I will also try to add some comments about what could be the missing features based on my own experience.</p><p>Here is what will be accomplished throughout this blog article:</p><ul><li><a href=#create-a-gke-cluster-with-the-validating-admission-policies-alpha-feature>Create a GKE cluster with the Validating Admission Policies alpha feature</a></li><li><a href=##create-a-simple-policy-with-max-of-3-replicas-for-any-deployments>Create a simple policy with max of 3 replicas for any <code>Deployments</code></a></li><li><a href=#pass-parameters-to-the-policy>Pass parameters to the policy</a></li><li><a href=#exclude-namespaces-from-the-policy>Exclude namespaces from the policy</a></li><li><a href=#limitations-gaps-and-thoughts>Limitations, gaps and thoughts</a></li><li><a href=#conclusion>Conclusion</a></li></ul><p><em>Note: while testing this feature by leveraging its associated <a href=https://kubernetes.io/blog/2022/12/20/validating-admission-policies-alpha/>blog</a> and <a href=https://kubernetes.io/docs/reference/access-authn-authz/validating-admission-policy/>doc</a>, it was also the opportunity for me to open my first PRs in the <code>kubernetes/website</code> repo to fix some frictions I faced: <a href=https://github.com/kubernetes/website/pull/38893>https://github.com/kubernetes/website/pull/38893</a> and <a href=https://github.com/kubernetes/website/pull/38908>https://github.com/kubernetes/website/pull/38908</a>.</em></p><h2 id=create-a-gke-cluster-with-the-validating-admission-policies-alpha-feature>Create a GKE cluster with the Validating Admission Policies alpha feature
<a href=#create-a-gke-cluster-with-the-validating-admission-policies-alpha-feature class=h-anchor aria-hidden=true>#</a></h2><p>GKE just got the <a href=https://cloud.google.com/kubernetes-engine/docs/release-notes-rapid#January_05_2023>version 1.26 available</a>, we could check the versions available by running this command <code>gcloud container get-server-config --zone us-central1-c</code>.</p><p>Let&rsquo;s provision a <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/creating-an-alpha-cluster>cluster in <code>alpha</code> mode (not for production)</a> with the version 1.26:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud container clusters create cel-admission-control-cluster <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-kubernetes-alpha <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --no-enable-autorepair <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --no-enable-autoupgrade <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --release-channel rapid <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cluster-version 1.26.0-gke.1500 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --zone us-central1-c
</span></span></code></pre></div><p>Once the cluster provisioned, we can check that the Validating Admission Policies alpha feature is availabe with the two associated resources <a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#validatingadmissionpolicy-v1alpha1-admissionregistration-k8s-io><code>ValidatingAdmissionPolicy</code></a> and <a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#validatingadmissionpolicybinding-v1alpha1-admissionregistration-k8s-io><code>ValidatingAdmissionPolicyBinding</code></a>, <code>kubectl api-resources | grep ValidatingAdmissionPolicy</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>validatingadmissionpolicies                      admissionregistration.k8s.io/v1alpha1   false        ValidatingAdmissionPolicy
</span></span><span style=display:flex><span>validatingadmissionpolicybindings                admissionregistration.k8s.io/v1alpha1   false        ValidatingAdmissionPolicyBinding
</span></span></code></pre></div><p>Before jumping in creating and testing the policies, let&rsquo;s deploy a sample app in our cluster that we could leverage later in this blog:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create ns sample-app
</span></span><span style=display:flex><span>kubectl create deployment sample-app <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span>nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --replicas <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -n sample-app
</span></span></code></pre></div><h2 id=create-a-simple-policy-with-max-of-3-replicas-for-any-deployments>Create a simple policy with max of 3 replicas for any <code>Deployments</code>
<a href=#create-a-simple-policy-with-max-of-3-replicas-for-any-deployments class=h-anchor aria-hidden=true>#</a></h2><p>Let&rsquo;s do it, let&rsquo;s deploy our first policy!</p><p>This policy is composed by one <code>ValidatingAdmissionPolicy</code> defining the validation with the CEL expression and one <code>ValidatingAdmissionPolicyBinding</code> binding the policy to the appropriate resources in the cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: admissionregistration.k8s.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ValidatingAdmissionPolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  failurePolicy: Fail
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  matchConstraints:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    resourceRules:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - apiGroups:   [&#34;apps&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      apiVersions: [&#34;v1&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      operations:  [&#34;CREATE&#34;, &#34;UPDATE&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      resources:   [&#34;deployments&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  validations:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - expression: &#34;object.spec.replicas &lt;= 3&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: admissionregistration.k8s.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ValidatingAdmissionPolicyBinding
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  policyName: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Now, let&rsquo;s try to deploy an app with 5 replicas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx --image<span style=color:#f92672>=</span>nginx --replicas <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>We can see that our policy is enforced, great!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>error: failed to create deployment: deployments.apps &#34;nginx&#34; is forbidden: ValidatingAdmissionPolicy &#39;max-replicas-deployments&#39; with binding &#39;max-replicas-deployments&#39; denied request: failed expression: object.spec.replicas &lt;= 3
</span></span></code></pre></div><p>So that&rsquo;s for new admission requests, but what about our existing app we previously deployed? Interestingly, there is nothing telling me that my existing resources are not compliant, I&rsquo;m a bit disappointed here, I used to do <code>kubectl get constraints</code> and see the violations raised by Gatekeeper. I think that&rsquo;s a miss here, let&rsquo;s see if in the future it will be supported. Nonetheless, <code>kubectl rollout restart deployments sample-app -n sample-app</code> or <code>kubectl scale deployment sample-app --replicas 6 -n sample-app</code> for example will fail, like expected.</p><h2 id=pass-parameters-to-the-policy>Pass parameters to the policy
<a href=#pass-parameters-to-the-policy class=h-anchor aria-hidden=true>#</a></h2><p>With the policy we just created we hard-coded the number of replicas we allow, but what if you want to have this more customizable? Here comes a really interesting feature where you can pass parameters!</p><p>The <code>paramKind</code> field allows you to pass an existing CRD that you could <a href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/>create by yourself</a> or you can easily leverage existing ones like <code>ConfigMap</code> or <code>Secrets</code>. Let&rsquo;s update our policy with a <code>ConfigMap</code> to achieve this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: admissionregistration.k8s.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ValidatingAdmissionPolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  failurePolicy: Fail
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  paramKind:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  matchConstraints:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    resourceRules:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - apiGroups:   [&#34;apps&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      apiVersions: [&#34;v1&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      operations:  [&#34;CREATE&#34;, &#34;UPDATE&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      resources:   [&#34;deployments&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  validations:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - expression: &#34;params != null&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    message: &#34;params missing but required to bind to this policy&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - expression: &#34;has(params.data.maxReplicas)&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    message: &#34;params.data.maxReplicas missing but required to bind to this policy&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - expression: &#34;object.spec.replicas &lt;= int(params.data.maxReplicas)&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>kubectl create ns policies-configs
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  namespace: policies-configs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>data:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  maxReplicas: &#34;3&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: admissionregistration.k8s.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ValidatingAdmissionPolicyBinding
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  paramRef:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    namespace: policies-configs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  policyName: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p><em>Note: because <code>ConfigMap</code> has to reside in a namespace, we are also creating a dedicated <code>policies-configs</code> namespace.</em></p><p>Now, let&rsquo;s try to deploy an app with 5 replicas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx --image<span style=color:#f92672>=</span>nginx --replicas <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>We can see that our policy is still enforced with a new message, great!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>error: failed to create deployment: deployments.apps &#34;nginx&#34; is forbidden: ValidatingAdmissionPolicy &#39;max-replicas-deployments&#39; with binding &#39;max-replicas-deployments&#39; denied request: failed expression: object.spec.replicas &lt;= int(params.data.maxReplicas)
</span></span></code></pre></div><h2 id=exclude-namespaces-from-the-policy>Exclude namespaces from the policy
<a href=#exclude-namespaces-from-the-policy class=h-anchor aria-hidden=true>#</a></h2><p>One of the features used with Gatekeeper policies is the ability to <code>excludedNamespaces</code> with a <code>Constraint</code>. Very helpful to avoid breaking clusters with policies on system namespaces.</p><p>Here, we will use a <code>namespaceSelector</code> on our <code>ValidatingAdmissionPolicyBinding</code> to exclude system namespaces as well as our own <code>allow-listed</code> namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: admissionregistration.k8s.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ValidatingAdmissionPolicyBinding
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  paramRef:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    namespace: policies-configs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  policyName: max-replicas-deployments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  matchResources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    namespaceSelector:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      matchExpressions:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - key: kubernetes.io/metadata.name
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        operator: NotIn
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        values:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - kube-node-lease
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - kube-public
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - kube-system
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - allow-listed
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p><em>Note: in order to have this <code>namespaceSelector</code> expression working, we are assuming that we are in a Kubernetes cluster version 1.22+ which <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/#automatic-labelling>automatically adds the <code>kubernetes.io/metadata.name</code> label</a> on any <code>Namespaces</code>. Very convenient for our use case to exclude namespaces from a policy</em></p><p>Now, let&rsquo;s try to deploy an app with 5 replicas in the default namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span>nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --replicas <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>We can see that our policy is still enforced, great!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>error: failed to create deployment: deployments.apps &#34;nginx&#34; is forbidden: ValidatingAdmissionPolicy &#39;max-replicas-deployments&#39; with binding &#39;max-replicas-deployments&#39; denied request: failed expression: object.spec.replicas &lt;= int(params.data.maxReplicas)
</span></span></code></pre></div><p>On the other hand, we should be able to deploy it in the <code>allow-listed</code> namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create ns allow-listed
</span></span><span style=display:flex><span>kubectl create deployment nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span>nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --replicas <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -n allow-listed
</span></span></code></pre></div><p>Sweet!</p><h2 id=limitations-gaps-and-thoughts>Limitations, gaps and thoughts
<a href=#limitations-gaps-and-thoughts class=h-anchor aria-hidden=true>#</a></h2><p>Again, based on my Gatekeeper experience and the quick tests that I have done so far with this Validation Admission Policies feature, here are some limitations, gaps and thoughts that I&rsquo;m seeing:</p><h3 id=failure-policy-ignore>Failure policy <code>Ignore</code>
<a href=#failure-policy-ignore class=h-anchor aria-hidden=true>#</a></h3><p>I don&rsquo;t seem to understand yet what this failure policy <code>Ignore</code> as opposed to <code>Fail</code> does. I get the same behavior with both&mldr;</p><h3 id=just-for-admission>Just for admission
<a href=#just-for-admission class=h-anchor aria-hidden=true>#</a></h3><p>It&rsquo;s just for admission, not for evaluating existing resources already in a cluster.</p><h3 id=client-side-validation>Client-side validation
<a href=#client-side-validation class=h-anchor aria-hidden=true>#</a></h3><p>Not able to evaluate the resources against policies outside of a cluster, like we can do with the <code>gator</code> cli.</p><h3 id=inline-parameters>Inline parameters
<a href=#inline-parameters class=h-anchor aria-hidden=true>#</a></h3><p>Inline parameters in <code>ValidatingAdmissionPolicyBinding</code> would be way more easier, today we need to create our own CRD or have resources like <code>ConfigMap</code>, <code>Secrets</code>, etc. which are scoped in a namespace.</p><h3 id=variabless-values-in-message>Variables&rsquo;s values in message
<a href=#variabless-values-in-message class=h-anchor aria-hidden=true>#</a></h3><p>Evaluate values in <code>validation.message</code> like <code>"object.spec.replicas should be less than {int(params.data.maxReplicas)}"</code></p><h3 id=cluster-wide-exempted-namespaces>Cluster-wide exempted namespaces
<a href=#cluster-wide-exempted-namespaces class=h-anchor aria-hidden=true>#</a></h3><p>Repeating the <code>namespaceSelector</code> expression for all the <code>ValidatingAdmissionPolicyBinding</code> could generate more work and errors, <a href=https://open-policy-agent.github.io/gatekeeper/website/docs/exempt-namespaces/>exempting namespaces cluster-wide</a> would be really great.</p><h3 id=mutating>Mutating
<a href=#mutating class=h-anchor aria-hidden=true>#</a></h3><p>Mutating doesn&rsquo;t exist.</p><h3 id=external-data>External data
<a href=#external-data class=h-anchor aria-hidden=true>#</a></h3><p>Advanced scenario like leveraging <code>cosign</code> with Gatekeeper&rsquo;s External data feature doesn&rsquo;t exist.</p><h3 id=referential-constraints>Referential constraints
<a href=#referential-constraints class=h-anchor aria-hidden=true>#</a></h3><p>Advanced scenario where I want a policy making sure that any <code>Namespace</code> has a <code>NetworkPolicy</code> or an <code>AuthorizationPolicy</code>, based on referential constraints with Gatekeeper could be really helpful. It doesn&rsquo;t seem to be supported today.</p><p>I will test it soon, but I&rsquo;m thinking about passing the associated CRD (<code>NetworkPolicy</code> and <code>Authorization</code>) as <code>paramKind</code> while evaluating <code>Pods</code> creation/update (I thought about <code>Namespace</code> but there is a chicken and eggs problem here). I will report back upading this blog article as soon as I made my tests. Stay tuned!</p><h3 id=workload-resources>Workload resources
<a href=#workload-resources class=h-anchor aria-hidden=true>#</a></h3><p>Policies on <code>Pods</code> are important but could be tricky with the workload resources generating them, think about <code>Deployments</code>, <code>ReplicaSet</code>, <code>Jobs</code>, <code>Daemonsets</code>, etc. I haven&rsquo;t tested it yet, I will report back upading this blog article as soon as I made my tests. Stay tuned!</p><h2 id=conclusion>Conclusion
<a href=#conclusion class=h-anchor aria-hidden=true>#</a></h2><p>We were able to create our own policy, pass a parameter to it and exclude some namespaces. Finally, some limitations and gaps with Gatekeeper policies were discussed.</p><p>This feature in alpha since Kubernetes 1.26 is really promising, very easy to leverage and already powerful. I really like the fact that it&rsquo;s also out of the box in Kubernetes and that it&rsquo;s a very light footprint in my cluster as opposed to have others CRDs/containers in my cluster like we have with Gatekeeper or Kyverno.</p><p>I think this image below taken from <a href=https://sched.co/182Q6>Joe Betz&rsquo;s session at KubeCon NA 2022</a> is a good summary about the positioning of this feature versus the advanced scenarios covered by webhooks:</p><p><img src=https://github.com/mathieu-benoit/my-images/raw/main/validatingadmissionpolicies-versus-webhooks.png alt="ValidatingAdmissionPolicies versus Webhooks"></p><p>I&rsquo;m really looking forward to seeing the next iterations on this feature as it will reach <code>beta</code> and then <code>stable</code> states in the future. I&rsquo;m also curious to learn more about when to use it and maybe still using Gatekeeper if I need more advanced scenarios like illustrated in the previous <a href=#limitations-gaps-and-thoughts>Limitations, gaps and thoughts section</a>. Finally, I&rsquo;m curious also to learn more about how Gatekeeper, <a href=https://github.com/kyverno/kyverno/issues/5441>Kyverno</a>, Styra, etc. will position their projects and products based on this feature upstream in Kubernetes.</p><p>Happy sailing, cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2023/02/2022-review/><span class=button__icon>←</span>
<span class=button__text>2022 in review, first year in devrel</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2022/12/onlineboutique-with-memorystore/><span class=button__text>use google cloud memorystore (redis) with the online boutique sample</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>