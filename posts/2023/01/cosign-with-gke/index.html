<!doctype html><html lang=en><head><title>sigstore's cosign and policy-controller with gke and kms ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Update on Jan 24th, 2023: this blog article is now on Medium.
At KubeCon, GitOpsCon, SigstoreCon and SecurityCon NA 2022, Secure Software Supply Chain (S3C) demonstrated that it is not anymore just a trend or a buzz. It&amp;rsquo;s getting more and more serious, we are seeing a lot of simplification about how to set up and leverage such technologies.
Don&amp;rsquo;t trust registries.
Sign everything: git commit, npm/rust/java/python packages, container image, Helm chart, Kubernetes manifests, etc."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2023/01/cosign-with-gke/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="sigstore's cosign and policy-controller with gke and kms"><meta name=twitter:description content="let's see how we could sign our own private container images with sigstore's cosign and then how to only allow them to be deployed in our gke cluster thanks to sigstore's policy-controller"><meta property="og:title" content="sigstore's cosign and policy-controller with gke and kms"><meta property="og:description" content="let's see how we could sign our own private container images with sigstore's cosign and then how to only allow them to be deployed in our gke cluster thanks to sigstore's policy-controller"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2023/01/cosign-with-gke/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-23T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>sigstore&rsquo;s cosign and policy-controller with gke and kms</h1><div class=post-meta><span class=post-date>2023-01-23</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;</span><div class=post-content><p><em>Update on Jan 24th, 2023: this blog article is now on <a href=https://medium.com/google-cloud/7bd5b12672ea>Medium</a>.</em></p><p>At <a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2O5aNpRM71NQyx3WUe1xpTn">KubeCon</a>, <a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2PVniTC7pKpHx1KsYjsOJnJ">GitOpsCon</a>, <a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2MUNId2hvHBnrGCCbmou_gl">SigstoreCon</a> and <a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2Mwt-aVXI6ItZX5s9izAp0F">SecurityCon</a> NA 2022, Secure Software Supply Chain (S3C) demonstrated that it is not anymore just a trend or a buzz. It&rsquo;s getting more and more serious, we are seeing a lot of simplification about how to set up and leverage such technologies.</p><blockquote><p>Don&rsquo;t trust registries.</p></blockquote><blockquote><p>Sign everything: git commit, npm/rust/java/python packages, container image, Helm chart, Kubernetes manifests, etc.</p></blockquote><blockquote><p>Nearly every site runs HTTPS and is, by definition, more secure. This is the model that Sigstore wants to follow.</p></blockquote><p>When I came back from KubeCon NA 2022, I added at the top of my TODO list to <em>&ldquo;play and learn more about <a href=https://docs.sigstore.dev/cosign/overview/#kubernetes-integrations>Sigstore&rsquo;s <code>cosign</code> in Kubernetes clusters</a>&rdquo;</em>. So here I am, like usual, sharing my step by step guide about how to accomplish this while sharing my thoughts and learnings. Hope you&rsquo;ll like it and that you will learn something!</p><p><em>Note: while learning and testing, it was also the opportunity for me to open my first PRs in the <code>sigstore/docs</code> (<a href=https://github.com/sigstore/docs/pull/63>#63</a>), <code>sigstore/policy-controller</code> (<a href=https://github.com/sigstore/policy-controller/pull/520>520</a>), and <code>sigstore/community</code> (<a href=https://github.com/sigstore/community/issues/220>#220</a>) repos to fix some frictions I faced.</em></p><p>This blog article will walk you through two main concepts:</p><ul><li><a href=#sign-a-container-image-with-cloud-kms-and-cosign>Sign a container image with Sigstore&rsquo;s <code>cosign</code> and Cloud KMS</a></li><li><a href=#enforce-that-only-signed-container-images-are-allowed-in-a-gke-cluster-with-sigstores-policy-controller>Enforce that only signed container images are allowed in a GKE cluster with Sigstore&rsquo;s <code>policy-controller</code></a></li></ul><p><img src=https://github.com/mathieu-benoit/my-images/raw/main/cosign-with-gke.png alt="cosign with GKE and KMS flow"></p><p>Define the common bash variables used throughout this blog article:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PROJECT_ID<span style=color:#f92672>=</span>FIXME-WITH-YOUR-EXISTING-PROJECT-ID
</span></span><span style=display:flex><span>gcloud config set project <span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>REGION<span style=color:#f92672>=</span>northamerica-northeast1
</span></span></code></pre></div><h2 id=sign-a-container-image-with-cloud-kms-and-cosign>Sign a container image with Cloud KMS and <code>cosign</code>
<a href=#sign-a-container-image-with-cloud-kms-and-cosign class=h-anchor aria-hidden=true>#</a></h2><p>In this section you will:</p><ul><li>Create a key in KMS</li><li>Create a Google Artifact Registry repository to store container images</li><li>Push a simple <code>nginx</code> container image in this repository</li><li>Install <a href=https://docs.sigstore.dev/cosign/overview/>Sigstore&rsquo;s <code>cosign</code></a> locally</li><li>Sign this remote private container image</li></ul><p>Enable the KMS API in our current project:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud services enable cloudkms.googleapis.com
</span></span></code></pre></div><p>Create a key in KMS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>KEY_RING<span style=color:#f92672>=</span>cosign
</span></span><span style=display:flex><span>gcloud kms keyrings create <span style=color:#e6db74>${</span>KEY_RING<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --location <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>KEY_NAME<span style=color:#f92672>=</span>cosign
</span></span><span style=display:flex><span>gcloud kms keys create <span style=color:#e6db74>${</span>KEY_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --keyring <span style=color:#e6db74>${</span>KEY_RING<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --location <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --purpose asymmetric-signing <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --default-algorithm ec-sign-p256-sha256
</span></span></code></pre></div><p>Enable the Artifact Registry API in our current project:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud services enable artifactregistry.googleapis.com
</span></span></code></pre></div><p>Create a private Google Artifact Registry repository to store our container images:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>REGISTRY_NAME<span style=color:#f92672>=</span>containers
</span></span><span style=display:flex><span>gcloud artifacts repositories create <span style=color:#e6db74>${</span>REGISTRY_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --repository-format docker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --location <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>Push an <code>nginx</code> image in our own private Google Artifact Registry repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker pull nginx
</span></span><span style=display:flex><span>docker tag nginx <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>-docker.pkg.dev/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>REGISTRY_NAME<span style=color:#e6db74>}</span>/nginx
</span></span><span style=display:flex><span>gcloud auth configure-docker <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>-docker.pkg.dev
</span></span><span style=display:flex><span>SHA<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>docker push <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>-docker.pkg.dev/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>REGISTRY_NAME<span style=color:#e6db74>}</span>/nginx | grep digest: | cut -f3 -d<span style=color:#e6db74>&#34; &#34;</span><span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p><em>Note: we are grabbing the <code>SHA</code> of this remote container image in order to sign this container image later.</em></p><p>Install Sigstore&rsquo;s <a href=https://docs.sigstore.dev/cosign/installation/><code>cosign</code></a> locally:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>COSIGN_VERSION<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s https://api.github.com/repos/sigstore/cosign/releases/latest | jq -r .tag_name<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>curl -LO https://github.com/sigstore/cosign/releases/download/<span style=color:#e6db74>${</span>COSIGN_VERSION<span style=color:#e6db74>}</span>/cosign-linux-amd64
</span></span><span style=display:flex><span>sudo mv cosign-linux-amd64 /usr/local/bin/cosign
</span></span><span style=display:flex><span>chmod +x /usr/local/bin/cosign
</span></span></code></pre></div><p><a href=https://docs.sigstore.dev/cosign/key-generation/#key-generation-and-management>Generage a key</a> and <a href=https://docs.sigstore.dev/cosign/sign/>sign</a> this remote container image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud auth application-default login
</span></span><span style=display:flex><span>cosign generate-key-pair <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --kms gcpkms://projects/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/locations/<span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>/keyRings/<span style=color:#e6db74>${</span>KEY_RING<span style=color:#e6db74>}</span>/cryptoKeys/<span style=color:#e6db74>${</span>KEY_NAME<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>cosign sign <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --key gcpkms://projects/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/locations/<span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>/keyRings/<span style=color:#e6db74>${</span>KEY_RING<span style=color:#e6db74>}</span>/cryptoKeys/<span style=color:#e6db74>${</span>KEY_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>-docker.pkg.dev/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>REGISTRY_NAME<span style=color:#e6db74>}</span>/nginx@<span style=color:#e6db74>${</span>SHA<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>We could now see that our Google Artifact Registry repository has two entries, one for the actual container image and the other for the associate <code>.sig</code> signature:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud artifacts docker tags list <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>-docker.pkg.dev/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>REGISTRY_NAME<span style=color:#e6db74>}</span>/nginx
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Listing items under project mabenoit-gatekeeper-oci, location us-east4, repository containers.
</span></span><span style=display:flex><span>TAG                                                                          IMAGE                                                             DIGEST
</span></span><span style=display:flex><span>latest                                                                       us-east4-docker.pkg.dev/mabenoit-gatekeeper-oci/containers/nginx  sha256:4c1c50d0ffc614f90b93b07d778028dc765548e823f676fb027f61d281ac380d
</span></span><span style=display:flex><span>sha256-4c1c50d0ffc614f90b93b07d778028dc765548e823f676fb027f61d281ac380d.sig  us-east4-docker.pkg.dev/mabenoit-gatekeeper-oci/containers/nginx  sha256:f02d7fef0df5c264e34b995a4861590bbdd7001631f6e5f23250f34202359a56
</span></span></code></pre></div><p><em>Note: there is an <a href=https://github.com/sigstore/cosign/issues/1397>ongoing discussion</a> to support the <a href=https://oras.land/cli/6_reference_types/>reference types from the OCI spec</a> in order to just have the container image where the signature could be attached on.</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cosign verify <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --key gcpkms://projects/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/locations/<span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>/keyRings/<span style=color:#e6db74>${</span>KEY_RING<span style=color:#e6db74>}</span>/cryptoKeys/<span style=color:#e6db74>${</span>KEY_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>-docker.pkg.dev/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>REGISTRY_NAME<span style=color:#e6db74>}</span>/nginx@<span style=color:#e6db74>${</span>SHA<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Verification for us-east4-docker.pkg.dev/mabenoit-gatekeeper-oci/containers/nginx@sha256:4c1c50d0ffc614f90b93b07d778028dc765548e823f676fb027f61d281ac380d --
</span></span><span style=display:flex><span>The following checks were performed on each of these signatures:
</span></span><span style=display:flex><span>  - The cosign claims were validated
</span></span><span style=display:flex><span>  - The signatures were verified against the specified public key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[{&#34;critical&#34;:{&#34;identity&#34;:{&#34;docker-reference&#34;:&#34;us-east4-docker.pkg.dev/mabenoit-gatekeeper-oci/containers/nginx&#34;},&#34;image&#34;:{&#34;docker-manifest-digest&#34;:&#34;sha256:4c1c50d0ffc614f90b93b07d778028dc765548e823f676fb027f61d281ac380d&#34;},&#34;type&#34;:&#34;cosign container image signature&#34;},&#34;optional&#34;:null}]
</span></span></code></pre></div><h2 id=enforce-that-only-signed-container-images-are-allowed-in-a-gke-cluster-with-sigstores-policy-controller>Enforce that only signed container images are allowed in a GKE cluster with Sigstore&rsquo;s <code>policy-controller</code>
<a href=#enforce-that-only-signed-container-images-are-allowed-in-a-gke-cluster-with-sigstores-policy-controller class=h-anchor aria-hidden=true>#</a></h2><p>In this section you will:</p><ul><li>Create a dedicated least privilege Google Service Account for the GKE&rsquo;s nodes</li><li>Create a GKE cluster</li><li>Install <a href=https://docs.sigstore.dev/policy-controller/overview/>Sigstore&rsquo;s <code>policy-controller</code></a> in this GKE cluster</li><li>Deploy a policy to only allow signed container images</li><li>Test this policy with both signed and unsigned container images</li></ul><p>Define a least privilege Google Service Account (GSA) the GKE&rsquo;s nodes (<a href=https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster#use_least_privilege_sa>instead of using the default Compute Engine Service Account</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>CLUSTER_NAME<span style=color:#f92672>=</span>cosign-test-cluster
</span></span><span style=display:flex><span>GSA_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-sa
</span></span><span style=display:flex><span>GSA_ID<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>GSA_NAME<span style=color:#e6db74>}</span>@<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>gcloud iam service-accounts create <span style=color:#e6db74>${</span>GSA_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --display-name <span style=color:#e6db74>${</span>GSA_NAME<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>roles<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;roles/logging.logWriter roles/monitoring.metricWriter roles/monitoring.viewer roles/cloudkms.viewer roles/cloudkms.verifier&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> role in $roles; <span style=color:#66d9ef>do</span> gcloud projects add-iam-policy-binding <span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span> --member <span style=color:#e6db74>&#34;serviceAccount:</span><span style=color:#e6db74>${</span>GSA_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> --role $role; <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>gcloud artifacts repositories add-iam-policy-binding <span style=color:#e6db74>${</span>REGISTRY_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --location <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --member <span style=color:#e6db74>&#34;serviceAccount:</span><span style=color:#e6db74>${</span>GSA_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --role roles/artifactregistry.reader
</span></span></code></pre></div><p><em>Note: in addition to the roles for monitoring, we are also granting both <code>cloudkms.viewer</code> and <code>cloudkms.verifier</code> needed by Sigstore&rsquo;s <code>policy-controller</code>.</em></p><p>Enable the GKE API in our current project:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud services enable container.googleapis.com
</span></span></code></pre></div><p>Create a GKE cluster with this dedicated GSA:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud container clusters create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --service-account <span style=color:#e6db74>${</span>GSA_ID<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --region <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --scopes <span style=color:#e6db74>&#34;gke-default,https://www.googleapis.com/auth/cloudkms&#34;</span>
</span></span></code></pre></div><p><em>Note: we explicitly add the <code>https://www.googleapis.com/auth/cloudkms</code> scope needed by Sistore&rsquo;s <code>policy-controller</code>. <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/access-scopes><code>https://www.googleapis.com/auth/cloud-platform</code></a> instead is fine too.</em></p><p>Install the <a href=https://github.com/sigstore/helm-charts/tree/main/charts/policy-controller>Sigstore&rsquo;s <code>policy-controller</code> Helm chart</a> in this GKE cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add sigstore https://sigstore.github.io/helm-charts
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm install policy-controller <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -n cosign-system sigstore/policy-controller <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --create-namespace
</span></span></code></pre></div><p>Deploy a policy only allowing signed container images from our private Google Artifact Registry repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: policy.sigstore.dev/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ClusterImagePolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: private-signed-images-cip
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  images:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - glob: &#34;**&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  authorities:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - key:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        kms: gcpkms://projects/${PROJECT_ID}/locations/${REGION}/keyRings/${KEY_RING}/cryptoKeys/${KEY_NAME}/cryptoKeyVersions/1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Enfore this policy for the <code>test</code> namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace test
</span></span><span style=display:flex><span>kubectl label namespace test policy.sigstore.dev/include<span style=color:#f92672>=</span>true
</span></span></code></pre></div><p><em>Note: you need to apply this label on the namespaces you want this policy to be enforced in.</em></p><p>Test with an unsigned container image and see that it&rsquo;s blocked:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span>nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -n test
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>error: failed to create deployment: admission webhook &#34;policy.sigstore.dev&#34; denied the request: validation failed: failed policy: private-signed-images-cip: spec.template.spec.containers[0].image
</span></span><span style=display:flex><span>index.docker.io/library/nginx@sha256:b8f2383a95879e1ae064940d9a200f67a6c79e710ed82ac42263397367e7cc4e signature key validation failed for authority authority-0 for index.docker.io/library/nginx@sha256:b8f2383a95879e1ae064940d9a200f67a6c79e710ed82ac42263397367e7cc4e: no matching signatures:
</span></span></code></pre></div><p>Test with our signed container image and see that it&rsquo;s allowed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span>-docker.pkg.dev/<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>REGISTRY_NAME<span style=color:#e6db74>}</span>/nginx@<span style=color:#e6db74>${</span>SHA<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -n test
</span></span></code></pre></div><p>Output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>deployment.apps/nginx created
</span></span></code></pre></div><p>That&rsquo;s it, congrats! We just enforced our GKE cluster to only allow our private and signed container images on specific namespaces! Wow!</p><h2 id=resources>Resources
<a href=#resources class=h-anchor aria-hidden=true>#</a></h2><ul><li><a href=https://youtu.be/_HL_I5k_oP4>Sigstore: Using Transparent Digital Signatures to Help Secure the Software SupplyChain- Bob Callaway</a></li><li><a href=https://docs.sigstore.dev/policy-controller/overview/>Sigstore&rsquo;s <code>policy-controller</code></a></li><li><a href="https://youtu.be/mduvP92bhPs?list=PLj6h78yzYM2MUNId2hvHBnrGCCbmou_gl">Sigstore Or: How We Learned to Stop Trusting Registries and Love Signatures - Wojciech Kocjan & Tyson Kamp, InfluxData</a></li><li><a href=https://blog.sigstore.dev/how-to-verify-container-images-with-kyverno-using-kms-cosign-and-workload-identity-1e07d2b85061>How to verify container images with Kyverno using KMS, Cosign, and Workload Identity</a></li></ul><p>Hope you enjoyed that one! Happy signing, happy sailing!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2023/02/2022-review/><span class=button__icon>←</span>
<span class=button__text>2022 in review, first year in devrel</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2023/01/validating-admission-policies/><span class=button__text>validating admission policies, the future of kubernetes policies</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>