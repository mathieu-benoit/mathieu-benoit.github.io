<!doctype html><html lang=en><head><title>sail sharp, 8 tips to optimize and secure your .net containers for kubernetes ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In February 2021, I got this opportunity to deliver this talk Sail Sharp, .NET Core &amp;amp; Kubernetes for the .NET Meetup in Quebec city (it was in French). I illustrated the best practices to prepare any .NET applications for Kubernetes. I was using the cartservice app (in dotnet) from the very popular Online Boutique sample apps.
Since then, I have been one of the top contributors to the Online Boutique repository."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2023/03/sail-sharp/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="sail sharp, 8 tips to optimize and secure your .net containers for kubernetes"><meta name=twitter:description content="let’s go through 8 tips to optimize and secure your .net containers for kubernetes, based on my contributions to the online boutique sample apps"><meta property="og:title" content="sail sharp, 8 tips to optimize and secure your .net containers for kubernetes"><meta property="og:description" content="let’s go through 8 tips to optimize and secure your .net containers for kubernetes, based on my contributions to the online boutique sample apps"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2023/03/sail-sharp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-31T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-31T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>sail sharp, 8 tips to optimize and secure your .net containers for kubernetes</h1><div class=post-meta><span class=post-date>2023-03-31</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/dotnet/>#dotnet</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;</span><div class=post-content><p><img src=https://github.com/mathieu-benoit/my-images/raw/main/sail-sharp.png alt="Sail Sharp: .NET on Kubernetes"></p><p>In February 2021, I got this opportunity to deliver this talk <a href="https://www.youtube.com/watch?v=FqwjSZqpJs8">Sail Sharp, .NET Core & Kubernetes</a> for the .NET Meetup in Quebec city (it was in French). I illustrated the best practices to prepare any .NET applications for Kubernetes. I was using the <code>cartservice</code> app (in <code>dotnet</code>) from the very popular <a href=https://github.com/GoogleCloudPlatform/microservices-demo>Online Boutique sample apps</a>.</p><p>Since then, I have been <a href="https://github.com/GoogleCloudPlatform/microservices-demo/pulls?q=is%3Apr+author%3Amathieu-benoit+is%3Aclosed">one of the top contributors to the Online Boutique repository</a>. I contributed to the <code>golang</code>, <code>python</code>, <code>dotnet</code>, <code>java</code> and <code>nodejs</code> apps. I learned a lot. Some of my contributions, among others, were about optimizing and securing the container images for all these apps.</p><p>Here is the high-level timeline of my contributions related to the <a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/cartservice><code>cartservice</code> app</a>:</p><ul><li>2020-11 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/435>.NET 2 &ndash;> .NET 3</a> &ndash;> <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/445>.NET 5</a></li><li>2020-12 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/454>Managed gRPC</a></li><li>2021-01 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/505>Memorystore Redis</a> (doc)</li><li>2021-11 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/629>.NET 6</a></li><li>2022-03 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/778><code>NetworkPolicies</code></a></li><li>2022-05 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/838>Better <code>IDistributedCache</code> implementation</a></li><li>2022-06 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/848>Unprivilege container</a></li><li>2022-09 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/1008>.NET 7</a></li><li>2022-09 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/1102>Native gRPC Healthcheck for <code>livenessProbe</code> and <code>readinessProbe</code></a></li><li>2022-09 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/1109>Spanner as database option</a> (reviewer and contributor)</li><li>2022-12 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/1340>IPv6</a></li><li>2022-12 - <a href=https://github.com/GoogleCloudPlatform/microservices-demo/pull/1353>Helm chart with the addition of the <code>AuthorizationPolicies</code></a></li></ul><p><em>As a side note, I started my journey with the <a href=https://en.wikipedia.org/wiki/.NET_Framework_version_history#.NET_Framework_3.0>.NET Framework version 3.0</a> (only on Windows at that time) back in 2006! Since then, I have been amazed about the evolution of the <a href=https://dotnetfoundation.org/>.NET ecosystem</a>. And to be honest all these contributions gave me a reason to stay up-to-date and have a lot of fun while learning more about containers and Kubernetes! :)</em></p><p>Wow! Quite a ride, isn’t it?</p><p>Today, in this blog post, I will highlight 8 tips to optimize and secure your .NET containers based on what I have learned based on all of that:</p><ol><li><a href=#multi-stage-build>Multi-stage build</a></li><li><a href=#optimized-bundled-application>Optimized bundled application</a></li><li><a href=#small-base-image>Small base image</a></li><li><a href=#immutable-base-image>Immutable base image</a></li><li><a href=#update-dependencies>Update dependencies</a></li><li><a href=#dockerignore><code>.dockerignore</code></a></li><li><a href=#unprivilegenon-root-container>Unprivilege/non-root container</a></li><li><a href=#read-only-container-filesystem>Read-only container filesystem</a></li></ol><p>If you want to see the final <code>Dockerfile</code> and the <code>Deployment</code> manifest to deploy a secure and optimized .NET application in Kubernetes, feel free to directly jump to the end of this blog post.</p><p><em>Disclaimer: Whereas some of the concepts could be applicable to Windows containers, this blog post is only covering Linux containers. Furthermore, I’m not taking into account the <a href=https://devblogs.microsoft.com/dotnet/improving-multiplatform-container-support/>multi-platform container support</a>, I’m just supporting <code>amd64</code> and not <code>arm64</code> as an example.</em></p><p>Create a folder where we will drop all the files needed for this blog post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir my-sample-app
</span></span></code></pre></div><p>Create a minimal and simple ASP.NET app we will use for this blog post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; my-sample-app/Program.cs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>using Microsoft.AspNetCore.Builder;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>var builder = WebApplication.CreateBuilder(args);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>var app = builder.Build();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>app.MapGet(&#34;/&#34;, () =&gt; &#34;Hello, World!&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>app.Run();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; my-sample-app/my-sample-app.csproj
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;Project Sdk=&#34;Microsoft.NET.Sdk.Web&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;PropertyGroup&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;TargetFramework&gt;net7.0&lt;/TargetFramework&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;/PropertyGroup&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/Project&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h2 id=1-multi-stage-build>1. Multi-stage build
<a href=#1-multi-stage-build class=h-anchor aria-hidden=true>#</a></h2><p>Create our first <code>Dockerfile</code> with a multi-stage build. That’s not the final one, until then, please bear with me:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; my-sample-app/Dockerfile
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM mcr.microsoft.com/dotnet/sdk:7.0 as builder
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WORKDIR /app
</span></span></span><span style=display:flex><span><span style=color:#e6db74>COPY my-sample-app.csproj .
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RUN dotnet restore my-sample-app.csproj -r linux-x64
</span></span></span><span style=display:flex><span><span style=color:#e6db74>COPY . .
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RUN dotnet publish my-sample-app.csproj -r linux-x64 -c release -o /my-sample-app --no-restore
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM mcr.microsoft.com/dotnet/runtime:7.0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WORKDIR /app
</span></span></span><span style=display:flex><span><span style=color:#e6db74>COPY --from=builder /my-sample-app .
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ENTRYPOINT [&#34;/app/my-sample-app&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p><a href=https://docs.docker.com/build/building/multi-stage/>This <code>Dockerfile</code> uses multi-stage build</a>, which optimizes the final size of the image by layering the build and leaving only required artifacts.</p><p>Let’s build this container image locally:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t my-sample-app my-sample-app/
</span></span></code></pre></div><p>We can see that the size of the container image is <strong>288MB</strong> on disk locally.</p><p>You can locally run the container and test that it is working successfully:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d -p 80:80 my-sample-app
</span></span><span style=display:flex><span>curl localhost:80
</span></span></code></pre></div><h2 id=2-optimized-bundled-application>2. Optimized bundled application
<a href=#2-optimized-bundled-application class=h-anchor aria-hidden=true>#</a></h2><p>When using <code>dotnet publish</code>, we can use different features to optimize the size of the bundled application:</p><ul><li><a href=https://learn.microsoft.com/en-us/dotnet/core/deploying/runtime-patch-selection>Self-contained deployment</a><ul><li>Update the <code>Dockerfile</code> with <code>dotnet publish --self-contained true</code>.</li><li>Update the <code>Dockerfile</code> with <code>dotnet/runtime-deps:7.0</code> as the final base image.</li><li>We can see that the size of the container image is now <strong>215MB</strong> on disk locally.</li><li><a href=https://andrewlock.net/should-i-use-self-contained-or-framework-dependent-publishing-in-docker-images/>Should you use self-contained or framework-dependent publishing in Docker images?</a></li></ul></li><li><a href=https://learn.microsoft.com/en-us/dotnet/core/deploying/single-file/overview>Single-file deployment</a><ul><li>Update the <code>Dockerfile</code> with <code>dotnet publish -p:PublishSingleFile=true</code>.</li><li>We can see that the size of the container image is now <strong>207MB</strong> on disk locally.</li></ul></li><li><a href=https://learn.microsoft.com/en-us/dotnet/core/deploying/trimming/trim-self-contained>Trim self-contained deployments and executables</a><ul><li>Update the <code>Dockerfile</code> with <code>dotnet publish -p:PublishTrimmed=True -p:TrimMode=partial</code>.</li><li>We can see that the size of the container image is now <strong>148MB</strong> on disk locally.</li><li>If your application works with <code>-p:TrimMode=full</code> that’s even better. See note below.</li></ul></li></ul><p>With <code>-p:TrimMode=full</code>, the size of the container image is now <strong>136MB</strong> on disk locally, but the container is then not working in my case because of this warning when doing <code>dotnet publish</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>warning IL2026: Using member &#39;Microsoft.AspNetCore.Builder.EndpointRouteBuilderExtensions.MapGet(IEndpointRouteBuilder, String, Delegate)&#39; which has &#39;RequiresUnreferencedCodeAttribute&#39; can break functionality when trimming application code. This API may perform reflection on the supplied delegate and its parameters. These types may be trimmed if not directly referenced.
</span></span></code></pre></div><h2 id=3-small-base-image>3. Small base image
<a href=#3-small-base-image class=h-anchor aria-hidden=true>#</a></h2><p>To reduce the surface of attack or to avoid dealing with security vulnerabilities debt, using the smallest base image is a must.</p><p>You can find all the dotnet container images available here:</p><ul><li><a href=https://mcr.microsoft.com/v2/dotnet/sdk/tags/list><code>dotnet/sdk</code></a></li><li><a href=https://mcr.microsoft.com/v2/dotnet/runtime-deps/tags/list><code>dotnet/runtime-deps</code></a></li></ul><p>In my case, I choose to use the <code>alpine</code> one: <code>dotnet/runtime-deps:7.0-alpine3.17</code>. For that, we need to update the <code>Dockerfile</code> with <code>-r linux-musl-x64</code> for both commands: <code>dotnet restore</code> and <code>dotnet publish</code>.</p><p>We can see that the size of the container image is now <strong>43.2MB</strong> on disk locally. Impressive! Isn’t it?</p><p><em>Note: if this app was compatible with <code>-p:TrimMode=full</code>, the size of the container image would have been now <strong>31.5MB</strong> on disk locally.</em></p><p>Below is the illustration of the sizes of the different base images:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>SIZE
</span></span><span style=display:flex><span>REPOSITORY                              TAG                                     SIZE
</span></span><span style=display:flex><span>mcr.microsoft.com/dotnet/sdk            7.0.202                                 775MB
</span></span><span style=display:flex><span>mcr.microsoft.com/dotnet/runtime-deps   7.0.4                                   117MB
</span></span><span style=display:flex><span>mcr.microsoft.com/dotnet/runtime-deps   7.0.4-cbl-mariner2.0-distroless         26.4MB
</span></span><span style=display:flex><span>mcr.microsoft.com/dotnet/runtime-deps   7.0.4-alpine3.17                        12.1MB
</span></span><span style=display:flex><span>mcr.microsoft.com/dotnet/runtime-deps   8.0.0-preview.2-jammy-chiseled          13MB
</span></span></code></pre></div><p>Here, like you can see, I decided to take the smallest container image <code>dotnet/runtime-deps:7.0.4-alpine3.17</code>: <strong>12.1MB</strong>.</p><p>But what about <code>dotnet/runtime-deps:7.0.4-cbl-mariner2.0-distroless</code> (<strong>26.4MB</strong>) and <code>dotnet/runtime-deps:8.0.0-preview.2-jammy-chiseled</code> (<strong>13MB</strong>)?</p><p>Good question, glad you asked!</p><p>They are very attractive because they are bringing the concept of <code>distroless</code>. They are container images that do not contain the complete or full-blown OS with system utilities installed. You can read more about CBL-Mariner 2.0 <a href=https://microsoft.github.io/CBL-Mariner/announcing-mariner-2.0/>here</a>, and more about Chiseled Ubuntu Containers <a href=https://devblogs.microsoft.com/dotnet/dotnet-6-is-now-in-ubuntu-2204/#chiseled-ubuntu-containers>here</a>. Both are not yet ready for production.</p><p><em>Note: Chainguard is also working on having their <a href=https://github.com/chainguard-images/images/issues/223>own <code>distroless</code> images for <code>dotnet</code></a>. Something to keep in mind too!</em></p><p>This blog post <a href=https://www.chainguard.dev/unchained/image-sizes-miss-the-point>Image sizes miss the point</a> explains really well why the <code>distroless</code> ones are very attractive:</p><blockquote><p>To reduce debt, reduce image complexity not size.</p></blockquote><p>By using a tool like <a href=https://github.com/anchore/syft><code>syft</code></a>, we could see that the <code>distroless</code> ones are less complex than the <code>alpine</code> one, with less dependencies, reducing the debt and surface of risks. See results below.</p><p>For <code>mcr.microsoft.com/dotnet/runtime-deps:7.0.4-cbl-mariner2.0-distroless</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>[13 packages]
</span></span><span style=display:flex><span>NAME                         VERSION               TYPE 
</span></span><span style=display:flex><span>distroless-packages-minimal  0.1-3.cm2             rpm   
</span></span><span style=display:flex><span>e2fsprogs-libs               1.46.5-3.cm2          rpm   
</span></span><span style=display:flex><span>filesystem                   1.1-12.cm2            rpm   
</span></span><span style=display:flex><span>glibc                        2.35-3.cm2            rpm   
</span></span><span style=display:flex><span>krb5                         1.19.4-1.cm2          rpm   
</span></span><span style=display:flex><span>libgcc                       11.2.0-4.cm2          rpm   
</span></span><span style=display:flex><span>libstdc++                    11.2.0-4.cm2          rpm   
</span></span><span style=display:flex><span>mariner-release              2.0-36.cm2            rpm   
</span></span><span style=display:flex><span>openssl                      1.1.1k-21.cm2         rpm   
</span></span><span style=display:flex><span>openssl-libs                 1.1.1k-21.cm2         rpm   
</span></span><span style=display:flex><span>prebuilt-ca-certificates     2547388:2.0.0-10.cm2  rpm   
</span></span><span style=display:flex><span>tzdata                       2022g-1.cm2           rpm   
</span></span><span style=display:flex><span>zlib                         1.2.12-2.cm2          rpm
</span></span></code></pre></div><p>For <code>mcr.microsoft.com/dotnet/runtime-deps:7.0.4-alpine3.17</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>[25 packages]
</span></span><span style=display:flex><span>NAME                    VERSION                TYPE   
</span></span><span style=display:flex><span>alpine-baselayout       3.4.0-r0               apk     
</span></span><span style=display:flex><span>alpine-baselayout-data  3.4.0-r0               apk     
</span></span><span style=display:flex><span>alpine-keys             2.4-r1                 apk     
</span></span><span style=display:flex><span>apk-tools               2.12.10-r1             apk     
</span></span><span style=display:flex><span>busybox                 1.35.0                 binary  
</span></span><span style=display:flex><span>busybox                 1.35.0-r29             apk     
</span></span><span style=display:flex><span>busybox-binsh           1.35.0-r29             apk     
</span></span><span style=display:flex><span>ca-certificates         20220614-r4            apk     
</span></span><span style=display:flex><span>ca-certificates-bundle  20220614-r4            apk     
</span></span><span style=display:flex><span>keyutils-libs           1.6.3-r1               apk     
</span></span><span style=display:flex><span>krb5-conf               1.0-r2                 apk     
</span></span><span style=display:flex><span>krb5-libs               1.20.1-r0              apk     
</span></span><span style=display:flex><span>libc-utils              0.7.2-r3               apk     
</span></span><span style=display:flex><span>libcom_err              1.46.6-r0              apk     
</span></span><span style=display:flex><span>libcrypto3              3.0.8-r3               apk     
</span></span><span style=display:flex><span>libgcc                  12.2.1_git20220924-r4  apk     
</span></span><span style=display:flex><span>libintl                 0.21.1-r1              apk     
</span></span><span style=display:flex><span>libssl3                 3.0.8-r3               apk     
</span></span><span style=display:flex><span>libstdc++               12.2.1_git20220924-r4  apk     
</span></span><span style=display:flex><span>libverto                0.3.2-r1               apk     
</span></span><span style=display:flex><span>musl                    1.2.3-r4               apk     
</span></span><span style=display:flex><span>musl-utils              1.2.3-r4               apk     
</span></span><span style=display:flex><span>scanelf                 1.3.5-r1               apk     
</span></span><span style=display:flex><span>ssl_client              1.35.0-r29             apk     
</span></span><span style=display:flex><span>zlib                    1.2.13-r0              apk
</span></span></code></pre></div><p><em>Note: very important note that this container image contains <code>busybox</code> with <code>wget</code> included, which could help someone who made it into the running container to download malicious files, etc.</em></p><p>For <code>mcr.microsoft.com/dotnet/runtime-deps:8.0.0-preview.2-jammy-chiseled-amd64</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>[0 packages]
</span></span><span style=display:flex><span>No packages discovered
</span></span></code></pre></div><p>Furthermore, and for your information, I gave <a href=https://trivy.dev/><code>trivy</code></a> a try for these three container images, here is the summary of the scans:</p><ul><li>For <code>mcr.microsoft.com/dotnet/runtime-deps:7.0.4-alpine3.17</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Total: 0 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 0, CRITICAL: 0)
</span></span></code></pre></div><ul><li>For <code>mcr.microsoft.com/dotnet/runtime-deps:7.0.4-cbl-mariner2.0-distroless</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Total: 6 (UNKNOWN: 0, LOW: 0, MEDIUM: 1, HIGH: 4, CRITICAL: 1)
</span></span></code></pre></div><ul><li>For <code>mcr.microsoft.com/dotnet/runtime-deps:8.0.0-preview.2-jammy-chiseled-amd64</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Total: 0 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 0, CRITICAL: 0)
</span></span></code></pre></div><p>With all of that being said, I will still continue to use the <code>mcr.microsoft.com/dotnet/runtime-deps:7.0.4-alpine3.17</code> one. I will keep an eye on <code>mcr.microsoft.com/dotnet/runtime-deps:8.0.0-preview.2-jammy-chiseled-amd64</code>, that’s for sure, it seems to be very promising!</p><h2 id=4-immutable-base-image>4. Immutable base image
<a href=#4-immutable-base-image class=h-anchor aria-hidden=true>#</a></h2><p>Use a specific tag or version for your base image, not <code>latest</code> is important for traceability. But a tag or version is mutable, which means that you can’t guarantee which content of the container you are using. Using a <a href=https://www.mikenewswanger.com/posts/2020/docker-image-digests/>digest</a> will guarantee that, a digest is immutable.</p><p>Update the <code>Dockerfile</code> with these two base images:</p><ul><li><code>mcr.microsoft.com/dotnet/sdk:7.0@sha256:f712881bafadf0e56250ece1da28ba2baedd03fb3dd49a67f209f9d0cf928e81</code></li><li><code>mcr.microsoft.com/dotnet/runtime-deps:7.0-alpine3.17-amd64@sha256:941c0748b773dd13f2930cded91d01f62d357a785550c25eabe3d53d7997ae4b</code></li></ul><p><em>Note: it’s also highly encouraged that you store these two base images in your own private container registry and update your <code>Dockerfile</code> to point to them. You will guarantee their provenance, you will be able to scan them, etc.</em></p><h2 id=5-update-dependencies>5. Update dependencies
<a href=#5-update-dependencies class=h-anchor aria-hidden=true>#</a></h2><p>An important aspect is to keep your dependencies up-to-date in order to fix CVEs, catch new features, etc. One way to help you with that, in an automated fashion, is to leverage tools like <a href=https://www.mend.io/renovate/><code>Renovate</code></a> or <a href=https://docs.github.com/en/code-security/dependabot/working-with-dependabot><code>Dependabot</code></a> if you are using GitHub.</p><p>Here is an example of how you can configure <code>Dependabot</code> to keep your container base images as well as your .NET packages up-to-date:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &lt;&lt;EOF &gt; .github/dependabot.yml
</span></span><span style=display:flex><span>version: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>updates:
</span></span><span style=display:flex><span>  - package-ecosystem: <span style=color:#e6db74>&#34;docker&#34;</span>
</span></span><span style=display:flex><span>    directory: <span style=color:#e6db74>&#34;/my-sample-app&#34;</span>
</span></span><span style=display:flex><span>    schedule:
</span></span><span style=display:flex><span>      interval: <span style=color:#e6db74>&#34;daily&#34;</span>
</span></span><span style=display:flex><span>  - package-ecosystem: <span style=color:#e6db74>&#34;nuget&#34;</span>
</span></span><span style=display:flex><span>    directory: <span style=color:#e6db74>&#34;/my-sample-app&#34;</span>
</span></span><span style=display:flex><span>    schedule:
</span></span><span style=display:flex><span>      interval: <span style=color:#e6db74>&#34;daily&#34;</span>
</span></span></code></pre></div><h2 id=6-dockerignore>6. <code>.dockerignore</code>
<a href=#6-dockerignore class=h-anchor aria-hidden=true>#</a></h2><p>Use a <a href=https://docs.docker.com/engine/reference/builder/#dockerignore-file><code>.dockerignore</code></a> file to ignore files that do not need to be added to the image.</p><p>Here is an example of how your <code>.dockerignore</code> could look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; my-sample-app/.dockerignore
</span></span></span><span style=display:flex><span><span style=color:#e6db74>**/*.sh
</span></span></span><span style=display:flex><span><span style=color:#e6db74>**/*.bat
</span></span></span><span style=display:flex><span><span style=color:#e6db74>**/bin/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>**/obj/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>**/out/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Dockerfile*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h2 id=7-unprivilegenon-root-container>7. Unprivilege/non-root container
<a href=#7-unprivilegenon-root-container class=h-anchor aria-hidden=true>#</a></h2><p>For security purposes, always ensure that your images run as non-root by defining <code>USER</code> in your <code>Dockerfile</code>.</p><p>ASP.NET Core apps listen on port <code>80</code> by default. The problem is that port <code>80</code> is a <a href=https://www.w3.org/Daemon/User/Installation/PrivilegedPorts.html>privileged port</a> that requires root permission. For making our container unprivilege, we will configure its port to <code>8080</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> ASPNETCORE_URLS<span style=color:#f92672>=</span>http://*:8080<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> 1000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>You can now run this container with <code>-u 1000</code> on port <code>8080</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d -p 80:8080 -u <span style=color:#ae81ff>1000</span> my-sample-app
</span></span><span style=display:flex><span>curl localhost:80
</span></span></code></pre></div><h2 id=8-read-only-container-filesystem>8. Read-only container filesystem
<a href=#8-read-only-container-filesystem class=h-anchor aria-hidden=true>#</a></h2><p>To make the container in read-only mode on filesystem, <a href=https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-environment-variables#dotnet_enablediagnostics><code>DOTNET_EnableDiagnostics</code></a> needs to be turned off. <code>DOTNET_EnableDiagnostics</code> allows is used for debugging, profiling, and other diagnostics.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ENV</span> DOTNET_EnableDiagnostics<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>You can now run this container with <code>--read-only</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d -p 80:8080 -u <span style=color:#ae81ff>1000</span> --read-only my-sample-app
</span></span><span style=display:flex><span>curl localhost:80
</span></span></code></pre></div><h2 id=thats-a-wrap>That’s a wrap!
<a href=#thats-a-wrap class=h-anchor aria-hidden=true>#</a></h2><p>Congrats!</p><p>With these 8 tips illustrated throughout this blog post, we:</p><ul><li>Reduced the surface of attack of the container image (<code>alpine</code> was chosen, more <code>distroless</code> options are coming, stay tuned!)</li><li>Illustrated tips to improve the day-2 operations in order to keep our dependencies up-to-date</li><li>Made the container running as unprivilege/non-root in read-only on filesystem</li></ul><p>Here is the final <code>Dockerfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/dotnet/sdk:7.0@sha256:f712881bafadf0e56250ece1da28ba2baedd03fb3dd49a67f209f9d0cf928e81 as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> my-sample-app.csproj .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> dotnet restore my-sample-app.csproj -r linux-musl-x64<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> dotnet publish my-sample-app.csproj -r linux-musl-x64 -c release -o /my-sample-app --no-restore --self-contained true -p:PublishSingleFile<span style=color:#f92672>=</span>true -p:PublishTrimmed<span style=color:#f92672>=</span>true -p:TrimMode<span style=color:#f92672>=</span>partial<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/dotnet/runtime-deps:7.0-alpine3.17-amd64@sha256:941c0748b773dd13f2930cded91d01f62d357a785550c25eabe3d53d7997ae4b</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /my-sample-app .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> ASPNETCORE_URLS<span style=color:#f92672>=</span>http://*:8080<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> DOTNET_EnableDiagnostics<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> 1000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/app/my-sample-app&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>And if you want to deploy this container image in a secure manner in Kubernetes, here is the associated <code>Deployment</code> resource:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-sample-app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>my-sample-app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>my-sample-app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>my-sample-app</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>fsGroup</span>: <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>runAsGroup</span>: <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>runAsNonRoot</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>seccompProfile</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>RuntimeDefault</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-sample-app</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>allowPrivilegeEscalation</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>capabilities</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>drop</span>:
</span></span><span style=display:flex><span>                - <span style=color:#ae81ff>ALL</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>privileged</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>readOnlyRootFilesystem</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>my-sample-app:latest</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>You are now ready to Sail Sharp! Hope you enjoyed that one! Cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://mathieu-benoit.github.io/posts/2023/03/chainguard-nginx/><span class=button__text>chainguard nginx container image</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>