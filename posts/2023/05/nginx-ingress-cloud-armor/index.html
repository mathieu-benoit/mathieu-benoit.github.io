<!doctype html><html lang=en><head><title>secure nginx ingress controller behind cloud armor ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="As one of the main maintainers of the Edge to Mesh tutorial for the last 2-3 years, I have been a huge fan of the managed GCE ingress controller. From GKE, you could use Ingress, Service, BackendConfig manifests in order to generate all the Google Cloud Infrastructure to expose your public endpoint behind an HTTPS L7 Load Balancer and leverage advanced features like CDN, Cloud Armor, etc.
Deploying external L7 load balancing outside of the mesh along with a mesh ingress layer offers significant advantages, especially for internet traffic."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2023/05/nginx-ingress-cloud-armor/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="secure nginx ingress controller behind cloud armor"><meta name=twitter:description content="let's see how we can secure our nginx ingress controller behind an l7 https load balancer and cloud armor"><meta property="og:title" content="secure nginx ingress controller behind cloud armor"><meta property="og:description" content="let's see how we can secure our nginx ingress controller behind an l7 https load balancer and cloud armor"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2023/05/nginx-ingress-cloud-armor/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-09T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-09T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>secure nginx ingress controller behind cloud armor</h1><div class=post-meta><span class=post-date>2023-05-09</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;</span><div class=post-content><p>As one of the main maintainers of the <a href=https://cloud.google.com/architecture/exposing-service-mesh-apps-through-gke-ingress>Edge to Mesh tutorial</a> for the last 2-3 years, I have been a huge fan of the managed GCE ingress controller. From GKE, you could use <a href=https://cloud.google.com/armor/docs/integrating-cloud-armor#with_ingress><code>Ingress</code>, <code>Service</code>, <code>BackendConfig</code> manifests</a> in order to generate all the Google Cloud Infrastructure to expose your public endpoint behind an HTTPS L7 Load Balancer and leverage advanced features like CDN, Cloud Armor, etc.</p><blockquote><p><em>Deploying external L7 load balancing outside of the mesh along with a mesh ingress layer offers significant advantages, especially for internet traffic. Even though Anthos Service Mesh and Istio ingress gateways provide advanced routing and traffic management in the mesh, some functions are better served at the edge of the network. Taking advantage of internet-edge networking through Google Cloud&rsquo;s external HTTP(S) load balancer might provide significant performance, reliability, or security-related benefits over mesh-based ingress.</em></p></blockquote><p>I was recently involved in a project where the Nginx Ingress controller (from the <a href=https://github.com/kubernetes/ingress-nginx>Kubernetes community</a> but same applies to the one maintained by <a href=https://github.com/nginxinc/kubernetes-ingress>NGINX Inc.</a>) was used. It was for different reasons, one of them for example is that the <a href=https://stackoverflow.com/questions/50294272/how-come-gke-gives-me-different-ips-for-each-ingress-that-i-create>GCE ingress controller doesn&rsquo;t support multiple <code>Ingresses</code> on the same public IP address</a>.</p><p>Now let&rsquo;s say you want to secure your Nginx Ingress controller behind an HTTPS L7 Load Balancer and Cloud Armor. Sounds appealing, right? But actually it&rsquo;s <a href=https://stackoverflow.com/questions/67285351/how-can-i-use-cloud-armor-on-nginx-ingress-controller>not supported like you can easily do it with the GCE ingress controller</a>.</p><p>Fortunately, after some research I found out that we can set this up by ourself, manually. <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/custom-ingress-controller>Here</a>, <a href=https://hodo.dev/posts/post-27-gcp-using-neg/>here</a>, <a href=https://stackoverflow.com/questions/72476714/global-load-balancer-https-loadbalancer-in-front-of-gke-nginx-ingress-controll/72940666#72940666>here</a> or <a href=https://stackoverflow.com/questions/72950423/gcp-external-http-cloud-load-balancer-with-nginx-ingress-on-gke>here</a> are good pointers I found.</p><p>But to be honest, after giving them a shot, I found out that they were not complete for my own needs with more security as requirements. Here is what I needed in addition to what was shared:</p><ul><li>Expose an <a href=https://cloud.google.com/load-balancing/docs/https>HTTPS endpoint</a> (not just HTTP)</li><li>Support an <a href=https://cloud.google.com/load-balancing/docs/https/setting-up-global-http-https-redirect>HTTP-to-HTTPS redirect</a></li><li>Set <a href=https://cloud.google.com/load-balancing/docs/ssl-certificates/encryption-to-the-backends>HTTPS between the GCLB and the Nginx ingress controller</a></li><li>Use <a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#use-forwarded-headers>Custom Header to keep the source IP address from the L7 Load Balancer</a></li><li>Use the new <a href=https://cloud.google.com/blog/products/networking/increasing-resiliency-load-balancers>next generation Global External Load Balancer</a></li><li>Use a private GKE cluster</li></ul><p>That&rsquo;s what I will cover throughout this blog post by sharing my learnings and showing you this end-to-end setup, please bear with me! :)</p><p><em>Note: I&rsquo;m doing this via <code>gcloud</code> commands, but everything can be done via Terraform too.</em></p><p>Define common variables:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PROJECT_ID<span style=color:#f92672>=</span>FIXME
</span></span><span style=display:flex><span>gcloud config set project <span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CLUSTER_NAME<span style=color:#f92672>=</span>FIXME
</span></span><span style=display:flex><span>CLUSTER_ZONE<span style=color:#f92672>=</span>FIXME
</span></span></code></pre></div><p>Get some information from your existing GKE cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud container clusters get-credentials <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --zone <span style=color:#e6db74>${</span>CLUSTER_ZONE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CLUSTER_FIREWALL_RULE_TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>gcloud compute instances describe <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>$(</span>kubectl get nodes -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--zone <span style=color:#e6db74>${</span>CLUSTER_ZONE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --format <span style=color:#e6db74>&#34;value(tags.items[0])&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>CLUSTER_MASTER_IP_CIDR<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>gcloud container clusters describe <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --zone <span style=color:#e6db74>${</span>CLUSTER_ZONE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --format <span style=color:#e6db74>&#34;value(privateClusterConfig.masterIpv4CidrBlock)&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>NETWORK<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>gcloud container clusters describe <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --zone <span style=color:#e6db74>${</span>CLUSTER_ZONE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --format <span style=color:#e6db74>&#34;value(network)&#34;</span><span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>Deploy the Nginx Ingress Controller not exposed as public endpoint, supporting HTTPS only, keeping the source IP address coming from the L7 load balancer and attached to the associated Network Endpoint Group:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NGINX_NEG_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>NGINX_NEG_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-<span style=color:#e6db74>${</span>NGINX_NEG_PORT<span style=color:#e6db74>}</span>-neg
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; ${CLUSTER_NAME}-nginx-ingress-controller-values.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>controller:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  service:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    enableHttp: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    type: ClusterIP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    annotations:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      cloud.google.com/neg: &#39;{&#34;exposed_ports&#34;: {&#34;${NGINX_NEG_PORT}&#34;:{&#34;name&#34;: &#34;${NGINX_NEG_NAME}&#34;}}}&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  config:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    use-forwarded-headers: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>helm upgrade <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --install ingress-nginx ingress-nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --repo https://kubernetes.github.io/ingress-nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --namespace ingress-nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --create-namespace <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-nginx-ingress-controller-values.yaml
</span></span></code></pre></div><p>This will create for you the associated Network Endpoint Group (NEG) that we will attach later to our Global Load Balancer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute network-endpoint-groups list
</span></span></code></pre></div><p>If you are using a GKE cluster with private nodes, you need to allow the Kubernetes master nodes to talk to the node pool on port <code>8443</code> for Nginx Ingress controller:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute firewall-rules create k8s-masters-to-nodes-on-8443 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network <span style=color:#e6db74>${</span>NETWORK<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --direction INGRESS <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --source-ranges <span style=color:#e6db74>${</span>CLUSTER_MASTER_IP_CIDR<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --target-tags <span style=color:#e6db74>${</span>CLUSTER_FIREWALL_RULE_TAG<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --allow tcp:8443
</span></span></code></pre></div><h2 id=configure-the-backend>Configure the backend
<a href=#configure-the-backend class=h-anchor aria-hidden=true>#</a></h2><p>Now, let’s create the Load Balancer and all the required components.</p><p>Let&rsquo;s define the type of HTTPS Load Balancer we want. <code>EXTERNAL_MANAGED</code> means that we will use the <a href=https://cloud.google.com/blog/products/networking/increasing-resiliency-load-balancers>next generation Global External Load Balancer</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>LOAD_BALANCING_SCHEME<span style=color:#f92672>=</span>EXTERNAL_MANAGED
</span></span></code></pre></div><p><em>Note: You can use <code>EXTERNAL</code> if you want to still use the Global External Load Balancer (Classic) instead. You can see the differences and the limitations between both <a href=https://cloud.google.com/load-balancing/docs/https/migrate-to-global>here</a>.</em></p><p>Allow traffic from the Load Balancer to the node pool on port <code>443</code> for Nginx Ingress controller:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute firewall-rules create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-allow-tcp-loadbalancer <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network <span style=color:#e6db74>${</span>NETWORK<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --allow tcp:<span style=color:#e6db74>${</span>NGINX_NEG_PORT<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --source-ranges 130.211.0.0/22,35.191.0.0/16 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --target-tags <span style=color:#e6db74>${</span>CLUSTER_FIREWALL_RULE_TAG<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>Add an HTTPS Health Check configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute health-checks create https <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-health-check <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --port <span style=color:#e6db74>${</span>NGINX_NEG_PORT<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --check-interval <span style=color:#ae81ff>60</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --unhealthy-threshold <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --healthy-threshold <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --timeout <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --request-path /healthz
</span></span></code></pre></div><p>Create a backend service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute backend-services create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-backend-service <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --load-balancing-scheme <span style=color:#e6db74>${</span>LOAD_BALANCING_SCHEME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --protocol HTTPS <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --port-name https <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --health-checks <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-health-check <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-logging <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global
</span></span></code></pre></div><p>Add the NEG to the backend service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute backend-services add-backend <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-backend-service <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network-endpoint-group <span style=color:#e6db74>${</span>NGINX_NEG_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network-endpoint-group-zone <span style=color:#e6db74>${</span>CLUSTER_ZONE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --balancing-mode RATE <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --capacity-scaler 1.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --max-rate-per-endpoint <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global
</span></span></code></pre></div><h2 id=configure-the-frontend>Configure the frontend
<a href=#configure-the-frontend class=h-anchor aria-hidden=true>#</a></h2><p>That was for the backend part, let&rsquo;s now do the frontend part.</p><p>Create an url map:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute url-maps create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-loadbalancer <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --default-service <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-backend-service
</span></span></code></pre></div><p>Create an HTTP proxy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute target-http-proxies create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-http-proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --url-map <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-loadbalancer
</span></span></code></pre></div><p>Create a public static IP address:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute addresses create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-public-static-ip <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global
</span></span><span style=display:flex><span>INGRESS_IP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>gcloud compute addresses describe <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-public-static-ip --global --format <span style=color:#e6db74>&#34;value(address)&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>${</span>INGRESS_IP<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>Here you can bring your own DNS, I&rsquo;m creating one to illustrate the scenario with an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>DNS<span style=color:#f92672>=</span>my-dns.endpoints.<span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>.cloud.goog
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; my-dns-spec.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>swagger: &#34;2.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>info:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  description: &#34;Cloud Endpoints DNS&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  title: &#34;Cloud Endpoints DNS&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  version: &#34;1.0.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>paths: {}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>host: &#34;${DNS}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>x-google-endpoints:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- name: &#34;${DNS}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  target: &#34;${INGRESS_IP}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>gcloud endpoints services deploy my-dns-spec.yaml
</span></span></code></pre></div><p>Generate the SSL certificate for this DNS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl genrsa -out my-dns-ca.key <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>openssl req -x509 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -new <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -nodes <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -days <span style=color:#ae81ff>365</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -key my-dns-ca.key <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -out my-dns-ca.crt <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -subj <span style=color:#e6db74>&#34;/CN=</span><span style=color:#e6db74>${</span>DNS<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>Upload this SSL certificate in Google Cloud:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute ssl-certificates create my-dns-ssl-certificate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --certificate my-dns-ca.crt <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --private-key my-dns-ca.key <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global
</span></span><span style=display:flex><span>gcloud compute target-https-proxies create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-http-proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --url-map <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-loadbalancer <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --ssl-certificates my-dns-ssl-certificate
</span></span></code></pre></div><p><em>Note: If you have multiple SSL certificates, that&rsquo;s where you will provide them.</em></p><p>Create a global forwarding rule on port <code>443</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute forwarding-rules create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-https-forwarding-rule <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --load-balancing-scheme <span style=color:#e6db74>${</span>LOAD_BALANCING_SCHEME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network-tier PREMIUM <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --ports <span style=color:#ae81ff>443</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --target-https-proxy <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-http-proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --address <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-public-static-ip
</span></span></code></pre></div><h2 id=configure-https-redirect>Configure HTTPS redirect
<a href=#configure-https-redirect class=h-anchor aria-hidden=true>#</a></h2><p>Configure an HTTP to HTTPS redirect on the load balancer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; ${CLUSTER_NAME}-http-to-https-redirect.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: compute#urlMap
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name: ${CLUSTER_NAME}-http-to-https-redirect
</span></span></span><span style=display:flex><span><span style=color:#e6db74>defaultUrlRedirect:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  redirectResponseCode: MOVED_PERMANENTLY_DEFAULT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  httpsRedirect: True
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>gcloud compute url-maps import <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-http-to-https-redirect <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --source <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-http-to-https-redirect.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global
</span></span><span style=display:flex><span>gcloud compute target-http-proxies create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-http-to-https-redirect-proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --url-map <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-http-to-https-redirect <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global
</span></span><span style=display:flex><span>gcloud compute forwarding-rules create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-http-to-https-redirect-rule <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --load-balancing-scheme <span style=color:#e6db74>${</span>LOAD_BALANCING_SCHEME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network-tier PREMIUM <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --address <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-public-static-ip <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --target-http-proxy <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-http-to-https-redirect-proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --ports <span style=color:#ae81ff>80</span>
</span></span></code></pre></div><h2 id=configure-cloud-armor>Configure Cloud Armor
<a href=#configure-cloud-armor class=h-anchor aria-hidden=true>#</a></h2><p>Create Cloud Armor and attach it to the public endpoint:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute security-policies create <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-security-policy
</span></span><span style=display:flex><span>gcloud compute security-policies update <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-security-policy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-layer7-ddos-defense
</span></span><span style=display:flex><span>gcloud compute backend-services update <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-ingress-nginx-backend-service <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --global <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --security-policy <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>-security-policy
</span></span></code></pre></div><p><em>Note: From here, you could use any <a href=https://cloud.google.com/armor/docs/cloud-armor-overview>additional features from Cloud Armor</a> you want. In this example, we are just using the default DDoS protection</em></p><p>That&rsquo;s it for the setup, we made it!</p><h2 id=deploy-a-sample-app>Deploy a sample app
<a href=#deploy-a-sample-app class=h-anchor aria-hidden=true>#</a></h2><p>Let&rsquo;s now deploy a sample app.</p><p>Deploy the app:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment whereami <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image us-docker.pkg.dev/google-samples/containers/gke/whereami <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --port <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>kubectl expose deployment whereami <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --port <span style=color:#ae81ff>80</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --target-port <span style=color:#ae81ff>8080</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --type ClusterIP
</span></span></code></pre></div><p>Bind the app to the Nginx Ingress controller:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Ingress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: whereami
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ingressClassName: nginx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  rules:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - host: ${DNS}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    http:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      paths:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - backend:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          service:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            name: whereami
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            port:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              number: 80
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        path: /
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        pathType: Prefix
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p><em>Note: You will notice that we don&rsquo;t set the TLS configuration here since it is managed on the Load Balancer directly thanks to the setup we did earlier.</em></p><p>Now if you hit the link displayed below you will be redirected to an HTTPS link and to eventually a working (and very secure) app:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -E <span style=color:#e6db74>&#34;http:://</span><span style=color:#e6db74>${</span>DNS<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion
<a href=#conclusion class=h-anchor aria-hidden=true>#</a></h2><p>Wow! Quite a long ride to make it, right? Yup! But that&rsquo;s what it takes to actually secure your Nginx Ingress controller (or any 3rd party reverse proxy you may use in GKE). Hope you liked it and that you will be able to use this for your own context.</p><p>Cheers! Stay safe out there! Happy sailing!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://mathieu-benoit.github.io/posts/2023/03/sail-sharp/><span class=button__text>sail sharp, 8 tips to optimize and secure your .net containers for kubernetes</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>