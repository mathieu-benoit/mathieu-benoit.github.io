<!doctype html><html lang=en><head><title>keyless gcp authentication from github actions with workload identity federation ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Last November 2021, GitHub announced the GA support of OpenID Connect (OIDC) with GitHub actions for secure deployments to cloud, which uses short-lived tokens that are automatically rotated for each deployment. There are different providers supported like Azure, AWS, GCP, etc. Amazing! More security in CI/CD pipelines with GitHub actions!
Seamless authentication between Cloud Providers and GitHub without the need for storing any long-lived cloud secrets in GitHub
Cloud Admins can rely on the security mechanisms of their cloud provider to ensure that GitHub Actions workflows get the minimal access for cloud resources."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog/posts/2022/01/workload-identity-federation/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="keyless gcp authentication from github actions with workload identity federation"><meta name=twitter:description content="let's see how to use a keyless gcp authentication from github actions with workload identity federation"><meta property="og:title" content="keyless gcp authentication from github actions with workload identity federation"><meta property="og:description" content="let's see how to use a keyless gcp authentication from github actions with workload identity federation"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog/posts/2022/01/workload-identity-federation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-30T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-30T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog/about/>about</a></li><li><a href=/myblog/presentations/>presentations</a></li><li><a href=/myblog/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog/about/>about</a></li><li><a href=/myblog/presentations/>presentations</a></li><li><a href=/myblog/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>keyless gcp authentication from github actions with workload identity federation</h1><div class=post-meta><span class=post-date>2022-01-30</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/containers/>#containers</a>&nbsp;</span><div class=post-content><p>Last November 2021, GitHub announced the GA support of <a href=https://github.blog/2021-11-23-secure-deployments-openid-connect-github-actions-generally-available/>OpenID Connect (OIDC) with GitHub actions</a> for secure deployments to cloud, which uses short-lived tokens that are automatically rotated for each deployment. There are different providers supported like Azure, AWS, GCP, etc. Amazing! More security in CI/CD pipelines with GitHub actions!</p><blockquote><p>Seamless authentication between Cloud Providers and GitHub without the need for storing any long-lived cloud secrets in GitHub</p></blockquote><blockquote><p>Cloud Admins can rely on the security mechanisms of their cloud provider to ensure that GitHub Actions workflows get the minimal access for cloud resources. There is no duplication of secret management in GitHub and the cloud.</p></blockquote><p>With GCP you could use the <a href=https://cloud.google.com/blog/products/identity-security/enabling-keyless-authentication-from-github-actions><code>google-github-actions/auth</code> GitHub action</a> which leverages <a href=https://cloud.google.com/blog/products/identity-security/enable-keyless-access-to-gcp-with-workload-identity-federation>Workload Identity Federation</a> as a keyless API authentication.</p><blockquote><p>Using identity federation, you can grant on-premises or multi-cloud workloads access to Google Cloud resources, without using a service account key.</p></blockquote><blockquote><p>The GitHub Action <a href=https://github.com/google-github-actions/auth><code>google-github-actions/auth</code></a> exchanges a GitHub Actions OIDC token into a Google Cloud access token using Workload Identity Federation. This obviates the need to export a long-lived Google Cloud service account key and establishes a trust delegation relationship between a particular GitHub Actions workflow invocation and permissions on Google Cloud.</p></blockquote><p>Let&rsquo;s see this in action, first we need to configure the Workload Identity pool:</p><pre tabindex=0><code>projectId=FIXME
gcloud config set project $projectId

# Create the Service Account
gcloud iam service-accounts create &#34;my-service-account&#34;
saId=&#34;my-service-account@${projectId}.iam.gserviceaccount.com&#34;

# Enable the IAM Credentials API
gcloud services enable iamcredentials.googleapis.com

# Create a Workload Identity Pool
poolName=wi-pool
gcloud iam workload-identity-pools create $poolName \
  --location global \
  --display-name $poolName
poolId=$(gcloud iam workload-identity-pools describe $poolName \
  --location global \
  --format=&#39;get(name)&#39;)

# Create a Workload Identity Provider with GitHub actions in that pool:
attributeMappingScope=repository # could be sub (GitHub repository and branch) or repository_owner (GitHub organization)
gcloud iam workload-identity-pools providers create-oidc $poolName \
  --location global \
  --workload-identity-pool $poolName \
  --display-name $poolName \
  --attribute-mapping &#34;google.subject=assertion.${attributeMappingScope},attribute.actor=assertion.actor,attribute.aud=assertion.aud,attribute.repository=assertion.repository&#34; \
  --issuer-uri &#34;https://token.actions.githubusercontent.com&#34;
providerId=$(gcloud iam workload-identity-pools providers describe $poolName \
  --location global \
  --workload-identity-pool $poolName \
  --format=&#39;get(name)&#39;)

# Allow authentications from the Workload Identity Provider to impersonate the Service Account created above
gitHubRepoName=&#34;repo-org/repo-name&#34;
gcloud iam service-accounts add-iam-policy-binding $saId \
  --role &#34;roles/iam.workloadIdentityUser&#34; \
  --member &#34;principalSet://iam.googleapis.com/${poolId}/attribute.${attributeMappingScope}/${gitHubRepoName}&#34;
</code></pre><p>Then, we could leverage Workload Identity Federation from GitHub actions:</p><pre tabindex=0><code>...
jobs:
  job:
    permissions:
      contents: &#39;read&#39;
      id-token: &#39;write&#39;
    steps:
      - uses: actions/checkout
      - id: gcp-auth
        uses: google-github-actions/auth
        with:
          workload_identity_provider: &#39;${providerId}&#39;
          service_account: &#39;${saId}&#39;
      - uses: google-github-actions/setup-gcloud
</code></pre><p>That&rsquo;s pretty much it, any next steps could interact with GCP depending on the roles you will assign to the associated Service Account created earlier.</p><p>There is other scenario where you will need a <a href=https://github.com/google-github-actions/auth#generating-an-oauth-20-access-token>short-lived access token</a>, below is an example with <code>Docker</code> commands:</p><pre tabindex=0><code>...
jobs:
  job:
    permissions:
      contents: &#39;read&#39;
      id-token: &#39;write&#39;
    steps:
      - uses: actions/checkout
      - id: gcp-auth
        uses: google-github-actions/auth
        with:
          workload_identity_provider: &#39;${providerId}&#39;
          service_account: &#39;${saId}&#39;
          token_format: &#39;access_token&#39;
      - name: sign-in to artifact registry
        run: |
          gcloud auth configure-docker ${location}-docker.pkg.dev --quiet
      - name: build and push container
        run: |
          docker build ...
          docker push ...
</code></pre><p>In this scenario, you will need to grant the Service Account with 1 role:</p><pre tabindex=0><code>gcloud artifacts repositories add-iam-policy-binding $artifactRegistryName \
    --project $projectId \
    --location $location \
    --member &#34;serviceAccount:$saId&#34; \
    --role roles/artifactregistry.writer
</code></pre><p>That&rsquo;s a wrap, no excuses anymore to use the not recommended approach with the Service Account keys!</p><p>Complementary and further resources:</p><ul><li><a href=https://youtu.be/4vajaXzHN08>What is Workload Identity Federation?</a></li><li><a href=https://cloud.google.com/iam/docs/best-practices-for-using-workload-identity-federation>Best practices for using workload identity federation</a></li></ul><p>Hope you enjoyed that one, stay safe out there! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog/posts/2022/02/config-controller-intro/><span class=button__icon>←</span>
<span class=button__text>config controller in action</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog/posts/2022/01/istio-tls-origination/><span class=button__text>istio tls origination to secure memorystore (redis) access</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>