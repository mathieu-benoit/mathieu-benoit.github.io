<!doctype html><html lang=en><head><title>grpc health probes with kubernetes 1.24+ ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="gRPC health probes are natively supported in beta since Kubernetes 1.24+. Before that we needed to add the grpc_health_probe binary in each Dockerfile.
Since the recent v0.4.1 version, the Online Boutique sample provides an option to have its applications supporting this feature. This allows to leverage the native Kubernetes feature, decrease the size of the container images by 4MB (virtual) and 11MB (on disk) as well as reduce the maintenance and surface of attack that this grpc_health_probe binary was adding."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2022/10/grpc-health-probes/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="grpc health probes with kubernetes 1.24+"><meta name=twitter:description content="let's see how we could leverage the new kubernetes 1.24+ grpc health probes features with the onlineboutique sample apps"><meta property="og:title" content="grpc health probes with kubernetes 1.24+"><meta property="og:description" content="let's see how we could leverage the new kubernetes 1.24+ grpc health probes features with the onlineboutique sample apps"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2022/10/grpc-health-probes/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-29T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-29T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>grpc health probes with kubernetes 1.24+</h1><div class=post-meta><span class=post-date>2022-10-29</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;</span><div class=post-content><p>gRPC health probes are natively supported in beta <a href=https://kubernetes.io/blog/2022/05/13/grpc-probes-now-in-beta/>since Kubernetes 1.24+</a>. Before that we needed to add the <a href=https://cloud.google.com/blog/topics/developers-practitioners/health-checking-your-grpc-servers-gke><code>grpc_health_probe</code> binary in each <code>Dockerfile</code></a>.</p><p>Since the <a href=https://github.com/GoogleCloudPlatform/microservices-demo/releases/tag/v0.4.1>recent v0.4.1 version</a>, the <a href=https://github.com/GoogleCloudPlatform/microservices-demo>Online Boutique sample</a> provides an option to have its applications supporting this feature. This allows to leverage the native Kubernetes feature, decrease the size of the container images by 4MB (virtual) and 11MB (on disk) as well as reduce the maintenance and surface of attack that this <code>grpc_health_probe</code> binary was adding.</p><h2 id=what-are-the-differences-with-before>What are the differences with before?
<a href=#what-are-the-differences-with-before class=h-anchor aria-hidden=true>#</a></h2><p>In your <code>Dockerfile</code>, you don&rsquo;t need anymore to <a href=https://cloud.google.com/blog/topics/developers-practitioners/health-checking-your-grpc-servers-gke>add the <code>grpc_health_probe</code> binary (like we needed to previously)</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> GRPC_HEALTH_PROBE_VERSION<span style=color:#f92672>=</span>v0.4.14 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    wget -qO/bin/grpc_health_probe https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/<span style=color:#e6db74>${</span>GRPC_HEALTH_PROBE_VERSION<span style=color:#e6db74>}</span>/grpc_health_probe-linux-amd64 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    chmod +x /bin/grpc_health_probe<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>In the Kubernetes manifests for your <code>Deployments</code>, here is the associated updates for both the <code>readinessProbe</code> and the <code>livenessProbe</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a6e22e>+           grpc:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+             port: 9555
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#f92672>-           exec:
</span></span></span><span style=display:flex><span><span style=color:#f92672>-             command:
</span></span></span><span style=display:flex><span><span style=color:#f92672>-             - /bin/grpc_health_probe
</span></span></span><span style=display:flex><span><span style=color:#f92672>-             - -addr=:9555
</span></span></span></code></pre></div><h2 id=how-to-deploy-the-online-boutique-sample-with-this-new-feature>How to deploy the Online Boutique sample with this new feature?
<a href=#how-to-deploy-the-online-boutique-sample-with-this-new-feature class=h-anchor aria-hidden=true>#</a></h2><p>Create a GKE cluster in version 1.24+:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud container clusters create tests <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --zone<span style=color:#f92672>=</span>us-east4-a <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --machine-type<span style=color:#f92672>=</span>e2-standard-2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --num-nodes<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --release-channel<span style=color:#f92672>=</span>rapid
</span></span></code></pre></div><p><em>Note: as of now, the default version of <a href=https://cloud.google.com/kubernetes-engine/docs/release-notes-rapid>GKE in rapid channel is 1.24</a>.</em></p><p>From there, let&rsquo;s deploy the Online Boutique sample with the gRPC health probes experimental variation.</p><p>Get the remote Kustomize components:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir native-grpc-health-check
</span></span><span style=display:flex><span>curl -L https://raw.githubusercontent.com/GoogleCloudPlatform/microservices-demo/main/kustomize/components/native-grpc-health-check/kustomization.yaml &gt; native-grpc-health-check/kustomization.yaml
</span></span></code></pre></div><p>Update the local Kustomize components:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ONLINE_BOUTIQUE_VERSION<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s https://api.github.com/repos/GoogleCloudPlatform/microservices-demo/releases | jq -r <span style=color:#e6db74>&#39;[.[]] | .[0].tag_name&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/ONLINE_BOUTIQUE_VERSION/</span>$ONLINE_BOUTIQUE_VERSION<span style=color:#e6db74>/g&#34;</span> native-grpc-health-check/kustomization.yaml
</span></span></code></pre></div><p>Configure the Kustomize overlay:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF&gt; kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: kustomize.config.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Kustomization
</span></span></span><span style=display:flex><span><span style=color:#e6db74>resources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- github.com/GoogleCloudPlatform/microservices-demo/kustomize/base
</span></span></span><span style=display:flex><span><span style=color:#e6db74>components:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- native-grpc-health-check
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Optionally, you can render the Kubernetes manifests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kustomize build .
</span></span></code></pre></div><p>In the Kubernetes manifests for the <code>Deployments</code>, here is the associated update for the container <code>image</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>-         image: gcr.io/google-samples/microservices-demo/*service:v0.4.1
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+         image: gcr.io/google-samples/microservices-demo/*service:v0.4.1-native-grpc-probes
</span></span></span></code></pre></div><p>Deploy this Kustomize overlay:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -k .
</span></span></code></pre></div><p>If you wait a little bit, when all the <code>Pods</code> are running, you should have your Online Boutique website working successfully.</p><p>That&rsquo;s how easy we were able to leverage the new <a href=https://kubernetes.io/blog/2022/05/13/grpc-probes-now-in-beta/>native gRPC health probes with Kubernetes 1.24+</a> with the Online Boutique sample.</p><p>The Online Boutique sample apps are not yet supporting by default this native gRPC health probes, because Kubernetes 1.24+ is not widely nor commonly used yet. That&rsquo;s why we need to use the <a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/kustomize/components/native-grpc-health-check>optional associated Kustomize overlay</a>.</p><p>Hope you enjoyed that one, happy sailing, cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2022/12/onlineboutique-with-helm/><span class=button__icon>←</span>
<span class=button__text>online boutique's helm chart, illustrate advanced scenarios with service mesh and gitops</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2022/10/onlineboutique-with-spanner/><span class=button__text>use google cloud spanner with the online boutique sample</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>