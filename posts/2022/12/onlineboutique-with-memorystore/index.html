<!doctype html><html lang=en><head><title>use google cloud memorystore (redis) with the online boutique sample ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Update on Dec 20th, 2022: this blog article is now on Medium.
By default the cartservice of the Online Boutique sample stores its data in an in-cluster Redis database. Using a fully managed database service outside your GKE cluster such as Memorystore (Redis) could bring more resiliency, scalability and more security.
Reduce latency with scalable, secure, and highly available in-memory service for Redis.
In this article, let&amp;rsquo;s see how you can connect the Online Boutique sample to Google Cloud Memorystore (Redis)."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2022/12/onlineboutique-with-memorystore/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="use google cloud memorystore (redis) with the online boutique sample"><meta name=twitter:description content="let's see how to use google cloud memorystore (redis) with the online boutique sample."><meta property="og:title" content="use google cloud memorystore (redis) with the online boutique sample"><meta property="og:description" content="let's see how to use google cloud memorystore (redis) with the online boutique sample."><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2022/12/onlineboutique-with-memorystore/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-20T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-20T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>use google cloud memorystore (redis) with the online boutique sample</h1><div class=post-meta><span class=post-date>2022-12-20</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;</span><div class=post-content><p><em>Update on Dec 20th, 2022: this blog article is now on <a href=https://medium.com/google-cloud/82f7879a900d>Medium</a>.</em></p><p>By default the <code>cartservice</code> of the Online Boutique sample stores its data in an in-cluster Redis database.
Using a fully managed database service outside your GKE cluster such as <a href=https://cloud.google.com/memorystore>Memorystore (Redis)</a> could bring more resiliency, scalability and more security.</p><blockquote><p>Reduce latency with scalable, secure, and highly available in-memory service for Redis.</p></blockquote><p>In this article, let&rsquo;s see how you can connect the Online Boutique sample to Google Cloud Memorystore (Redis).</p><p><img src=https://github.com/mathieu-benoit/my-images/raw/main/onlineboutique-with-memorystore.png alt="Architecture overview."></p><h2 id=objectives>Objectives
<a href=#objectives class=h-anchor aria-hidden=true>#</a></h2><ul><li>Create a Google Kubernetes Engine (GKE) cluster</li><li>Provision a Memorystore (Redis) instance</li><li>Deploy the Online Boutique sample connected to the Memorystore (Redis) instance</li></ul><h2 id=costs>Costs
<a href=#costs class=h-anchor aria-hidden=true>#</a></h2><p>This tutorial uses billable components of Google Cloud, including the following:</p><ul><li><a href=https://cloud.google.com/kubernetes-engine/pricing>Kubernetes Engine</a></li><li><a href=https://cloud.google.com/memorystore/docs/redis/pricing>Memorystore (Redis)</a></li></ul><p>Use the <a href=https://cloud.google.com/products/calculator>pricing calculator</a> to generate a cost estimate based on your projected usage.</p><h2 id=before-you-begin>Before you begin
<a href=#before-you-begin class=h-anchor aria-hidden=true>#</a></h2><p>This guide assumes that you have owner IAM permissions for your Google Cloud project. In production, you do not require owner permission.</p><ol><li><p><a href=https://console.cloud.google.com/projectselector2>Select or create a Google Cloud project</a>.</p></li><li><p><a href=https://cloud.google.com/billing/docs/how-to/modify-project>Verify that billing is enabled</a> for your project.</p></li></ol><h2 id=set-up-your-environment>Set up your environment
<a href=#set-up-your-environment class=h-anchor aria-hidden=true>#</a></h2><p>Initialize the common variables used throughout this tutorial:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PROJECT_ID<span style=color:#f92672>=</span>FIXME-WITH-YOUR-PROJECT-ID
</span></span><span style=display:flex><span>REGION<span style=color:#f92672>=</span>us-east5
</span></span><span style=display:flex><span>ZONE<span style=color:#f92672>=</span>us-east5-a
</span></span></code></pre></div><p>To avoid repeating the <code>--project</code> in the commands throughout this tutorial, let&rsquo;s set the current project:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud config set project <span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span>
</span></span></code></pre></div><h2 id=enable-the-required-apis-in-your-project>Enable the required APIs in your project
<a href=#enable-the-required-apis-in-your-project class=h-anchor aria-hidden=true>#</a></h2><p>Enable the required APIs in your project:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud services enable <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    redis.googleapis.com <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    container.googleapis.com
</span></span></code></pre></div><h2 id=create-a-gke-cluster>Create a GKE cluster
<a href=#create-a-gke-cluster class=h-anchor aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>CLUSTER<span style=color:#f92672>=</span>memorystore-with-onlineboutique
</span></span><span style=display:flex><span>gcloud container clusters create <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --zone <span style=color:#e6db74>${</span>ZONE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --machine-type<span style=color:#f92672>=</span>e2-standard-4 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --num-nodes <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network default
</span></span></code></pre></div><h2 id=provision-the-memorystore-redis-instance>Provision the Memorystore (Redis) instance
<a href=#provision-the-memorystore-redis-instance class=h-anchor aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>REDIS_NAME<span style=color:#f92672>=</span>memorystore-with-onlineboutique
</span></span><span style=display:flex><span>gcloud redis instances create <span style=color:#e6db74>${</span>REDIS_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --size <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --region <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --zone <span style=color:#e6db74>${</span>ZONE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --redis-version redis_6_x <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network default
</span></span></code></pre></div><p>Notes:</p><ul><li>You can connect to a Memorystore (Redis) instance from GKE clusters that are in the same region and use the same network as your instance.</li><li>You cannot connect to a Memorystore (Redis) instance from a GKE cluster without VPC-native/IP aliasing enabled.</li></ul><p>Wait for the Memorystore (Redis) instance to be succesfully provisioned and then get the connection information (private IP address and port):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>REDIS_IP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>gcloud redis instances describe <span style=color:#e6db74>${</span>REDIS_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --region <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --format <span style=color:#e6db74>&#39;get(host)&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>REDIS_PORT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>gcloud redis instances describe <span style=color:#e6db74>${</span>REDIS_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --region <span style=color:#e6db74>${</span>REGION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --format <span style=color:#e6db74>&#39;get(port)&#39;</span><span style=color:#66d9ef>)</span>
</span></span></code></pre></div><h2 id=deploy-online-boutique-connected-to-the-memorystore-redis-instance>Deploy Online Boutique connected to the Memorystore (Redis) instance
<a href=#deploy-online-boutique-connected-to-the-memorystore-redis-instance class=h-anchor aria-hidden=true>#</a></h2><p>Deploy the Online Boutique sample apps without the default in-cluster Redis database, and now pointing to the Memorystore (Redis) instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAMESPACE<span style=color:#f92672>=</span>onlineboutique
</span></span><span style=display:flex><span>helm upgrade onlineboutique oci://us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --create-namespace <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --set cartDatabase.inClusterRedis.create<span style=color:#f92672>=</span>false <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --set cartDatabase.connectionString<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>REDIS_IP<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>REDIS_PORT<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>After all the apps have successfully been deployed, you could navigate to the Online Boutique website by clicking on the link below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -n <span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>&amp;&amp;</span> kubectl get svc frontend-external -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> -o json | jq -r <span style=color:#e6db74>&#39;.status.loadBalancer.ingress[0].ip&#39;</span>
</span></span></code></pre></div><p>And voilà, that&rsquo;s how easy you can connect your Online Boutique sample apps to a Memorystore (Redis) database, congrats!</p><h2 id=cleaning-up>Cleaning up
<a href=#cleaning-up class=h-anchor aria-hidden=true>#</a></h2><p>To avoid incurring charges to your Google Cloud account, you can delete the resources used in this tutorial.</p><p>Delete the GKE cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud container clusters delete <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --zone <span style=color:#e6db74>${</span>ZONE<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>Delete the Memorystore (redis) instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud redis instances delete <span style=color:#e6db74>${</span>REDIS_NAME<span style=color:#e6db74>}</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion
<a href=#conclusion class=h-anchor aria-hidden=true>#</a></h2><p>Having the database outside of your GKE cluster with a managed service can bring you more resiliency, scalability and security. This setup allows complex scenarios like having your apps spreaded across multiple clusters, etc.</p><h2 id=further-resources>Further resources
<a href=#further-resources class=h-anchor aria-hidden=true>#</a></h2><ul><li><a href=https://cloud.google.com/blog/products/databases/best-pactices-for-cloud-memorystore-for-redis/>Google Cloud Memorystore for Redis Best Practices - Tips for a highly performant and worry-free deployment</a></li><li><a href=https://mathieu-benoit.github.io/posts/2022/08/encrypt-traffic-from-mesh-to-memorystore/>Seamlessly encrypt traffic from any apps in your Mesh to Memorystore (Redis)</a></li></ul><p>Happy sailing, cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2023/01/validating-admission-policies/><span class=button__icon>←</span>
<span class=button__text>validating admission policies, the future of kubernetes policies</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2022/12/onlineboutique-with-helm/><span class=button__text>online boutique's helm chart, illustrate advanced scenarios with service mesh and gitops</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>