<!doctype html><html lang=en><head><title>config controller in action ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In August 2021, Anthos Config Management (ACM) got a new feature called Config Controller, a hosted service to provision and orchestrate Google Cloud resources.
Config Controller offers an API endpoint that can provision, actuate, and orchestrate Google Cloud resources the same way it manages Kubernetes resources. You don’t have to install or manage the components—or be an expert in Kubernetes resource management or GitOps—because Google Cloud will manage them for you."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog.io/posts/2022/02/config-controller-intro/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog.io/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="config controller in action"><meta name=twitter:description content="let's see with config controller how we could build a secure platform allowing to deploy gcp resources via kubernetes manifests"><meta property="og:title" content="config controller in action"><meta property="og:description" content="let's see with config controller how we could build a secure platform allowing to deploy gcp resources via kubernetes manifests"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog.io/posts/2022/02/config-controller-intro/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-14T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-14T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>config controller in action</h1><div class=post-meta><span class=post-date>2022-02-14</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/security/>#security</a>&nbsp;</span><div class=post-content><p><a href=https://cloud.google.com/blog/products/containers-kubernetes/anthos-config-management-config-controller-available-on-gke>In August 2021</a>, Anthos Config Management (ACM) got a new feature called Config Controller, a hosted service to provision and orchestrate Google Cloud resources.</p><blockquote><p>Config Controller offers an API endpoint that can provision, actuate, and orchestrate Google Cloud resources the same way it manages Kubernetes resources. You don’t have to install or manage the components—or be an expert in Kubernetes resource management or GitOps—because Google Cloud will manage them for you.</p></blockquote><p>Config Controller is a bundle of the 3 following components:</p><ul><li><a href=https://cloud.google.com/anthos-config-management/docs/config-sync-overview>Config Sync</a> - to create what you need from a single source of truth</li><li><a href=https://cloud.google.com/anthos-config-management/docs/concepts/policy-controller>Policy Controller</a> - to enforce the security and compliance of your resource configurations</li><li><a href=https://cloud.google.com/config-connector/docs/overview>Config Connector</a> - to create GCP resources by using the <a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/architecture/resource-management.md>Kubernetes Resource Model (KRM)</a></li></ul><p><img src=https://raw.githubusercontent.com/mathieu-benoit/my-images/main/config-controller.png alt="Config Controller&amp;rsquo;s components."></p><p>Now, let&rsquo;s see this in action!</p><p><em>Note: for now, we will just illustrate Config Connector and Policy Controller, not yet Config Sync, but if you read until the end, you will find that pointer to my other blog article covering this GitOps story as a part 2 of this one.</em></p><p>Here is what we are going to accomplish:</p><ul><li><a href=#set-up-config-controller>Set up Config Controller</a></li><li><a href=#set-up-policies>Set up Policies</a></li><li><a href=#set-up-tenant-project>Set up Tenant project</a></li><li><a href=#set-up-configconnectorcontext-for-tenant-project>Set up ConfigConnectorContext for Tenant project</a></li><li><a href=#create-gcp-resources-in-tenant-project>Create GCP resources in Tenant project</a></li><li><a href=#further-considerations>Further considerations</a></li></ul><p>Here is what we are going to illustrate throughout this blog article:</p><p><img src=https://raw.githubusercontent.com/mathieu-benoit/my-images/main/config-controller-intro-flow.png alt="Config Controller flow with Config Connector and Policy Controller."></p><h2 id=set-up-config-controller>Set up Config Controller
<a href=#set-up-config-controller class=h-anchor aria-hidden=true>#</a></h2><blockquote><p>As Platform Admin, I want to create a Config Controller instance to provide a centralized place as a Kubernetes Server API endpoint in order to provision any GCP resources for my entire company.</p></blockquote><p>Enable the required API:</p><pre tabindex=0><code>CONFIG_CONTROLLER_PROJECT_ID=FIXME
gcloud config set project $CONFIG_CONTROLLER_PROJECT_ID
gcloud services enable krmapihosting.googleapis.com \
    cloudresourcemanager.googleapis.com
</code></pre><p>Create a Config Controller instance:</p><pre tabindex=0><code>CONFIG_CONTROLLER_NAME=FIXME
CONFIG_CONTROLLER_LOCATION=us-east1 # or us-central1 are supported for now
LOCAL_IP_ADDRESS=$(curl ifconfig.co) # Change this if needed to properly get your local IP address
gcloud anthos config controller create $CONFIG_CONTROLLER_NAME \
    --location=$CONFIG_CONTROLLER_LOCATION \
    --man-block $LOCAL_IP_ADDRESS/32
</code></pre><p><em>Note: by default the Master Authorized Network (<code>--man-block</code>) is configured with <code>0.0.0.0/0</code>, we just limited the access to the Kubernetes API Server to our local IP address to add more security.</em></p><p>From here, it will take 15+ min to provision the Config Controller instance. Once provisioned you could check its status:</p><pre tabindex=0><code>gcloud anthos config controller list \
    --location=$CONFIG_CONTROLLER_LOCATION
gcloud anthos config controller describe $CONFIG_CONTROLLER_NAME \
    --location=$CONFIG_CONTROLLER_LOCATION
</code></pre><h2 id=set-up-policies>Set up Policies
<a href=#set-up-policies class=h-anchor aria-hidden=true>#</a></h2><blockquote><p>As Platform Admin, I want to set up policies in order to control what&rsquo;s deployed and have in place common best practices and compliances accross my company.</p></blockquote><p>You could <a href=https://cloud.google.com/anthos-config-management/docs/how-to/write-a-constraint-template>create your own <code>ConstraintTemplate</code></a>, but you could also reuse the <code>ConstraintTemplates</code> already installed by default for you (see the output of <code>kubectl get constrainttemplates</code>).</p><p>Let&rsquo;s for example make sure that any <code>Namespace</code> has a label <code>owner</code>:</p><pre tabindex=0><code>cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: ns-must-have-owner
spec:
  match:
    kinds:
      - apiGroups: [&#34;&#34;]
        kinds: [&#34;Namespace&#34;]
  parameters:
    labels:
      - key: &#34;owner&#34;
EOF
</code></pre><p>Another example could be to only allow a specific list of locations where the GCP Storage buckets could be provisioned:</p><pre tabindex=0><code>cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: GCPStorageLocationConstraintV1
metadata:
  name: gcp-storage-location-restriction
spec:
  match:
    kinds:
    - apiGroups:
      - storage.cnrm.cloud.google.com
      kinds:
      - StorageBucket
  parameters:
    locations:
      - us-east1
EOF
</code></pre><h2 id=set-up-tenant-project>Set up Tenant project
<a href=#set-up-tenant-project class=h-anchor aria-hidden=true>#</a></h2><blockquote><p>As Platform Admin, I want to set up a dedicated namespace and GCP project to onboard a specific project for a specific team.</p></blockquote><p>By default, you could deploy any GCP resources in the GCP project where your Config Controller is deployed. For doing so, you need to grant the Config Controller&rsquo;s service account (<code>kubectl get ConfigConnectorContext -n config-control -o jsonpath='{.items[0].spec.googleServiceAccount}'</code>) the proper GCP roles and deploy your Kubernetes manifests in the <code>config-control</code> namespace.</p><p>But here what we want to do is to create a dedicated namespace and project for each team/project where associated GCP resources will be deployed in. We are leveraging the <a href=https://cloud.google.com/config-connector/docs/how-to/advanced-install#project-namespace><em>namespaced mode</em> of Config Connector</a>, and we will configure it in order to manage resources in namespaces.</p><p>First, we need to grant the Config Controller&rsquo;s service account the proper roles. In our case we want to create different projects and assign them the right billing account:</p><pre tabindex=0><code>gcloud services enable cloudbilling.googleapis.com --project ${CONFIG_CONTROLLER_PROJECT_ID}
CONFIG_CONTROLLER_SA=&#34;$(kubectl get ConfigConnectorContext -n config-control -o jsonpath=&#39;{.items[0].spec.googleServiceAccount}&#39;)&#34;
ORG_ID=FIXME
BILLING_ACCOUNT_ID=FIXME
gcloud organizations add-iam-policy-binding ${ORG_ID} \
    --member=&#34;serviceAccount:${CONFIG_CONTROLLER_SA}&#34; \
    --role=&#39;roles/resourcemanager.projectCreator&#39;
gcloud organizations add-iam-policy-binding ${ORG_ID} \
    --member=&#34;serviceAccount:${CONFIG_CONTROLLER_SA}&#34; \
    --role=&#39;roles/billing.projectManager&#39;
gcloud beta billing accounts add-iam-policy-binding ${BILLING_ACCOUNT_ID} \
    --member=&#34;serviceAccount:${CONFIG_CONTROLLER_SA}&#34; \
    --role=&#39;roles/billing.user&#39;
gcloud projects add-iam-policy-binding ${CONFIG_CONTROLLER_PROJECT_ID} \
    --member=&#34;serviceAccount:${CONFIG_CONTROLLER_SA}&#34; \
    --role=&#39;roles/serviceusage.serviceUsageConsumer&#39;
gcloud projects add-iam-policy-binding ${CONFIG_CONTROLLER_PROJECT_ID} \
    --member=&#34;serviceAccount:${CONFIG_CONTROLLER_SA}&#34; \
    --role=&#39;roles/iam.serviceAccountAdmin&#39;
</code></pre><p>Then we need to create the tenant <a href=https://cloud.google.com/config-connector/docs/reference/resource-docs/resourcemanager/project>project</a> in the <code>config-control</code> namespace:</p><pre tabindex=0><code>RANDOM_SUFFIX=$(shuf -i 100-999 -n 1)
TENANT_PROJECT_ID=tenant-$RANDOM_SUFFIX # should be unique
cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
kind: Project
metadata:
  annotations:
    cnrm.cloud.google.com/auto-create-network: &#34;false&#34;
  name: ${TENANT_PROJECT_ID}
  namespace: config-control
spec:
  name: ${TENANT_PROJECT_ID}
  billingAccountRef:
    external: &#34;${BILLING_ACCOUNT_ID}&#34;
  organizationRef:
    external: &#34;${ORG_ID}&#34;
  resourceID: ${TENANT_PROJECT_ID}
EOF
</code></pre><p>Check that the project is successfully created: <code>kubectl wait --for=condition=READY project $TENANT_PROJECT_ID -n config-control</code>.</p><p><em>Note: The tenant project was created at the organization level, but it&rsquo;s also possible to create this tenant project in a folder, see reference <a href=https://cloud.google.com/config-connector/docs/reference/resource-docs/resourcemanager/project>here</a>.</em></p><p>Now what we need to do is to create a dedicated GCP service account for this project, still in the <code>config-control</code> namespace:</p><pre tabindex=0><code>cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMServiceAccount
metadata:
  name: ${TENANT_PROJECT_ID}
  namespace: config-control
spec:
  displayName: ${TENANT_PROJECT_ID}
---
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPartialPolicy
metadata:
  name: ${TENANT_PROJECT_ID}-sa-workload-identity-binding
  namespace: config-control
spec:
  resourceRef:
    name: ${TENANT_PROJECT_ID}
    apiVersion: iam.cnrm.cloud.google.com/v1beta1
    kind: IAMServiceAccount
  bindings:
    - role: roles/iam.workloadIdentityUser
      members:
        - member: serviceAccount:${CONFIG_CONTROLLER_PROJECT_ID}.svc.id.goog[cnrm-system/cnrm-controller-manager-${TENANT_PROJECT_ID}]
EOF
</code></pre><h2 id=set-up-configconnectorcontext-for-tenant-project>Set up ConfigConnectorContext for Tenant project
<a href=#set-up-configconnectorcontext-for-tenant-project class=h-anchor aria-hidden=true>#</a></h2><p>The Tenant project namespace needs its own <code>ConfigConnectorContext</code> resource in order to invoke its dedicated GCP service account:</p><pre tabindex=0><code>cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  annotations:
    cnrm.cloud.google.com/project-id: ${TENANT_PROJECT_ID}
  labels:
    owner: ${TENANT_PROJECT_ID}
  name: ${TENANT_PROJECT_ID}
---
apiVersion: core.cnrm.cloud.google.com/v1beta1
kind: ConfigConnectorContext
metadata:
  name: configconnectorcontext.core.cnrm.cloud.google.com
  namespace: ${TENANT_PROJECT_ID}
spec:
  googleServiceAccount: ${TENANT_PROJECT_ID}@${CONFIG_CONTROLLER_PROJECT_ID}.iam.gserviceaccount.com
EOF
</code></pre><h2 id=create-gcp-resources-in-tenant-project>Create GCP resources in Tenant project
<a href=#create-gcp-resources-in-tenant-project class=h-anchor aria-hidden=true>#</a></h2><p>Before actually provisioning a GCP Storage Bucket, we need to grant the <code>storage.admin</code> role to the Tenant project&rsquo;s service account via an <a href=https://cloud.google.com/config-connector/docs/reference/resource-docs/iam/iampolicymember><code>IAMPolicyMember</code></a> resource deployed in the <code>config-control</code> namespace (where this service account is):</p><pre tabindex=0><code>cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: ${TENANT_PROJECT_ID}-storage-admin
  namespace: config-control
spec:
  member: serviceAccount:${TENANT_PROJECT_ID}@${CONFIG_CONTROLLER_PROJECT_ID}.iam.gserviceaccount.com
  role: roles/storage.admin
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    external: projects/${TENANT_PROJECT_ID}
EOF
</code></pre><blockquote><p>As Tenant project Ops, I want to deploy GCP resources in my Tenant project.</p></blockquote><p>Now let&rsquo;s provision the GCP Storage Bucket in the Tenant project&rsquo;s namespace via a <a href=https://cloud.google.com/config-connector/docs/reference/resource-docs/storage/storagebucket><code>StorageBucket</code></a> resource:</p><pre tabindex=0><code>cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: storage.cnrm.cloud.google.com/v1beta1
kind: StorageBucket
metadata:
  annotations:
    cnrm.cloud.google.com/force-destroy: &#34;false&#34;
  name: ${TENANT_PROJECT_ID}
  namespace: ${TENANT_PROJECT_ID}
spec:
  location: us-east1
  uniformBucketLevelAccess: true
EOF
</code></pre><p>You could check that this GCP Storage bucket has been created successfully with <code>kubectl get StorageBucket -n ${TENANT_PROJECT_ID}</code> and <code>gsutil ls -p ${TENANT_PROJECT_ID}</code>.</p><p>Congrats! You made it! You have set up a platform with Config Controller to securely deploy GCP resources via a platform for your teams/projects.</p><h2 id=further-considerations>Further considerations
<a href=#further-considerations class=h-anchor aria-hidden=true>#</a></h2><ul><li><a href=https://cloud.google.com/config-connector/docs/reference/overview>Config Connector resources</a></li><li><a href=https://cloud.google.com/anthos-config-management/docs/reference/constraint-template-library>Policy Controller constraint template library</a></li><li><a href=https://cloud.google.com/anthos-config-management/docs/concepts/blueprints>KRM Blueprints</a></li></ul><p>So, that was part 1, are you ready for part 2 to see how to set up a GitOps approach with all of that thanks to Config Controller? If yes, <a href=https://mathieu-benoit.github.io/myblog.io/posts/2022/02/config-controller-gitops/>check this out</a>!</p><p>Hope you enjoyed that one, happy sailing! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2022/02/config-controller-gitops/><span class=button__icon>←</span>
<span class=button__text>gitops with config controller</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2022/01/workload-identity-federation/><span class=button__text>keyless gcp authentication from github actions with workload identity federation</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>