<!doctype html><html lang=en><head><title>gitops with config controller ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="So, with the previous article about Config Controller in action, you could ask these questions:
Ok, but that&amp;rsquo;s a lot of kubectl apply commands&amp;hellip; how to simplify this if I don&amp;rsquo;t have access to the Config Controller endpoint for security and networking reasons? I thought Config Controller includes Config Sync too in order to deploy Kubernetes manifests in a GitOps way? Exactly, spot on! The previous article was already full of content and concepts to show the power and goodies of Config Controller."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=mathieu-benoit.github.io/posts/2022/02/config-controller-gitops/><link rel=stylesheet href=mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=mathieu-benoit.github.io/img/favicon.png><link href=mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="gitops with config controller"><meta name=twitter:description content="let's see with config controller how we could set up a gitops approach to actually deploy kubernetes manifests"><meta property="og:title" content="gitops with config controller"><meta property="og:description" content="let's see with config controller how we could set up a gitops approach to actually deploy kubernetes manifests"><meta property="og:type" content="article"><meta property="og:url" content="mathieu-benoit.github.io/posts/2022/02/config-controller-gitops/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-15T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=mathieu-benoit.github.io/about/>about</a></li><li><a href=mathieu-benoit.github.io/presentations/>presentations</a></li><li><a href=mathieu-benoit.github.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=mathieu-benoit.github.io/about/>about</a></li><li><a href=mathieu-benoit.github.io/presentations/>presentations</a></li><li><a href=mathieu-benoit.github.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>gitops with config controller</h1><div class=post-meta><span class=post-date>2022-02-15</span></div><span class=post-tags><a href=mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/gitops/>#gitops</a>&nbsp;</span><div class=post-content><p>So, with the previous article about <a href=mathieu-benoit.github.io/posts/2022/02/config-controller-intro/>Config Controller in action</a>, you could ask these questions:</p><ul><li><em>Ok, but that&rsquo;s a lot of <code>kubectl apply</code> commands&mldr; how to simplify this if I don&rsquo;t have access to the Config Controller endpoint for security and networking reasons?</em></li><li><em>I thought Config Controller includes Config Sync too in order to deploy Kubernetes manifests in a GitOps way?</em></li></ul><p>Exactly, spot on! The previous article was already full of content and concepts to show the power and goodies of Config Controller. But glad you asked! Let&rsquo;s demonstrate this GitOps/Config Sync story now in this part 2! ;)</p><p>Here is what we are going to illustrate throughout this blog article:</p><p><img src=https://raw.githubusercontent.com/mathieu-benoit/my-images/main/config-controller-gitops-flow.png alt="Config Controller flow with Config Sync in addition to Config Connector and Policy Controller."></p><p>For this, we will cover two main parts in this article:</p><ul><li><a href=#set-up-the-platform-git-repo>Set up the Platform Git repo</a></li><li><a href=#set-up-the-tenant-project-git-repo>Set up the Tenant project Git repo</a></li></ul><p><em>Note: we are using GitHub throughout this article, but you could use different Git platform, see more information <a href=https://cloud.google.com/anthos-config-management/docs/how-to/installing-config-sync#git-creds-secret>here</a>.</em></p><h2 id=set-up-the-platform-git-repo>Set up the Platform Git repo
<a href=#set-up-the-platform-git-repo class=h-anchor aria-hidden=true>#</a></h2><blockquote><p>As a Platform Admin, I want to set up a repository where I store any configurations I want to apply to my Config Controller cluster: like policies, common configs, etc. accross my company.</p></blockquote><p>First, because Config Controller is a private GKE cluster, it doesn&rsquo;t have Internet access in egress. In order to have access from Config Sync to a GitHub repository, we need to set up Cloud NAT for the Config Controller cluster:</p><pre tabindex=0><code>CONFIG_CONTROLLER_NETWORK=$(gcloud anthos config controller describe $CONFIG_CONTROLLER_NAME \
    --location=$CONFIG_CONTROLLER_LOCATION \
    --format=&#39;get(network)&#39;)
gcloud compute routers create nat-router \
    --network $CONFIG_CONTROLLER_NETWORK \
    --region $CONFIG_CONTROLLER_LOCATION
gcloud compute routers nats create nat-config \
    --router-region $CONFIG_CONTROLLER_LOCATION \
    --router nat-router \
    --nat-all-subnet-ip-ranges \
    --auto-allocate-nat-external-ips
</code></pre><p>Then, we could configure Config Management to support multi-repositories for Config Sync:</p><pre tabindex=0><code>cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: configmanagement.gke.io/v1
kind: ConfigManagement
metadata:
  name: config-management
spec:
  enableMultiRepo: true
  policyController:
    enabled: true
    exemptableNamespaces: [&#34;cnrm-system&#34;,&#34;config-control&#34;]
EOF
kubectl wait --for condition=established crd rootsyncs.configsync.gke.io
</code></pre><p>Finally, we create a <code>RootSync</code> configuration to link a dedicated Git repo cluster-wide:</p><pre tabindex=0><code>PLATFORM_REPO_URL=https://github.com/mathieu-benoit/configcontroller-platform-repo #FIXME wity your own
cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: configsync.gke.io/v1beta1
kind: RootSync
metadata:
  name: root-sync
  namespace: config-management-system
spec:
  sourceFormat: unstructured
  git:
    repo: ${PLATFORM_REPO_URL}
    revision: HEAD
    branch: main
    dir: &#34;config-sync&#34;
    auth: none
EOF
</code></pre><p><em>Note: We are using <code>auth: none</code> because we are using a public Git repository, but <a href=https://cloud.google.com/anthos-config-management/docs/how-to/installing-config-sync#git-creds-secret>you could follow these instructions to properly set up Config Sync for private Git repositories</a>.</em></p><p>From here we could double-check that our Git repository is successfully synchronized:</p><pre tabindex=0><code>nomos status --contexts $(kubectl config current-context)
gcloud alpha anthos config sync repo list --targets config-controller
</code></pre><p>And that&rsquo;s it, we just set up the GitHub repository where the Platform Admin will drop any Kubernetes manifests they want deployed in their Config Controller cluster. All the <a href=mathieu-benoit.github.io/posts/2022/02/config-controller-intro/>files created in the part 1</a> are in this sample platform repo: <a href=https://github.com/mathieu-benoit/configcontroller-platform-repo/tree/main/config-sync>https://github.com/mathieu-benoit/configcontroller-platform-repo/tree/main/config-sync</a>, you could have a look to see the policies and other resources needed to properly setup the tenant project/namespace.</p><h2 id=set-up-the-tenant-project-git-repo>Set up the Tenant project Git repo
<a href=#set-up-the-tenant-project-git-repo class=h-anchor aria-hidden=true>#</a></h2><blockquote><p>As a Platform Admin, I want to set up a dedicated Git repository for a Tenant project.</p></blockquote><p>Let&rsquo;s actually see GitOps in action here, we will create the required files for this section, and then we will commit them into the Platform Git repository to eventually trigger Config Controller&rsquo;s Config Sync.</p><p>Clone the platform repository locally:</p><pre tabindex=0><code>cd ~
git clone $PLATFORM_REPO_URL
cd configcontroller-platform-repo/config-sync/projects/${TENANT_PROJECT_ID}/
</code></pre><p><em>Note: we are leveraging the <a href=https://cloud.google.com/anthos-config-management/docs/how-to/namespace-repositories>&ldquo;Control namespace repositories in the root repository&rdquo;</a> method here.</em></p><p>Create the <code>RepoSync</code> resource in the Tenant project namespace, to link the Tenant project Git repository to its dedicated Tenant project/namespace:</p><pre tabindex=0><code>TENANT_REPO_URL=https://github.com/mathieu-benoit/configcontroller-tenant-repo
cat &lt;&lt;EOF &gt; repo-sync-${TENANT_PROJECT_ID}.yaml
apiVersion: configsync.gke.io/v1beta1
kind: RepoSync
metadata:
  name: repo-sync
  namespace: ${TENANT_PROJECT_ID}
spec:
  sourceFormat: unstructured
  git:
   repo: ${TENANT_REPO_URL}
   revision: HEAD
   branch: main
   dir: &#34;config-sync&#34;
   auth: none
EOF
</code></pre><p>We also need to declare the associated <code>RoleBinding</code> in the Tenant project namespace:</p><pre tabindex=0><code>cat &lt;&lt;EOF &gt; repo-sync-role-binding-${TENANT_PROJECT_ID}.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: syncs-repo
  namespace: ${TENANT_PROJECT_ID}
subjects:
- kind: ServiceAccount
  name: ns-reconciler-${TENANT_PROJECT_ID}
  namespace: config-management-system
roleRef:
  kind: ClusterRole
  name: edit
  apiGroup: rbac.authorization.k8s.io
EOF
</code></pre><p><em>Note: For the <code>ClusterRole</code>&rsquo;s name field, the options could be seen <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles>here</a>.</em></p><p>Finally, let&rsquo;s commit these two files:</p><pre tabindex=0><code>git add .
git commit -m &#39;Setting up reposync resource for ${TENANT_PROJECT_ID}.&#39;
git push
</code></pre><p>From here we could double-check that both Git repositories are successfully synchronized:</p><pre tabindex=0><code>nomos status --contexts $(kubectl config current-context)
gcloud alpha anthos config sync repo list --targets config-controller
</code></pre><p>And that&rsquo;s it, that&rsquo;s a wrap! The Tenant project Ops hasn&rsquo;t done anything here (and that&rsquo;s the goal), it was all about the Platform admin to properly set up the environment for them. Tenant project Ops can now start do commits in their own Git repository to provision GCP resources. As an example, you could have a look at this sample Tenant project repository I set up: <a href=https://github.com/mathieu-benoit/configcontroller-tenant-repo/tree/main/config-sync>https://github.com/mathieu-benoit/configcontroller-tenant-repo/tree/main/config-sync</a>. So now the Tenant project team has the right setup to actually provision any GCP resources via Kubernetes manifests by placing them into this Git repository. With that, they will follow security and governance in place provided by the Platform admin. Sweet!</p><h2 id=complementary-and-further-resources>Complementary and further resources
<a href=#complementary-and-further-resources class=h-anchor aria-hidden=true>#</a></h2><ul><li><a href=mathieu-benoit.github.io/posts/2021/11/policy-controller-ci/>Add policies guardrails during Continuous Integration (CI) pipelines</a> - you could find a <a href=https://github.com/mathieu-benoit/configcontroller-platform-repo/blob/main/.github/workflows/ci.yml>specific example of this in the Platform repository</a>.</li><li><a href=https://cloud.google.com/anthos-config-management/docs/reference/rootsync-reposync-fields><code>RootSync</code> and <code>RepoSync</code> fields</a></li><li><a href=https://cloud.google.com/anthos-config-management/docs/how-to/monitor-rootsync-reposync>Monitor <code>RootSync</code> and <code>RepoSync</code> objects</a></li><li><a href=https://cloud.google.com/anthos-config-management/docs/how-to/use-repo-kustomize-helm>Config Sync and Kustomize & Helm</a></li></ul><p>Hope you enjoyed that one, cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=mathieu-benoit.github.io/posts/2022/08/oci-config-sync/><span class=button__icon>←</span>
<span class=button__text>gitops with oci artifacts and config sync</span></a></span>
<span class="button next"><a href=mathieu-benoit.github.io/posts/2022/02/config-controller-intro/><span class=button__text>config controller in action</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=mathieu-benoit.github.io/assets/main.js></script>
<script src=mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>