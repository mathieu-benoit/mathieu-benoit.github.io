<!doctype html><html lang=en><head><title>ci/cd pipeline with azure devops to deploy any apps on kubernetes ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Back in October 1st 2018, I published Azure DevOps to deploy your apps/services into a Kubernetes cluster, then I updated it on October 12th 2018 with Helm charts repository with Azure Container Registry, to finally published on November 27th 2018 a more generic and professional one in the official Microsoft Open Source blog: Tutorial: Using Azure DevOps to setup a CI/CD pipeline and deploy to Kubernetes. Enventually the latter got a major refresh on November 2019 (few information of this current blog article may differ though)."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2019/07/azure-pipelines-for-k8s/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="ci/cd pipeline with azure devops to deploy any apps on kubernetes"><meta name=twitter:description content="let's build and deploy a containerized app in kubernetes via azure pipelines"><meta property="og:title" content="ci/cd pipeline with azure devops to deploy any apps on kubernetes"><meta property="og:description" content="let's build and deploy a containerized app in kubernetes via azure pipelines"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2019/07/azure-pipelines-for-k8s/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-10T00:00:00+00:00"><meta property="article:modified_time" content="2019-07-10T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>ci/cd pipeline with azure devops to deploy any apps on kubernetes</h1><div class=post-meta><span class=post-date>2019-07-10</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/azure/>#azure</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/azure-devops/>#azure-devops</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;</span><div class=post-content><p>Back in October 1st 2018, I published <a href=https://alwaysupalwayson.blogspot.com/2018/10/azure-devops-to-deploy-your.html>Azure DevOps to deploy your apps/services into a Kubernetes cluster</a>, then I updated it on October 12th 2018 with <a href=https://alwaysupalwayson.blogspot.com/2018/10/helm-charts-repository-with-azure.html>Helm charts repository with Azure Container Registry</a>, to finally published on November 27th 2018 a more generic and professional one in the official Microsoft Open Source blog: <a href=https://cloudblogs.microsoft.com/opensource/2018/11/27/tutorial-azure-devops-setup-cicd-pipeline-kubernetes-docker-helm>Tutorial: Using Azure DevOps to setup a CI/CD pipeline and deploy to Kubernetes</a>. Enventually the latter got a major refresh on November 2019 (few information of this current blog article may differ though).</p><p>I got great feedback from customers and colleagues which brought to my attention few ideas of improvements.</p><p>Today, I would like to walk you through 4 improvements I have made:</p><ol><li>Helm chart versioning improvement</li><li>Specific Service Principal to deploy apps in AKS</li><li>YAML definition for both the Build and the Release pipelines</li><li>Azure Key Vault to store and retrieve secrets throughout the CI/CD pipeline</li></ol><p>The workflow is now:</p><p><img src=https://1.bp.blogspot.com/-ahnbFR-xLbc/XQrcr5v5oII/AAAAAAAATO0/Eqmr-lefZx4uf_Bhwz7z2bhVDzaKd97MACLcBGAs/s640/Picture2.png alt="Architecture diagram showing the worklflow of the different steps and components such as Source repository, to the build, to the release into AKS going through the container registry."></p><h1 id=1-helm-chart-versioning-improvement>1. Helm chart versioning improvement
<a href=#1-helm-chart-versioning-improvement class=h-anchor aria-hidden=true>#</a></h1><p>Again I got great feedback from my original blog article, here is the story about how I have improved the Helm chart versioning: <a href=https://mathieu-benoit.github.io/posts/2019/07/ci-cd-with-helm-chart/>Helm chart management in CI/CD with ACR and Azure DevOps</a>.</p><h1 id=2-specific-service-principal-to-deploy-apps-in-aks>2. Specific Service Principal to deploy apps in AKS
<a href=#2-specific-service-principal-to-deploy-apps-in-aks class=h-anchor aria-hidden=true>#</a></h1><p>From Azure DevOps pipelines we need to get access to the AKS cluster to be able then to deploy our Helm chart. Typically we will get the kubeconfig file to be able to run the helm upgrade command. To do so we will need to do az login and then az aks get-credendials.
Furthermore, we would like to respect the Least privilege Security Principle <a href=https://docs.microsoft.com/azure/aks/control-kubeconfig-access>by restricting the role and scope of the associated Service Principal</a>. Here is how you will achieve that:</p><pre tabindex=0><code>aksSpSecret=$(az ad sp create-for-rbac -n aks-sp --skip-assignment --query password -o tsv)  
aksSpId=$(az ad sp show --id http://aks-sp --query appId -o tsv)  
aks=_&lt;your-aks-cluster-name&gt;_  
aksId=$(az aks show -g $aks -n $aks --query id)  
az role assignment create --assignee $aksSpId --role &#34;Azure Kubernetes Service Cluster User Role&#34; --scope aksId  
aksSpTenantId=$(az account show --query tenantId -o tsv)  
</code></pre><p>We will use those values later.</p><p><em>Note: previously we were using a Kubernetes Service Endpoint which typically allows you to provide the kubeconfig or create for you a Service Principal but Contributor on a specific Resource Group or at the Subscription level.</em></p><h1 id=3-yaml-definition-for-both-the-build-and-the-release-pipelines>3. YAML definition for both the Build and the Release pipelines
<a href=#3-yaml-definition-for-both-the-build-and-the-release-pipelines class=h-anchor aria-hidden=true>#</a></h1><p><a href=https://devblogs.microsoft.com/devops/whats-new-with-azure-pipelines/>Since Multi-Stage pipeline is supported with the YAML definition</a> we could now integrate our Release definition and our Build definition with our Azure pipelines.
On that regard, we will have 4 files:</p><ul><li><a href=https://github.com/Azure/phippyandfriends/blob/master/phippy/ci-pipeline.yml>ci-pipeline.yml</a> and <a href=https://github.com/Azure/phippyandfriends/blob/master/phippy/cd-pipeline.yml>cd-pipeline.yml</a>, which will define the entire CI/CD pipeline with 3 Stages: Build, Development and Production</li><li><a href=https://github.com/Azure/phippyandfriends/blob/master/common/ci-steps-template.yml>ci-steps-template.yml</a>, acting as the template for the Build steps (CI)</li><li><a href=https://github.com/Azure/phippyandfriends/blob/master/common/cd-steps-template.yml>cd-steps-template.yml</a>, acting as the template for the Release steps (CD - Development and Production)</li></ul><p><img src=https://1.bp.blogspot.com/-4StA1t_kQCA/XR6j-7ybn4I/AAAAAAAATUA/eP0yN6k4R80l_p3aeT3-EiHTk0sp37J5gCLcBGAs/s640/Capture.PNG alt="Screenshot of the summary of successfull run of an Azure Pipeline showing the 3 stages: Build, Development and Production."></p><p>TIPS: you could leverage the <a href=https://devblogs.microsoft.com/devops/using-azure-devops-from-the-command-line>Azure DevOps CLI</a> to create your Azure pipeline definition based on this YAML file: <code>az pipelines create --yml-path</code>.</p><h1 id=4-azure-key-vault-to-store-and-retrieve-the-secrets>4. Azure Key Vault to store and retrieve the secrets
<a href=#4-azure-key-vault-to-store-and-retrieve-the-secrets class=h-anchor aria-hidden=true>#</a></h1><p>Here the goal is to store secrets needed throughout the CI/CD pipeline in Azure Key Vault to be more secure.</p><pre tabindex=0><code>rg=&lt;your-rg&gt;
kv=&lt;your-kv&gt;
subscriptionId=$(az account show --query id -o tsv)
tenantId=$(az account show --query tenantId -o tsv)

# Create an Azure Key Vault instance
az group create -n $rg -l $location
az keyvault create -l $location -n $kv -g $rg
  
# Create a Service Principal which will be able to read the secrets from that specific Azure Key Vault
kvSpSecret=$(az ad sp create-for-rbac -n $kv --skip-assignment --query password -o tsv)
kvSpId=$(az ad sp show --id http://$kv --query appId -o tsv)
kvId=$(az keyvault show -n $kv --query id -o tsv)
az role assignment create --assignee $kvSpId --role Reader --scope $kvId
  
# Add the specific policies to this Service Principal  
az keyvault set-policy -n $kv --spn $kvSpId --secret-permissions get list
</code></pre><p>TIPS: you could leverage the <a href=https://devblogs.microsoft.com/devops/using-azure-devops-from-the-command-line>Azure DevOps CLI</a> to create your Service Endpoint based on this specific Service Principal created for your Azure Key Vault:</p><pre tabindex=0><code>az devops service-endpoint create \
    --authorization-scheme ServicePrincipal \
    --service-endpoint-type azurerm \
    --azure-rm-service-principal-id $kvSpId \
    --azure-rm-subscription-id $subscriptionId \
    --azure-rm-tenant-id $tenantId
  
# Now let&#39;s add our secrets into our Azure Key Vault for our Development Environment (for other Environments like Production, you could repeat the exact same way accordingly)  
az keyvault secret set --vault-name $kv -n dev-aksSpTenantId --value $tenantId  
az keyvault secret set --vault-name $kv -n dev-aksSpId --value $aksSpId  
az keyvault secret set --vault-name $kv -n dev-aksSpSecret --value $aksSpSecret  
</code></pre><p>Note: You could also store your Azure Container Registry login and password (see the <a href=https://cloudblogs.microsoft.com/opensource/2018/11/27/tutorial-azure-devops-setup-cicd-pipeline-kubernetes-docker-helm>original blog article</a> to see how to get them).</p><p>From there, you could now create a <a href=https://docs.microsoft.com/azure/devops/pipelines/library/variable-groups#link-secrets-from-an-azure-key-vault>Variable Group in Azure DevOps linked to this Azure Key Vault</a> by leveraging this Service Principal just created.</p><p><img src=https://1.bp.blogspot.com/-iPmxCkZX2a4/XSYEdoFEmwI/AAAAAAAATWU/AVTMPPZYijAABiNT_Z897KGStYdVR3cOwCLcBGAs/s640/Capture2.PNG alt="Screenshot of the Variable Groups tab in the Phippy&amp;rsquo;s build definition in Azure Pipelines."></p><p>And voila, for today!</p><p>Throughout this blob article, we were able to add more security in our CI/CD pipeline by storing our Secrets into Azure Key Vault and by following the Least Privilege Security Principle, we rigorously improved our Helm chart versioning as well as we leveraged the multi-stage definition as YAML file to gain in automation with Configuration-as-Code.</p><p>Hope you enjoyed this blog article and hope you are able to leverage and adapt it for your own needs and context.</p><p>Cheers! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2019/08/az-500/><span class=button__icon>←</span>
<span class=button__text>my preparation for exam az-500, microsoft azure security technologies</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2019/07/ci-cd-with-helm-chart/><span class=button__text>helm chart management in ci/cd with acr and azure devops</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>