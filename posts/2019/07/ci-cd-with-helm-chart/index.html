<!doctype html><html lang=en><head><title>helm chart management in ci/cd with acr and azure devops ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I recently got an interesting comment on my blog article Tutorial: Using Azure DevOps to setup a CI/CD pipeline and deploy to Kubernetes:
Hi, I am trying to use Helm in CICD pipeline in Azure DevOps. I was going through lot of nice articles about this and this one is really great, but to be honest I am little bit confused about versioning of Helm package and push to repository with each build run."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog/posts/2019/07/ci-cd-with-helm-chart/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="helm chart management in ci/cd with acr and azure devops"><meta name=twitter:description content="let's do ci/cd with your own helm charts, acr and aks via azure pipelines"><meta property="og:title" content="helm chart management in ci/cd with acr and azure devops"><meta property="og:description" content="let's do ci/cd with your own helm charts, acr and aks via azure pipelines"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog/posts/2019/07/ci-cd-with-helm-chart/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-01T00:00:00+00:00"><meta property="article:modified_time" content="2019-07-01T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog/about/>about</a></li><li><a href=/myblog/presentations/>presentations</a></li><li><a href=/myblog/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog/about/>about</a></li><li><a href=/myblog/presentations/>presentations</a></li><li><a href=/myblog/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>helm chart management in ci/cd with acr and azure devops</h1><div class=post-meta><span class=post-date>2019-07-01</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog/tags/azure/>#azure</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/azure-devops/>#azure-devops</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/containers/>#containers</a>&nbsp;</span><div class=post-content><p>I recently got an interesting comment on my blog article <a href=https://cloudblogs.microsoft.com/opensource/2018/11/27/tutorial-azure-devops-setup-cicd-pipeline-kubernetes-docker-helm>Tutorial: Using Azure DevOps to setup a CI/CD pipeline and deploy to Kubernetes</a>:</p><blockquote><p><em>Hi, I am trying to use Helm in CICD pipeline in Azure DevOps. I was going through lot of nice articles about this and this one is really great, but to be honest I am little bit confused about versioning of Helm package and push to repository with each build run. It means, that with each build I need to push same version of Helm chart? Maybe only one change logically in appVersion have to be increased. For me it does not make sense, because in helm doc is written that version and appVersion are different properties. What is the best strategy for this? I am thinking about strategy to have just chart in specific version and use this exact same version until I will need to do changes in chart. Our infra is on Azure and Azure DevOps. The most suitable use case for me is this one, but as I said the only one think against to it is push helm chart for each build. Could you please help? I don&rsquo;t want to create some antipattern ;)</em></p></blockquote><p>Fair enough. Indeed, it&rsquo;s a very valid point. <strong>Firstly</strong>, I&rsquo;m not using the <a href=https://helm.sh/docs/developing_charts/#charts-and-versioning>recommended approach for the Helm chart version</a>, I&rsquo;m using <em>on-purpose</em> the build.buildId instead. <strong>Secondly</strong>, the Helm chart is built every time there is a new build, even if there is no changes with the Helm templates.</p><p>With this blog article today I would like to go through the implementation I would do to take into account those 2 points with Azure DevOps.</p><h1 id=1-build-definition>1. Build definition
<a href=#1-build-definition class=h-anchor aria-hidden=true>#</a></h1><p>Here is how the commands helm package and az acr helm push look like now:</p><pre tabindex=0><code>- bash: |
    helm package \
        $(system.defaultWorkingDirectory)/$(projectName)/charts/$(projectName)
  displayName: &#39;helm package&#39;
- bash: |
    chartPackage=$(ls $(projectName)-*.tgz)
    chartVersion=$(echo $(basename $chartPackage) | egrep -o &#39;[0-9].*[0-9]&#39;)
    chartVersionAlreadyExists=$(az acr helm list \
                                    -n $(registryName) \
                                    -u $(registryLogin) \
                                    -p $(registryPassword) \
                                    --query &#34;$(projectName)[?version==&#39;$chartVersion&#39;].version&#34; \
                                    -o tsv)
    if [ &#34;$chartVersion&#34; != &#34;$chartVersionAlreadyExists&#34; ]; then
        az acr helm push \
            -n $(registryName) \
            -u $(registryLogin) \
            -p $(registryPassword) \
            $chartPackage
    fi
    echo $(jq -n --arg version &#34;$chartVersion&#34; &#39;{helmChartVersion: $version}&#39;) &gt; $(build.artifactStagingDirectory)/variables.json
  name: helmPush
  displayName: &#39;az acr helm push&#39;
- publish: $(build.artifactStagingDirectory)
  artifact: build-artifact
</code></pre><p>What has changed?</p><ul><li>I&rsquo;m not using anymore <code>--version</code> while running helm package to be now able to leverage the version which resides in the <code>Chart.yaml</code> file. This version is not anymore <code>build.buildId</code> and is now managed directly from source control with that file. Again <a href=https://helm.sh/docs/developing_charts/#charts-and-versioning>that&rsquo;s the recommendation according to the Helm documentation</a>.</li><li>Before running az acr helm push, I need to check if the Helm chart version already exists otherwise I will have an error on that regard, I don&rsquo;t want that. There is also a <code>--force</code> parameter but I don&rsquo;t want to overwrite the previous entry with the same value, if someone forgot to change the version in the <code>Chart.yaml</code> file, it will override a previous value&mldr; could be dangerous.</li><li>Finally, I&rsquo;m exposing the <code>helmChartVersion</code> value in a file then shared via an Azure pipeline artifact <code>build-artifact</code>, <a href=https://mathieu-benoit.github.io/myblog/posts/2019/06/azure-pipelines-stages-variables/>see here why I&rsquo;m doing that like this</a>.</li></ul><h1 id=2-release-definition>2. Release definition
<a href=#2-release-definition class=h-anchor aria-hidden=true>#</a></h1><p>Here is how the commands helm upgrade looks like now:</p><pre tabindex=0><code>- download: current
  artifact: build-artifact
- bash: |
    helmChartVersion=$(jq .helmChartVersion $(pipeline.workspace)/build-artifact/variables.json -r)
    helm upgrade \
        --namespace $(k8sNamespace) \
        --install \
        --wait \
        --version $helmChartVersion \
        --set image.repository=$(registryServerName)/$(projectName) \
        --set image.tag=$(build.buildId) \
        $(projectName) \
        $(registryName)/$(projectName)
  displayName: &#39;deploy helm chart&#39;
</code></pre><p>What has changed?</p><ul><li>I added a task to <code>download</code> the file exposed via my <code>build-artifact</code>, then I will extract the value of the <code>helmChartVersion</code> with <code>jq</code>.</li><li>And I&rsquo;m now using the actual <code>helmChartVersion</code> instead of <code>build.buildId</code> previously while running <code>helm upgrade --version</code>.</li></ul><p>That&rsquo;s it, that&rsquo;s how I would do that. Now the Helm chart version is driven by the value included in the Chart.yaml. What about you? How are you doing this? Let me know if you see some improvements here, would love to fine-tune this approach!</p><p>Cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog/posts/2019/07/azure-pipelines-for-k8s/><span class=button__icon>←</span>
<span class=button__text>ci/cd pipeline with azure devops to deploy any apps on kubernetes</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog/posts/2019/06/keda/><span class=button__text>keda, event-driven containers for Kubernetes</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>