<!doctype html><html lang=en><head><title>my second week with gcp ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Since last week and to continue the beginning of my learning journey with GCP, this week I would like to deep dive with GKE, around few advanced setup and features.
First I needed to complete the setup of this blog on GKE by setting up my SSL certificate and map my DNS https://alwaysupalwayson.com with the new Public IP address exposed. To accomplish this I&amp;rsquo;m using the Google-managed SSL certificates (which is still in Beta as we speak)."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2020/08/second-week-with-gcp/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="my second week with gcp"><meta name=twitter:description content="let's share some learnings during my second week leveraging gcp, focused on gke"><meta property="og:title" content="my second week with gcp"><meta property="og:description" content="let's share some learnings during my second week leveraging gcp, focused on gke"><meta property="og:type" content="article"><meta property="og:url" content="/posts/2020/08/second-week-with-gcp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-03T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-03T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>my second week with gcp</h1><div class=post-meta><span class=post-date>2020-08-03</span></div><span class=post-tags><a href=/tags/gcp/>#gcp</a>&nbsp;
<a href=/tags/security/>#security</a>&nbsp;
<a href=/tags/kubernetes/>#kubernetes</a>&nbsp;</span><div class=post-content><p>Since <a href=/posts/2020/07/first-week-with-gcp/>last week</a> and to continue the beginning of my learning journey with GCP, this week I would like to deep dive with GKE, around few advanced setup and features.</p><p>First I needed to complete the setup of this blog on GKE by setting up my SSL certificate and map my DNS <a href=https://alwaysupalwayson.com>https://alwaysupalwayson.com</a> with the new Public IP address exposed. To accomplish this I&rsquo;m using the <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs>Google-managed SSL certificates</a> (which is still in Beta as we speak). Pretty straight forward by following the tutorial. I just needed to align the version of my cluster and the version of the Managed Certificates feature:</p><ul><li>&lt; <code>1.16.5-gke.1</code> = <code>v1beta1</code></li><li>>= <code>1.16.5-gke.1</code> = <code>v1beta2</code></li></ul><p>Create a Public static IP address:</p><pre tabindex=0><code>staticIpName=myblog-static-ip
gcloud compute addresses create $staticIpName \
    --global
staticIpAddress=$(gcloud compute addresses describe $staticIpName \
    --global \
    --format &#34;value(address)&#34;)
</code></pre><p>Grab this <code>$staticIpAddress</code> variable value and put it on my DNS where I host my domain name, it will guarantee that I own that domain for the following steps.
Then, I need to expose <code>myblog</code> with a <code>NodePort</code> Service:</p><pre tabindex=0><code>$projectId=FIXME
kubectl run myblog \
    --image=$imageName \
    --generator=run-pod/v1
kubectl expose pod myblog \
    --type NodePort \
    --port=8080 \
    --target-port=8080
</code></pre><p>Create the <code>ManagedCertificate</code> resource:</p><pre tabindex=0><code>domainName=FIXME
kubectl apply -f - &lt;&lt;EOF
apiVersion: networking.gke.io/v1beta2
kind: ManagedCertificate
metadata:
  name: myblog
spec:
  domains:
    - $domainName
EOF
</code></pre><p>And then, create the associated <code>Ingress</code> resource:</p><pre tabindex=0><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: myblog
  annotations:
    kubernetes.io/ingress.global-static-ip-name: $staticIpName
    networking.gke.io/managed-certificates: myblog
spec:
  backend:
    serviceName: myblog
    servicePort: 8080
EOF
</code></pre><p>After waiting for few minutes for the load balancer and the certificate to be provisioned, here we are, that&rsquo;s it! 🤘 I have now <code>myblog</code> up-and-running with an SSL certificate configured: <a href=https://alwaysupalwayson.com>https://alwaysupalwayson.com</a> 🚀</p><p>That&rsquo;s cool, but now let&rsquo;s get more insights around the features of my current GKE cluster:</p><pre tabindex=0><code>gcloud container clusters describe $clusterName \
    --zone $zone
</code></pre><p><code>addonsConfig.kubernetesDashboard.disabled: true</code>, having the Kubernetes dashboard disabled by default is good practice on a security standpoint. If you need more UI interactions with your GKE clusters you could securely leverage the <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-workloads-overview#console>GKE Workloads menu in Cloud Console</a>.</p><p><code>addonsConfig.networkPolicyConfig.disabled: true</code>, <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/network-policy>Network Policies</a> is an important feature for your Security Posture with Kubernetes. By default it&rsquo;s not enabled, but good news, you could enable/disable Network Policy (Calico) on your GKE cluster without recreating your cluster: <code>gcloud container clusters update --update-addons=NetworkPolicy=ENABLED</code> or <code>gcloud container clusters update --enable-network-policy</code>. We could then apply few Network Policies like illustrated <a href=/posts/2019/09/calico/>here</a>.</p><p><code>currentMasterVersion</code> and <code>currentNodeVersion</code>, you could <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels>learn more about Release channel</a>: <code>none</code>, <code>rapid</code>, <code>regular</code> or <code>stable</code>. <code>regular</code> is the default one, and <code>stable</code> is the one eligible for the <a href=https://cloud.google.com/kubernetes-engine/sla>GKE&rsquo;s SLA</a>. This Release Channel is how you could manage your GKE&rsquo;s version (master versus worker nodes, auto-upgrade, etc.). Complementary to this, we could see that <code>management.autoUpgrade: true</code> is by default, which is really great and important. <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/maintenance-windows-and-exclusions>Maintenance windows and exclustions</a> features will bring flexibility and fine-grained control with your upgrades.
<em>Note: There is also the concept of <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/alpha-clusters>Alpha clusters</a>.</em></p><p><code>databaseEncryption.state: DECRYPTED</code>, you have the <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/encrypting-secrets>option to encrypt your Kubernetes&rsquo; Secrets (etcd) with your own key via Cloud KMS</a>.</p><p><code>location</code> and <code>zone</code>: there is <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/types-of-clusters#availability>3 choices regarding the availability</a> of your cluster: Single-zone, Multi-zonal or Regional. If you choose a Region with 3 Zones, your will have the control plane nodes as well as the number of your nodes replicated on the 3 zones of that region. The choice to make your cluster Regional or Zonal will influence the <a href=https://cloud.google.com/kubernetes-engine/sla>GKE&rsquo;s SLA</a> too.</p><p><code>diskType: pd-standard</code>, for better performance for your workloads, but with a cost, you may want to opt-in for a <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/custom-boot-disks>custom boot disk with SSD</a>: <code>pd-ssd</code>.</p><p><code>machine-type: n1-standard-1</code> is by default with 1vCPU and 3.75GB memory (FYI: <a href=https://cloud.google.com/kubernetes-engine/docs/release-notes#july_28_2020_r25>soon it will be <code>e2-medium</code></a>). I found very interesting this session <a href="https://cloud.withgoogle.com/next/sf/sessions?session=CMP102">Choosing the Right Compute Engine Instance Type for Your Workload</a> to see the differences between the <a href=https://cloud.google.com/compute/docs/machine-types>VM&rsquo;s families and types</a>. By default, you get benefit of the <a href=https://cloud.google.com/compute/docs/sustained-use-discounts>Sustained used discounts</a>, and you could also get more discounts with more commitments with <a href=https://cloud.google.com/compute/docs/instances/signing-up-committed-use-discounts>Commited use discounts</a>. Finally, you may want to <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/consuming-reservations>consume reservations with GKE</a>.</p><p><code>nodeConfig.diskSizeGb: 100</code>, choosing the proper size of your OS disk could be important, especially if you are facing application performance throttling. <a href=https://cloud.google.com/compute/docs/disks/performance#performance_factors>The section</a> will guide you through the factors that affect performance between the OS disk and the Node type that you should be aware of.</p><p><em>Note: you could learn more about performance optimization based on the choices you could make regarding to the node&rsquo;s disk setup, <a href=https://medium.com/paypal-tech/scaling-kubernetes-to-over-4k-nodes-and-200k-pods-29988fad6ed>by reading this great article from PayPal</a>.</em></p><p><code>nodeConfig.imageType: COS</code>. Here are the <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/node-images>different Node image types you could use</a>. On my end, I would like to go with <code>containerd</code> for a security standpoint, you could read more about the <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/using-containerd>differences between the <code>Docker/Moby</code> versus <code>containerd</code> approach</a> to see what fits best for your own context. I could actually upgrade my existing cluster with the new <code>COS_CONTAINERD</code> image type: <code>gcloud container clusters upgrade --image-type COS_CONTAINERD</code>.</p><p><code>management.autoRepair: true</code>, <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-repair>Nodes auto-repair</a> is enabled by default with version 1.17+, which is important to guarantee your nodes are healthy.</p><p><code>shieldedNodes: {}</code>, <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/shielded-gke-nodes>Shielded GKE nodes</a> bring a more security node credentials boostrapping implementation, starting with version <code>1.18</code> clusters will have shielded GKE nodes by default. We could even update a current GKE cluster without this feature enabled at creation time: <code>gcloud container clusters update --enable-shielded-nodes</code>.</p><p><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache>NodeLocal DNSCache</a>, if you think you have Kubernetes&rsquo; DNS issues, great option for stability and performance within your cluster, especially with large clusters. Good news, you could enable/disable without recreating your cluster: <code>gcloud container clusters update --update-addons NodeLocalDNS=ENABLED|DISABLED</code>.</p><p>That&rsquo;s a lot of concepts and there is more for sure (VPC, Monitoring, etc.), but anyway, that&rsquo;s what you need to know and learn about to have a proper GKE cluster for Production. I don&rsquo;t know for you but I love the flexibility with the <code>gcloud container clusters update|upgrade</code> commands to be able to enable/disable features on existing GKE cluster without having to recreate a cluster.</p><p>Last week I went with this very simple command line to create a straight forward GKE cluster: <code>gcloud container clusters create --zone</code>. With few concepts and features about resiliency, performance and security discussed throughout this blog article, I will better go now on with:</p><pre tabindex=0><code>gcloud container clusters create \
    --release-channel rapid \
    --region \
    --disk-type pd-ssd \
    --machine-type n2d-standard-2 \
    --disk-size 256 \
    --image-type cos_containerd \
    --enable-network-policy \
    --addons NodeLocalDNS \
    --enable-shielded-nodes \
    --shielded-secure-boot \
    --enable-autorepair \
    --enable-autoupgrade
</code></pre><p>And there is more concepts and features not discussed in this blog article, so I will adjust this snippet accordingly as I&rsquo;m diving more deeply with GCP/GKE.</p><p>Complementary resources:</p><ul><li><a href=https://cloud.google.com/kubernetes-engine/pricing>GKE Pricing</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/release-notes>GKE Release Notes</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/security-bulletins>GKE Security Bulletin</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/control-plane-security>GKE Shared responsibilities</a></li></ul><p>Awesome learnings, isn&rsquo;t it!? More to come during the coming weeks for sure, cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2020/08/cloud-build-with-gke/><span class=button__icon>←</span>
<span class=button__text>build and deploy a containerized app on gke with cloud build</span></a></span>
<span class="button next"><a href=/posts/2020/07/first-week-with-gcp/><span class=button__text>my first week with gcp</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>