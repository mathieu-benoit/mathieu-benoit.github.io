<!doctype html><html lang=en><head><title>advanced continuous integration pipeline for containers ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Today, I will document how to setup an advanced continuous integration (CI) pipeline for containers. Even if I will leverage GitHub Actions in this blog article, all the concepts and tools mentioned in this blog article could be easily leveraged from within any other CI tool like Jenkins, Azure DevOps, Google Cloud Build, etc.
First, let&amp;rsquo;s write a simple GitHub Actions definition to build and push a container into GitHub container registry:"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog.io/posts/2020/12/ci-for-k8s/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog.io/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="advanced continuous integration pipeline for containers"><meta name=twitter:description content="let's setup an advanced continuous integration pipeline for containers"><meta property="og:title" content="advanced continuous integration pipeline for containers"><meta property="og:description" content="let's setup an advanced continuous integration pipeline for containers"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog.io/posts/2020/12/ci-for-k8s/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-30T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-30T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>advanced continuous integration pipeline for containers</h1><div class=post-meta><span class=post-date>2020-12-30</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/dotnet/>#dotnet</a>&nbsp;</span><div class=post-content><p>Today, I will document how to setup an advanced continuous integration (CI) pipeline for containers. Even if I will leverage GitHub Actions in this blog article, all the concepts and tools mentioned in this blog article could be easily leveraged from within any other CI tool like Jenkins, Azure DevOps, <a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/08/cloud-build-with-gke/>Google Cloud Build</a>, etc.</p><p>First, let&rsquo;s write a simple GitHub Actions definition to build and push a container into GitHub container registry:</p><pre tabindex=0><code>name: simple-ci
on:
  push:
    branches:
      - main
  pull_request:
jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build container
        run: docker build --tag docker.pkg.github.com/${{ github.repository }}/container:${{ github.sha }} .
      - name: Log into container registry
        if: ${{ github.event_name == &#39;push&#39; }}
        run: echo &#34;${{ secrets.GITHUB_TOKEN }}&#34; | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin
      - name: Push image in container registry
        if: ${{ github.event_name == &#39;push&#39; }}
        run: docker push docker.pkg.github.com/${{ github.repository }}/container:${{ github.sha }}
</code></pre><p>That&rsquo;s how simple it is. We are pushing the container in the container registry only if the trigger is a commit on the <code>main</code> branch. Otherwise we are just building the container on Pull requests.</p><p>Now let&rsquo;s have a more complex and complete continuous integration pipeline with different checks and tests. Here are the tools I will use below on that regard:</p><ul><li><a href=https://www.docker.com/><code>Docker</code></a>, to run unit tests, build the container, run the container, push the container in a registry</li><li><a href=https://github.com/goodwithtech/dockle><code>Dockle</code></a> to check the compliance of the container image, see my <a href=https://mathieu-benoit.github.io/myblog.io/posts/2021/01/container-linter/>container linter blog article</a> for more details</li><li><a href=https://github.com/aquasecurity/trivy><code>Trivy</code></a>, to scan the container and see if there is any <code>CRITICAL</code> or <code>HIGH</code> vulnerabilities</li><li><a href=https://kind.sigs.k8s.io/><code>KinD</code></a>, to run the container on a local Kubernetes cluster</li><li><a href=https://cloud.google.com/blog/products/devops-sre/artifact-registry-is-ga>Google Artifact Registry</a> to store our container images on GCP with which we could enable the <a href=https://cloud.google.com/artifact-registry/docs/analysis>container analysis and vulnerability scanning</a> feature on.</li></ul><p>First we need to setup the GCP Service Account which will be used to push the container image in a specific Google Artifact Registry from GitHub actions:</p><pre tabindex=0><code>projectId=FIXME
artifactRegistryName=FIXME
artifactRegistryLocation=FIXME

gcloud config set project $projectId

saName=gha-$projectId-registry-push-sa
saId=$saName@$projectId.iam.gserviceaccount.com
gcloud iam service-accounts create $saName \
    --display-name=$saName
gcloud artifacts repositories add-iam-policy-binding $artifactRegistryName \
    --location $artifactRegistryLocation \
    --member &#34;serviceAccount:$saId&#34; \
    --role roles/artifactregistry.writer
gcloud iam service-accounts keys create ~/tmp/$saName.json \
    --iam-account $saId

gh auth login --web
gh secret set CONTAINER_REGISTRY_PUSH_PRIVATE_KEY &lt; ~/tmp/$saName.json
rm ~/tmp/$saName.json
gh secret set CONTAINER_REGISTRY_PROJECT_ID -b&#34;${projectId}&#34;
gh secret set CONTAINER_REGISTRY_NAME -b&#34;${artifactRegistryName}&#34;
gh secret set CONTAINER_REGISTRY_HOST_NAME -b&#34;${artifactRegistryLocation}-docker.pkg.dev&#34;
</code></pre><p>And here is now the advanced GitHub Actions definition:</p><pre tabindex=0><code>name: advanced-ci
on:
  push:
    branches:
      - main
  pull_request:
jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Prepare environment variables
        run: |
          shortSha=`echo ${GITHUB_SHA} | cut -c1-7`
          echo &#34;IMAGE_NAME=${{ secrets.CONTAINER_REGISTRY_HOST_NAME }}/${{ secrets.CONTAINER_REGISTRY_PROJECT_ID }}/${{ secrets.CONTAINER_REGISTRY_NAME }}/api:$shortSha&#34; &gt;&gt; $GITHUB_ENV
      - name: Build container
        run: |
          docker build --tag ${IMAGE_NAME} .
      - name: Dockle
        run: |
          docker run -v /var/run/docker.sock:/var/run/docker.sock --rm goodwithtech/dockle:latest --exit-code 1 --exit-level fatal ${IMAGE_NAME}
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}
          format: &#39;template&#39;
          template: &#39;@/contrib/sarif.tpl&#39;
          output: &#39;trivy-results.sarif&#39;
          severity: &#39;CRITICAL,HIGH&#39;
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: &#39;trivy-results.sarif&#39;
      - name: Run container locally as a test
        run: |
          docker run -d -p 8080:8080 --read-only --cap-drop=ALL --user=1000 ${IMAGE_NAME}
      - name: Installing KinD cluster
        uses: engineerd/setup-kind@v0.5.0
      - name: Configuring the KinD installation
        run: |
          kubectl cluster-info --context kind-kind
          kind get kubeconfig --internal &gt;$HOME/.kube/config
          kubectl get nodes
      - name: Load image on the nodes of the KinD cluster
        run: |
          kind load docker-image ${IMAGE_NAME} --name=kind
      - name: Deploy and test Kubernetes manifests in KinD cluster
        run: |
          kubectl create deployment test --image=${IMAGE_NAME}
          kubectl wait --for=condition=available --timeout=120s deployment/test
          kubectl get all
          status=$(kubectl get pods -l app=test -o &#39;jsonpath={.items[0].status.phase}&#39;)
          if [ $status != &#39;Running&#39; ]; then echo &#34;Pod not running!&#34; 1&gt;&amp;2; fi
      - name: Log into container registry
        if: ${{ github.event_name == &#39;push&#39; }}
        env:
          CONTAINER_REGISTRY_PUSH_PRIVATE_KEY: ${{ secrets.CONTAINER_REGISTRY_PUSH_PRIVATE_KEY }}
        run: |
          echo &#34;$CONTAINER_REGISTRY_PUSH_PRIVATE_KEY&#34; &gt; ${HOME}/gcloud.json
          gcloud auth activate-service-account --key-file=${HOME}/gcloud.json
          gcloud auth configure-docker ${{ secrets.CONTAINER_REGISTRY_HOST_NAME }} --quiet
      - name: Push image in container registry
        if: ${{ github.event_name == &#39;push&#39; }}
        run: |
          docker push ${IMAGE_NAME}
</code></pre><p>Complementary to this, I also enabled GitHub&rsquo;s <a href=https://help.github.com/github/administering-a-repository/configuration-options-for-dependency-updates><code>Dependabot</code></a> on my GitHub repository to frequently check if my <code>Nuget</code> packages or my container base images are up-to-date (really important on a security standpoint). <a href=https://github.com/mathieu-benoit/dotnet-on-kubernetes/blob/main/.github/dependabot.yml>Here</a> is an example of a file I have with that.</p><p>Notes:</p><ul><li>GitHub container registry <a href=https://github.community/t/docker-pull-from-public-github-package-registry-fail-with-no-basic-auth-credentials-error/16358/37>doesn&rsquo;t really support yet public images</a>, <code>docker pull</code> requires login/password.</li><li>GitHub actions <a href=https://github.community/t/add-short-sha-to-github-context/16418>doesn&rsquo;t support a short version of the <code>GITHUB_SHA</code> value</a>, you need to build it manually in your pipeline as a reusable variable for the rest of your pipeline.</li><li><code>Dependabot</code> <a href=https://github.com/dependabot/dependabot-core/issues/2057>doesn&rsquo;t support yet base image in the <code>FROM</code> instruction with <code>ARGS</code></a>.</li></ul><p>Complementary resources:</p><ul><li><a href=https://youtu.be/RsrwXEXyYnA>Configuring a multi-cloud Kubernetes CI/CD workflow with GitHub Actions</a></li><li><a href=https://cloud.google.com/blog/topics/developers-practitioners/deploying-serverless-platforms-github-actions>Deploying to serverless platforms with GitHub Actions</a></li><li><a href=https://resources.github.com/webcasts/Automating-CI-CD-Actions-Google-Cloud/>Automating CI/CD pipelines with GitHub Actions and Google Cloud</a></li><li><a href=https://youtu.be/4QN9b6HoFGU>Walkthrough of the Secure Software Factory at DoD - CNCF SIG Security</a></li></ul><p>Here we are, hope you enjoyed that one and that you learned different tips for your own CI pipelines. Like you could see, compliance and security checks are shifted left, in other words they are taking into account early in the development process thanks to this CI definition. From there, we have a container ready to be deploy in Kubernetes.</p><p>Cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2021/01/vpa/><span class=button__icon>←</span>
<span class=button__text>vertical pod autoscaler</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/12/pca/><span class=button__text>google professional cloud architect certification</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>