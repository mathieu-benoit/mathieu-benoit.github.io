<!doctype html><html lang=en><head><title>buildah, a tool to facilitate building oci container images ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="My previous blog article was about some findings and learnings I got with podman, a daemonless container engine. With podman we are able to run commands like: podman pull|push|tag|run|images|ps and many others (podman help) without any Docker Daemon installed. And again, at the end of the day, if you are comfortable with that, you could uninstall Docker and do this: alias docker=podman.
Now what about building your own OCI Container images?"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog.io/posts/2020/02/buildah/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog.io/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="buildah, a tool to facilitate building oci container images"><meta name=twitter:description content="let's build your own oci container images with buildah"><meta property="og:title" content="buildah, a tool to facilitate building oci container images"><meta property="og:description" content="let's build your own oci container images with buildah"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog.io/posts/2020/02/buildah/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-01T00:00:00+00:00"><meta property="article:modified_time" content="2020-02-01T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>buildah, a tool to facilitate building oci container images</h1><div class=post-meta><span class=post-date>2020-02-01</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog.io/tags/azure/>#azure</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/kubernetes/>#kubernetes</a>&nbsp;</span><div class=post-content><p>My previous blog article was about some <a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/01/podman/>findings and learnings I got with podman, a daemonless container engine</a>. With podman we are able to run commands like: <code>podman pull|push|tag|run|images|ps</code> and many others (<code>podman help</code>) without any Docker Daemon installed. And again, at the end of the day, if you are comfortable with that, you could uninstall Docker and do this: <code>alias docker=podman</code>.</p><p>Now what about building your own OCI Container images? If you would like to successfully run the command podman build, you will need to install <a href=https://buildah.io/>buildah</a> too.</p><p><img src=https://camo.githubusercontent.com/843f7639202a27bf5b6abc2afcc405e82804156a/68747470733a2f2f63646e2e7261776769742e636f6d2f636f6e7461696e6572732f6275696c6461682f6d61737465722f6c6f676f732f6275696c6461682d6c6f676f5f6c617267652e706e67 alt="Logo of buildah."></p><p><em>Image taken from <a href=https://github.com/containers/buildah>here</a></em></p><h1 id=installing-buildah>Installing buildah
<a href=#installing-buildah class=h-anchor aria-hidden=true>#</a></h1><p>You could follow <a href=https://github.com/containers/buildah/blob/master/install.md>those instructions</a> to see how to install buildah. In my case below I will install buildah on Ubuntu 18.04. Since I already setup the <code>Release.key</code> part by previously installing podman, I just need to run:</p><pre tabindex=0><code>sudo apt-get update -qq 
sudo apt-get -qq -y install buildah
</code></pre><p><em>Note: if you are using the <code>RUN</code> command in your <code>Dockerfile</code>, you will need to install runc too: <code>sudo apt-get -qq -y install runc</code>.</em></p><h1 id=building-and-running-an-oci-container-image-with-buildah>Building and running an OCI Container Image with buildah
<a href=#building-and-running-an-oci-container-image-with-buildah class=h-anchor aria-hidden=true>#</a></h1><p>Now let&rsquo;s build our first OCI container image, first of all we need a Containerfile (we will keep the notion of Dockerfile since it works with buildah/podman too):</p><p>Let&rsquo;s have this Dockerfile:</p><pre tabindex=0><code>FROM busybox:latest
CMD [&#34;date&#34;]
</code></pre><p>And then run this command:</p><pre tabindex=0><code>podman build -t date .
</code></pre><p>If you run podman images, you should see:</p><pre tabindex=0><code>REPOSITORY     TAG    IMAGE ID     CREATED     SIZE
localhost/date latest 022bdd32ce0e 8 hours ago 1.44 MB
</code></pre><p>Now let&rsquo;s run this Container Image by running this command: podman run date, you should get this kind of output:</p><pre tabindex=0><code>Sun Feb  2 02:01:34 UTC 2020
</code></pre><p>Reminder: if you are running this in WSL2, you should use:</p><ul><li><code>podman --cgroup-manager=cgroupfs --events-backend=file build</code> instead of <code>podman build</code></li><li><code>podman --cgroup-manager=cgroupfs --events-backend=file run</code> instead of <code>podman run</code></li></ul><p>To go further, I also gave a try to building &ldquo;more complex&rdquo; Container images with NodeJS, PHP, Golang and .NET Core containerized app, for this I leveraged this <a href=https://github.com/Azure/phippyandfriends>Azure/phippyandfriends</a> repository. The command podman build has worked like a charm with them! ;)</p><p>Note: when I built the .NET Core app (parrot), I got these warnings:</p><pre tabindex=0><code>STEP 6: RUN dotnet publish -c Release -o out
ERRO\[0234\] Can&#39;t add file /var/lib/containers/storage/overlay/5dba96836efb5e2cfe45ae7c9a711a8db5e0805bd88ba7af5b83b044fe184d65/diff/tmp/CoreFxPipe\_root.b5he0\_wwfcD\_lH7g471Brpw4X to tar: archive/tar: sockets not supported
ERRO\[0235\] Can&#39;t add file /var/lib/containers/storage/overlay/5dba96836efb5e2cfe45ae7c9a711a8db5e0805bd88ba7af5b83b044fe184d65/diff/tmp/dotnet-diagnostic-52-766545-socket to tar: archive/tar: sockets not supported
ERRO\[0235\] Can&#39;t add file /var/lib/containers/storage/overlay/5dba96836efb5e2cfe45ae7c9a711a8db5e0805bd88ba7af5b83b044fe184d65/diff/tmp/dotnet-diagnostic-76-766850-socket to tar: archive/tar: sockets not supported
ERRO\[0235\] Can&#39;t add file /var/lib/containers/storage/overlay/5dba96836efb5e2cfe45ae7c9a711a8db5e0805bd88ba7af5b83b044fe184d65/diff/tmp/hn2K8eq8bHUcTVSgvuckPlSK9tw9\_ORiMDm\_Vn4ylfI to tar: archive/tar: sockets not supported
</code></pre><p>The Container image is built successfully and we are even able to successfully run this Container. So not sure what&rsquo;s the impact of this. Maybe that&rsquo;s related to this <a href=https://github.com/containers/buildah/issues/1888>open buildah&rsquo;s issue</a>.</p><p>With that said, here are some differences in term of Container Images size:</p><ul><li><code>parrot</code> (.NET Core)<ul><li>With Docker: 117 MB</li><li>With podman/buildah: 117 MB (same size)</li></ul></li><li><code>captainkube</code> (Golang)<ul><li>With Docker: 43.7 MB</li><li>With podman/buildah: 43.6 MB (-0.1 MB)</li></ul></li><li><code>phippy</code> (PHP)<ul><li>With Docker: 427 MB</li><li>With podman/buildah: 388 MB (-39 MB)</li></ul></li><li><code>nodebrady</code> (NodeJS)<ul><li>With Docker: 92.8 MB</li><li>With podman/buildah: 101 MB (+8.2 MB)</li></ul></li></ul><p>Interesting&mldr;</p><h1 id=pushing-an-oci-container-image-in-container-registry>Pushing an OCI Container Image in Container Registry
<a href=#pushing-an-oci-container-image-in-container-registry class=h-anchor aria-hidden=true>#</a></h1><p>I won&rsquo;t go through the commands <code>pull|push</code> I presented in <a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/01/podman/>my previous blog article with podman</a>, but I was able to successfully push the date image in my DockerHub as well as in an Azure Container Registry (ACR).</p><p>In ACR, the icon of your Container image type will differ like you could see on the image below, on your left an image built with Docker and on your right an image built with podman/buildah:</p><p><img src=https://1.bp.blogspot.com/-5bTcYqKRE6o/XjYWEynYptI/AAAAAAAAUuM/qAiBX7Ri6O0qEN4wj9LD3SVud2We_rXSgCLcBGAsYHQ/s1600/Capture.PNG alt="Docker container image icon versus Buildah container image icon on the Azure portal.">]</p><p>Since <a href=https://mathieu-benoit.github.io/myblog.io/posts/2019/11/scanning-containers-with-asc/>I&rsquo;m using Azure Security Center (ASC) to scan my Container images in ACR</a>, I found out that for now there is an issue (&ldquo;Scan error&rdquo; without any details information) meaning that is not yet supported (I reached out to the Product Group Team, will see what they&rsquo;ll say):</p><p><img src=https://1.bp.blogspot.com/-2VprSVf_nEw/XjYXqBqOmvI/AAAAAAAAUuY/U1xyUXN6fqcu753npuNnn_b5it04XPwNQCLcBGAsYHQ/s1600/Capture.PNG alt="Container images built with buildah appear as &amp;ldquo;Scan error&amp;rdquo; on the Azure portal."></p><h1 id=deploying-an-oci-container-image-on-aks>Deploying an OCI Container Image on AKS
<a href=#deploying-an-oci-container-image-on-aks class=h-anchor aria-hidden=true>#</a></h1><p>Now what about running an OCI Container Image on Kubernetes, let&rsquo;s try this out on Azure Kubernetes Service (AKS).
Let&rsquo;s run <code>kubectl run date --image mabenoit/date</code>.
If you do <code>kubectl get pod</code> then, you will see that your pod has the status <code>ImagePullBackoff</code>.
By doing a kubectl describe of this pod, you will find in the Events section this error:</p><pre tabindex=0><code>Failed to pull image &#34;mabenoit/date&#34;: rpc error: code = Unknown desc = Error response from daemon: mediaType in manifest should be &#39;application/vnd.docker.distribution.manifest.v2+json&#39; not &#39;&#39;.
</code></pre><p>Depending on which version of Docker/Moby your are running as the CRI of your Kubernetes cluster you may get <a href=https://github.com/moby/moby/issues/39727>this issue</a>. AKS is using its own Moby version based on the upstream version, currently the Azure Moby version is 3.0.8 corresponding to <a href=https://github.com/docker/docker-ce/blob/v19.03.5/CHANGELOG.md#19034-2019-10-17>Docker 19.03.4</a>. You could find out with the mentioned issue that&rsquo;s fixed in <a href=https://github.com/docker/docker-ce/blob/v19.03.5/CHANGELOG.md#19035-2019-11-13>Docker 19.03.5</a>, which corresponds to Azure Moby version 3.0.9. Before getting this version in AKS, we will need to have <a href=https://github.com/Azure/aks-engine/pull/2613>this recent AKS-Engine&rsquo;s PR</a> packaged in a new version/release of AKS-Engine, which then will be integrated in AKS. Looking forward to it!</p><h1 id=further-considerations-and-resources>Further considerations and resources
<a href=#further-considerations-and-resources class=h-anchor aria-hidden=true>#</a></h1><ul><li><a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/01/podman/>podman, a daemonless container engine</a></li><li><a href=https://www.redhat.com/sysadmin/podman-windows-wsl2>How to run Podman on Windows with WSL2</a></li><li><a href=https://developers.redhat.com/blog/2019/02/21/podman-and-buildah-for-docker-users/>Podman and Buildah for Docker users</a></li><li><a href=https://developers.redhat.com/blog/2019/02/21/podman-and-buildah-for-docker-users/>Best practices for running Buildah in a container</a><ul><li>Yep! That&rsquo;s will be a future blog article on my blog, my use case will be to leverage this within Azure DevOps Pipelines, stay tuned! ;)</li></ul></li></ul><p>Hope you enjoyed those findings and learnings about podman and buildah, really promising!</p><p>Cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/02/custom-azure-pipelines-agent/><span class=button__icon>←</span>
<span class=button__text>my own custom and private azure pipelines agent as a docker container</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/01/podman/><span class=button__text>podman, a daemonless container engine</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>