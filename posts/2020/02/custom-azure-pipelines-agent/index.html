<!doctype html><html lang=en><head><title>my own custom and private azure pipelines agent as a docker container ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="On May 2018 I documented how to host your own and private Azure DevOps (formerly VSTS) agent. It was all about hosting this agent as a Docker Linux container and we were able to host it on Kubernetes.
Since then the recommended approach by Microsoft is to review how to customize your own custom and private Docker agent. We don&amp;rsquo;t have anymore to get the huge/heavy base Docker image with all the tools preconfigured."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2020/02/custom-azure-pipelines-agent/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="my own custom and private azure pipelines agent as a docker container"><meta name=twitter:description content="let's build a custom linux container image as an azure pipelines agent"><meta property="og:title" content="my own custom and private azure pipelines agent as a docker container"><meta property="og:description" content="let's build a custom linux container image as an azure pipelines agent"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2020/02/custom-azure-pipelines-agent/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-24T00:00:00+00:00"><meta property="article:modified_time" content="2020-02-24T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>my own custom and private azure pipelines agent as a docker container</h1><div class=post-meta><span class=post-date>2020-02-24</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/azure/>#azure</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/azure-devops/>#azure-devops</a>&nbsp;</span><div class=post-content><p>On May 2018 I documented <a href=https://alwaysupalwayson.blogspot.com/2018/05/host-your-private-vsts-linux-agent-in.html>how to host your own and private Azure DevOps (formerly VSTS) agent</a>. It was all about hosting this agent as a Docker Linux container and we were able to host it on Kubernetes.<br>Since then the recommended approach by Microsoft is to review how to customize your own custom and private Docker agent. We don&rsquo;t have anymore to get the huge/heavy base Docker image with all the tools preconfigured. Now we could just install the tools we need, you could follow the official documentation for this: <a href=https://docs.microsoft.com/azure/devops/pipelines/agents/docker#linux>Running a self-hosted agent in Docker</a>.</p><p>In my case I&rsquo;m building and using my own Docker Linux container image with the tools I need: Docker, Terraform and Helm, here is my GitHub repository to see how I do this: <a href=https://github.com/mathieu-benoit/my-azure-pipelines-agent>https://github.com/mathieu-benoit/my-azure-pipelines-agent</a></p><p>You will be able to find the important files there:</p><ul><li><a href=https://github.com/mathieu-benoit/my-azure-pipelines-agent/blob/master/Dockerfile>Dockerfile</a><ul><li><em>The definition and the content of my custom agent.</em></li></ul></li><li><a href=https://github.com/mathieu-benoit/my-azure-pipelines-agent/blob/master/azure-pipeline.yml>azure-pipeline.yml</a><ul><li>The Azure Pipeline definition in YAML to build and push my custom agent in my DockerHub</li></ul></li><li><a href=https://github.com/mathieu-benoit/my-azure-pipelines-agent/blob/master/example/use-my-custom-ado-agent.yml>example/use-my-custom-ado-agent.yml</a><ul><li><em>An example to see how to use this custom private agent in your Azure Pipelines definitions</em></li></ul></li></ul><p>Once built and pushed we could easily deploy this Docker container like illustrated below on any Docker host, Azure Container Instances (ACI) or Kubernetes (say AKS for example):</p><pre tabindex=0><code>AZP_TOKEN=FIXME
AZP_URL=https://dev.azure.com/FIXME
AZP_AGENT_NAME=myadoagent
AZP_POOL=myadoagent
</code></pre><p>On any Docker host:</p><pre tabindex=0><code>docker run \
    -e AZP_URL=$AZP_URL \
    -e AZP_TOKEN=$AZP_TOKEN \
    -e AZP_AGENT_NAME=$AZP_AGENT_NAME \
    -e AZP_POOL=$AZP_POOL \
    -it mabenoit/ado-agent:latest
</code></pre><p>On ACI:</p><pre tabindex=0><code>az container create \
    -g $rg -n $name \
    --image mabenoit/ado-agent:latest \
    --ip-address Private \
    -e AZP_URL=$AZP_URL AZP_TOKEN=$AZP_TOKEN AZP_AGENT_NAME=$AZP_AGENT_NAME AZP_POOL=$AZP_POOL
</code></pre><p>On Kubernetes:</p><pre tabindex=0><code>kubectl create secret generic azp \
    --from-literal=AZP_URL=$AZP_URL \
    --from-literal=AZP_TOKEN=$AZP_TOKEN \
    --from-literal=AZP_AGENT_NAME=$AZP_AGENT_NAME \
    --from-literal=AZP_POOL=$AZP_POOL
kubectl apply -f - &lt;&lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ado-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ado-agent
  template:
    metadata:
      labels:
        app: ado-agent
    spec:
      containers:
        - name: ado-agent
          image: mabenoit/ado-agent:latest
          env:
            - name: AZP_URL
              valueFrom:
                secretKeyRef:
                  name: azp
                  key: AZP_URL
            - name: AZP_TOKEN
              valueFrom:
                secretKeyRef:
                  name: azp
                  key: AZP_TOKEN
            - name: AZP_AGENT_NAME
              valueFrom:
                secretKeyRef:
                  name: azp
                  key: AZP_AGENT_NAME
            - name: AZP_POOL
              valueFrom:
                secretKeyRef:
                  name: azp
                  key: AZP_POOL
          volumeMounts:
            - mountPath: /var/run/docker.sock
              name: docker-socket-volume
      volumes:
        - name: docker-socket-volume
          hostPath:
            path: /var/run/docker.sock
EOF
</code></pre><p><em>Remark: you could see the volumeMounts section with the Kubernetes deployment, that&rsquo;s how you could leverage this way to build Docker container in a Docker container. You could do that with the Docker host example but it&rsquo;s not possible to do this with ACI.</em></p><p>The advantages of doing that for me is having my own tools but most important having the ability to host my agent as a Docker container anywhere, especially important if I need to secure it in my own Azure Infrastructure (think VNET/Subnet and restricting access in Azure). I will blog about this in more details later.</p><p>Resources:</p><ul><li><a href=https://juliocasal.com/2020/01/14/deploying-azure-pipelines-agents-as-containers-to-kubernetes/>Deploying Azure Pipelines agents as containers to Kubernetes</a></li><li><a href=https://github.com/microsoft/azure-pipelines-agent/blob/master/docs/design/byos.md>Elastic Self-hosted Agent Pools</a></li><li><a href=https://www.henrybeen.nl/fully-isolated-private-agents-for-azure-pipelines-in-azure-container-instances/>Fully isolated private Agents for Azure Pipelines in Azure Container Instances</a></li><li><a href=https://github.com/microsoft/azure-pipelines-ephemeral-agents>Ephemeral Pipelines Agents</a></li></ul><p>Hope you enjoyed this blog article and its associated code to reuse and adapt for your own needs.</p><p>Cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2020/03/protect-terraform-state/><span class=button__icon>←</span>
<span class=button__text>protect your terraform state files with azure private endpoints for azure storage</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2020/02/buildah/><span class=button__text>buildah, a tool to facilitate building oci container images</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>