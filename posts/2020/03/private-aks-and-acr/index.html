<!doctype html><html lang=en><head><title>private aks and private acr, safer you are ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="To continue improving your Security Posture with Azure Private Endpoint like I demonstrated with Azure Blob Storage previously, let&amp;rsquo;s now have a look at Azure Private Endpoint with Azure Kubernetes Service (AKS) and Azure Container Registry (ACR).
Private AKS cluster just reached GA and private ACR has just been announced in Public Preview among different PaaS service now supporting Azure Private Link.
Here is how the architecture of my AKS cluster looks like now:"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=mathieu-benoit.github.io/posts/2020/03/private-aks-and-acr/><link rel=stylesheet href=mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=mathieu-benoit.github.io/img/favicon.png><link href=mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="private aks and private acr, safer you are"><meta name=twitter:description content="let's setup azure private endpoint for both azure kubernetes service (aks) and azure container registry (acr)"><meta property="og:title" content="private aks and private acr, safer you are"><meta property="og:description" content="let's setup azure private endpoint for both azure kubernetes service (aks) and azure container registry (acr)"><meta property="og:type" content="article"><meta property="og:url" content="mathieu-benoit.github.io/posts/2020/03/private-aks-and-acr/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-27T00:00:00+00:00"><meta property="article:modified_time" content="2020-03-27T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=mathieu-benoit.github.io/about/>about</a></li><li><a href=mathieu-benoit.github.io/presentations/>presentations</a></li><li><a href=mathieu-benoit.github.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=mathieu-benoit.github.io/about/>about</a></li><li><a href=mathieu-benoit.github.io/presentations/>presentations</a></li><li><a href=mathieu-benoit.github.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>private aks and private acr, safer you are</h1><div class=post-meta><span class=post-date>2020-03-27</span></div><span class=post-tags><a href=mathieu-benoit.github.io/tags/azure/>#azure</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/azure-devops/>#azure-devops</a>&nbsp;</span><div class=post-content><p>To continue improving your Security Posture with <a href=mathieu-benoit.github.io/posts/2020/03/protect-terraform-state/>Azure Private Endpoint like I demonstrated with Azure Blob Storage previously</a>, let&rsquo;s now have a look at Azure Private Endpoint with Azure Kubernetes Service (AKS) and Azure Container Registry (ACR).</p><p>Private AKS cluster just reached GA and private ACR has just been announced in Public Preview <a href=https://azure.microsoft.com/updates/privatelinkforpaasga/>among different PaaS service now supporting Azure Private Link</a>.</p><p>Here is how the architecture of my AKS cluster looks like now:</p><p><img src=https://github.com/mathieu-benoit/myakscluster/raw/master/myakscluster.png alt="Architecture diagram illustrating the different services and components involved in this blog article and GitHub repository."></p><p>To summarize what I have made:</p><ul><li><a href=https://docs.microsoft.com/azure/aks/private-clusters>Private AKS</a> cluster in its own Subnet with Private Endpoint</li><li><a href=https://docs.microsoft.com/azure/container-registry/container-registry-private-link>Private ACR</a> in its own Subnet with Private Endpoint<ul><li>I put it in the same AKS&rsquo;s VNET, it&rsquo;s my choice, but it could be placed in another peered VNET as well.</li></ul></li><li>Jumpbox VM and Bastion in a VNET peered with the AKS&rsquo;s VNET<ul><li>I create a VM with only a Private IP address and I create an Azure Bastion to allow the SSH connection from within the Azure portal.</li></ul></li><li><a href=mathieu-benoit.github.io/posts/2020/02/custom-azure-pipelines-agent/>Custom Azure pipelines agent</a> hosted on AKS<ul><li>With that I&rsquo;m able to push both containers and Helm chart in ACR as well as deploying the Helm chart in AKS for any of my apps.</li></ul></li><li><a href=mathieu-benoit.github.io/posts/2020/03/protect-terraform-state/>Private Azure Blob Storage Account</a> with Private Endpoint<ul><li>Not illustrated on this image, but I am using this custom Azure pipelines agent described above to deploy Terraform for different workloads. In order to get access to this associated TF State file locked down in Blob Storage Account behind its Private Endpoint, I need to peer the AKS&rsquo;s VNET with the Blob Storage account&rsquo;s VNET.</li></ul></li></ul><p>If you are interested in seeing how I put all of this together, <a href=https://github.com/mathieu-benoit/myakscluster/pull/60>here is the PR demonstrating how I have leveraged Private Link with my AKS and ACR</a>.</p><p>2 takeaways:</p><ul><li>The <a href=https://docs.microsoft.com/azure/container-registry/container-registry-private-link>current documentation about Azure Private Link with ACR</a> is missing the command avoiding public access to your ACR: <code>az acr update --default-action Deny</code>. It will be fixed soon by the Product Group team.</li><li>Currently once you have setup Azure Private Link with ACR (and made it private), <a href=https://docs.microsoft.com/azure/security-center/azure-container-registry-integration>the Azure Security Center Scanning (Qualys)</a> is not working yet.</li></ul><p>You could see on the image above that I&rsquo;m using also <a href=mathieu-benoit.github.io/posts/2019/09/calico/>Calico Network Policies</a>, <a href=mathieu-benoit.github.io/posts/2020/01/kured/>Kured to patch my K8S nodes</a>, but there is more to come for sure like the new features like <a href=https://docs.microsoft.com/azure/governance/policy/concepts/rego-for-aks>Azure Policy</a> in Preview, <a href=https://docs.microsoft.com/azure/aks/azure-ad-v2>AAD integration v2</a> in Preview,  <a href=https://docs.microsoft.com/azure/aks/use-managed-identity>Managed Identities</a> in GA, etc. If you are looking for more best practices around security for your AKS cluster, I invite you to leverage this GitHub Repository in Work in Progress: <a href=https://github.com/Azure/sg-aks-workshop>https://github.com/Azure/sg-aks-workshop</a>.</p><p>Hope you are enjoying those great news and updates to setup more securely your solution leveraging AKS!</p><p>Cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=mathieu-benoit.github.io/posts/2020/04/pod-security-context/><span class=button__icon>←</span>
<span class=button__text>container security context on kubernetes</span></a></span>
<span class="button next"><a href=mathieu-benoit.github.io/posts/2020/03/protect-terraform-state/><span class=button__text>protect your terraform state files with azure private endpoints for azure storage</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=mathieu-benoit.github.io/assets/main.js></script>
<script src=mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>