<!doctype html><html lang=en><head><title>protect your terraform state files with azure private endpoints for azure storage ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Few weeks ago, Azure Private Link was announced GA for Azure Storage, Azure SQL and Azure CosmosDB and more recently for Azure Database for MariaDB, PostgreSQL and MySQL. And actually Private AKS cluster with Azure Private Link just became GA too. Azure Private Link includes two concepts: Private Endpoint and Private Link Service. With this blog article we won&amp;rsquo;t discuss about Private Link Service.
I would like to leverage Azure Private Link to protect the Azure Blob Storage account used to store the TF State of my Terraform deployment."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2020/03/protect-terraform-state/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="protect your terraform state files with azure private endpoints for azure storage"><meta name=twitter:description content="let's leverage azure private endpoint to protect the azure blob storage account used to store the terraform state file"><meta property="og:title" content="protect your terraform state files with azure private endpoints for azure storage"><meta property="og:description" content="let's leverage azure private endpoint to protect the azure blob storage account used to store the terraform state file"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2020/03/protect-terraform-state/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-14T00:00:00+00:00"><meta property="article:modified_time" content="2020-03-14T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>protect your terraform state files with azure private endpoints for azure storage</h1><div class=post-meta><span class=post-date>2020-03-14</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/azure/>#azure</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/terraform/>#terraform</a>&nbsp;</span><div class=post-content><p>Few weeks ago, <a href=https://azure.microsoft.com/updates/azure-private-link-is-now-available>Azure Private Link was announced GA for Azure Storage, Azure SQL and Azure CosmosDB</a> and more recently for Azure Database for <a href=https://azure.microsoft.com/updates/aziure-private-link-for-azure-database-for-mariadb-is-now-generally-available/>MariaDB</a>, <a href=https://azure.microsoft.com/updates/private-link-for-azure-database-for-postgresql-single-server-is-now-available>PostgreSQL</a> and <a href=https://azure.microsoft.com/updates/azure-private-link-for-azure-database-for-mysql-is-now-available>MySQL</a>. And actually <a href=https://docs.microsoft.com/azure/aks/private-clusters>Private AKS cluster with Azure Private Link</a> just became GA too.
Azure Private Link includes two concepts: Private Endpoint and Private Link Service. With this blog article we won&rsquo;t discuss about <a href=https://docs.microsoft.com/azure/private-link/private-link-service-overview>Private Link Service</a>.</p><p>I would like to leverage Azure Private Link to protect the Azure Blob Storage account used to store the TF State of <a href=https://mathieu-benoit.github.io/posts/2019/09/deploy-terraform-via-azure-pipelines/>my Terraform deployment</a>.<br>For this I have leveraged a combination of the following resources:</p><ul><li><a href=https://docs.microsoft.com/azure/private-link/create-private-endpoint-cli>Quickstart: Create a private endpoint using Azure CLI</a></li><li><a href=https://docs.microsoft.com/azure/private-link/create-private-endpoint-storage-portal>Connect privately to a storage account using Azure Private Endpoint</a></li><li><a href=https://docs.microsoft.com/azure/storage/common/storage-private-endpoints>Using Private Endpoints for Azure Storage</a></li></ul><p>First let&rsquo;s create the Azure Storage account (if you don&rsquo;t have one yet):</p><pre tabindex=0><code>rg=&lt;your-resourcegroup-name&gt;
storageName=&lt;your-storage-name&gt;
location=&lt;your-location&gt;
az group create \
    -n $rg \
    -l $location
storageAccountId=$(az storage account create -g $rg -n $storageName --sku Standard\_LRS --kind StorageV2 --encryption-services blob --query id -o tsv)
</code></pre><p>Then let&rsquo;s create the VNET and Subnet we will put the Azure Storage account into (if you don&rsquo;t have one yet):</p><pre tabindex=0><code>vnetName=&lt;your-vnet-name&gt;
subnetName=&lt;your-subnet-name&gt;
az network vnet create \
    -n $vnetName \
    -g $rg \
    --subnet-name $subnetName
</code></pre><p>Now, we need to create the Azure Private Endpoint bound to our Azure Storage account:</p><pre tabindex=0><code>privateEndpointName=&lt;your-private-endpoint-name&gt;  
az network vnet subnet update \
    -n $subnetName \
    -g $rg \
    --vnet-name $vnetName \
    --disable-private-endpoint-network-policies true  
az network private-endpoint create \
    -n $privateEndpointName \
    -g $rg \
    --vnet-name $vnetName \
    --subnet $subnetName \
    --private-connection-resource-id $storageAccountId \
    --group-id blob \
    --connection-name $privateEndpointName  
az storage account update \
    -g $rg \
    -n $storageName \
    --default-action Deny  
</code></pre><p>Finally, we need to create a Private DNS for this Azure Storage and create an association link with the VNET:</p><pre tabindex=0><code>zoneName=&#34;privatelink.blob.core.windows.net&#34;
az network private-dns zone create \
    -g $rg \
    -n $zoneName
az network private-dns link vnet create \
    -g $rg \
    --zone-name $zoneName \
    -n $privateDnsName \
    --virtual-network $vnetName \
    --registration-enabled false
networkInterfaceId=$(az network private-endpoint show -n $privateEndpointName -g $rg --query &#39;networkInterfaces[0].id&#39; -o tsv)
privateIpAddress=$(az resource show --ids $networkInterfaceId --api-version 2019-04-01 --query properties.ipConfigurations[0].properties.privateIPAddress -o tsv)
az network private-dns record-set a create \
    -n $storageName \
    --zone-name $zoneName \
    -g $rg
az network private-dns record-set a add-record \
    --record-set-name $storageName \
    --zone-name $zoneName \
    -g $rg \
    -a $privateIpAddress
</code></pre><p>Here you are, with all the above commands, your Azure Storage account is not anymore accessible publicly but now only by who has access to its VNET:</p><ul><li>Any resources in the same VNET</li><li>Any resources in <a href=https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview>peered VNET</a></li><li>Any resources in <a href=https://docs.microsoft.com/azure/expressroute/expressroute-about-virtual-network-gateways>Gateway-ed network</a></li></ul><p>In my case, like illustrated in <a href=https://mathieu-benoit.github.io/posts/2019/09/deploy-terraform-via-azure-pipelines/>my Terraform deployment</a>, I&rsquo;m leveraging <a href=https://mathieu-benoit.github.io/posts/2020/02/custom-azure-pipelines-agent/>my own custom and private Azure Pipelines Agent as a Docker container</a> deployed on my AKS cluster in the same VNET or on a peered VNET. FYI, there is limitations with Azure Web App for Containers or Azure Container Instances (ACI) which don&rsquo;t support 1/ build docker container images on Docker + 2/ like <a href=https://docs.microsoft.com/azure/container-instances/container-instances-vnet#unsupported-networking-scenarios>described here</a> they don&rsquo;t support internal name resolution which won&rsquo;t work with the Private DNS setup required by Azure Private Endpoints.</p><p>Complementary resources:</p><ul><li><a href=https://docs.microsoft.com/azure/private-link/private-link-faq>Azure Private Link FAQ</a></li><li><a href=https://azure.microsoft.com/pricing/details/private-link/>Azure Private Link Pricing</a></li><li><a href=https://stefanstranger.github.io/2019/11/03/UsingAzurePrivateLinkForStorageAccounts/>Using Azure Private Link for Storage Accounts</a></li></ul><p>Hope you enjoyed this blog article and this walk-through process to secure your Azure Blob Storage account hosting your Terraform State files.</p><p>Stay safe! Cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2020/03/private-aks-and-acr/><span class=button__icon>←</span>
<span class=button__text>private aks and private acr, safer you are</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2020/02/custom-azure-pipelines-agent/><span class=button__text>my own custom and private azure pipelines agent as a docker container</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>