<!doctype html><html lang=en><head><title>online boutique demo ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Today we&amp;rsquo;ll deploy the Online Boutique source code on a GKE cluster.
Online Boutique (aka Microservices Demo) is a cloud-native microservices demo application. Online Boutique consists of a 10-tier microservices application. The application is a web-based e-commerce app where users can browse items, add them to the cart, and purchase them.
Service Language Description frontend Go Exposes an HTTP server to serve the website. Does not require signup/login and generates session IDs for all users automatically cartservice C# Stores the items in the user&amp;rsquo;s shopping cart in Redis and retrieves it productcatalogservice Go Provides the list of products from a JSON file and ability to search products and get individual products currencyservice Node."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2020/11/online-boutique-demo/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="online boutique demo"><meta name=twitter:description content="let's see how to deploy the online boutique solution on gke, w/ or w/o workload identity"><meta property="og:title" content="online boutique demo"><meta property="og:description" content="let's see how to deploy the online boutique solution on gke, w/ or w/o workload identity"><meta property="og:type" content="article"><meta property="og:url" content="/posts/2020/11/online-boutique-demo/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-15T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-15T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>online boutique demo</h1><div class=post-meta><span class=post-date>2020-11-15</span></div><span class=post-tags><a href=/tags/gcp/>#gcp</a>&nbsp;
<a href=/tags/containers/>#containers</a>&nbsp;
<a href=/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=/tags/security/>#security</a>&nbsp;
<a href=/tags/dotnet/>#dotnet</a>&nbsp;</span><div class=post-content><p><img src=https://github.com/GoogleCloudPlatform/microservices-demo/raw/main/docs/img/architecture-diagram.png alt="Architecture diagram of the Microservices demo repository showing the 10 apps and their dependencies."></p><p>Today we&rsquo;ll deploy the <a href=https://github.com/GoogleCloudPlatform/microservices-demo><code>Online Boutique</code> source code</a> on a GKE cluster.</p><blockquote><p><a href=https://github.com/GoogleCloudPlatform/microservices-demo><code>Online Boutique</code></a> (aka <code>Microservices Demo</code>) is a cloud-native microservices demo application. Online Boutique consists of a 10-tier microservices application. The application is a web-based e-commerce app where users can browse items, add them to the cart, and purchase them.</p></blockquote><table><thead><tr><th>Service</th><th>Language</th><th>Description</th></tr></thead><tbody><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/frontend>frontend</a></td><td>Go</td><td>Exposes an HTTP server to serve the website. Does not require signup/login and generates session IDs for all users automatically</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/cartservice>cartservice</a></td><td>C#</td><td>Stores the items in the user&rsquo;s shopping cart in Redis and retrieves it</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/productcatalogservice>productcatalogservice</a></td><td>Go</td><td>Provides the list of products from a JSON file and ability to search products and get individual products</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/currencyservice>currencyservice</a></td><td>Node.js</td><td>Converts one money amount to another currency. Uses real values fetched from European Central Bank. It&rsquo;s the highest QPS service</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/paymentservice>paymentservice</a></td><td>Node.js</td><td>Charges the given credit card info (mock) with the given amount and returns a transaction ID</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/shippingservice>shippingservice</a></td><td>Go</td><td>Gives shipping cost estimates based on the shopping cart. Ships items to the given address (mock)</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/emailservice>emailservice</a></td><td>Python</td><td>Sends users an order confirmation email (mock)</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/checkoutservice>checkoutservice</a></td><td>Go</td><td>Retrieves user cart, prepares order and orchestrates the payment, shipping and the email notification</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/recommendationservice>recommendationservice</a></td><td>Python</td><td>Recommends other products based on what&rsquo;s given in the cart</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/adservice>adservice</a></td><td>Java</td><td>Provides text ads based on given context words</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/src/loadgenerator>loadgenerator</a></td><td>Python/Locust</td><td>Continuously sends requests imitating realistic user shopping flows to the frontend</td></tr></tbody></table><pre tabindex=0><code>git clone https://github.com/GoogleCloudPlatform/microservices-demo
cd microservices-demo

gcloud services enable cloudprofiler.googleapis.com

# Assumption here that you already have a GCP project and a GKE cluster in it
projectId=FIXME
clusterName=FIXME
clusterZone=FIXME
clusterRegion=FIXME
gcloud config set project $projectId
gcloud container clusters get-credentials $clusterName \
    --zone $clusterZone

# Create a dedicated namespace
namespace=boutique
kubectl create ns $namespace
kubectl config set-context \
    --current \
    --namespace $namespace
</code></pre><p>Now, here is 4 options with associated scripts to deploy this solution on GKE:</p><ul><li><a href=#deployment-on-gke-with-pre-built-images>With pre-built images</a></li><li><a href=#deployment-on-gke-with-custom-and-private-images>With custom and private images</a></li><li><a href=#deployment-on-gke-with-workload-identity>With Workload Identity</a></li><li><a href=#replace-the-in-cluster-redis-database-by-google-cloud-memorystore>Replace the in-cluster redis database by Google Cloud Memorystore</a></li></ul><h2 id=deployment-on-gke-with-pre-built-images>Deployment on GKE with pre-built images
<a href=#deployment-on-gke-with-pre-built-images class=h-anchor aria-hidden=true>#</a></h2><pre tabindex=0><code>kubectl apply \
    -f ./release/kubernetes-manifests.yaml
kubectl get all,secrets,configmaps
kubectl get service frontend-external | awk &#39;{print $4}&#39;
</code></pre><h2 id=deployment-on-gke-with-custom-and-private-images>Deployment on GKE with custom and private images
<a href=#deployment-on-gke-with-custom-and-private-images class=h-anchor aria-hidden=true>#</a></h2><p>In some cases you may need to only deploy container images coming from your own private container registry, for example if you have your GKE cluster leveraging <a href=/posts/2020/11/binauthz/>Binary Authorization</a>.</p><pre tabindex=0><code>publicContainerRegistry=gcr.io/google-samples/microservices-demo
privateContainerRegistry=$clusterRegion-docker.pkg.dev/$projectId/containers/boutique
services=&#34;adservice cartservice checkoutservice currencyservice emailservice frontend loadgenerator paymentservice productcatalogservice recommendationservice shippingservice&#34;
imageTag=$(curl -s https://api.github.com/repos/GoogleCloudPlatform/microservices-demo/releases | jq -r &#39;[.[]] | .[0].tag_name&#39;)

# Copy the pre-built images into your own private GCR:
for s in $services; do docker pull $publicContainerRegistry/$s:$imageTag; docker tag $publicContainerRegistry/$s:$imageTag $privateContainerRegistry/$s:$imageTag; docker push $privateContainerRegistry/$s:$imageTag; done
docker pull redis:alpine
docker tag redis:alpine $privateContainerRegistry/redis:alpine
docker push $privateContainerRegistry/redis:alpine

# Update the Kubernetes manifests with these new container images
for s in $services; do sed -i &#34;s,image: $s,image: $privateContainerRegistry/$s:$imageTag,g&#34; ./kubernetes-manifests/$s.yaml; done
sed -i &#34;s,image: redis:alpine,image: $privateContainerRegistry/redis:alpine,g&#34; ./kubernetes-manifests/redis.yaml

# Deploy the solution
kubectl apply \
    -f ./kubernetes-manifests
kubectl get all,secrets,configmaps,sa
kubectl get service frontend-external | awk &#39;{print $4}&#39;
</code></pre><h2 id=deployment-on-gke-with-workload-identity>Deployment on GKE with Workload Identity
<a href=#deployment-on-gke-with-workload-identity class=h-anchor aria-hidden=true>#</a></h2><p><em>Note: It&rsquo;s highly recommended to have your GKE clusters with Workload Identity enabled, I discussed about the why and how if you are interested in knowing more, here: <a href=/posts/2020/10/gke-service-account/>GKE’s service account</a>.</em></p><pre tabindex=0><code># Create a dedicated service account
ksaName=boutique-ksa
kubectl create serviceaccount $ksaName
gsaName=$projectId-boutique-gsa
gsaAccountName=$gsaName@$projectId.iam.gserviceaccount.com
gcloud iam service-accounts create $gsaName
gcloud iam service-accounts add-iam-policy-binding \
    --role roles/iam.workloadIdentityUser \
    --member &#34;serviceAccount:$projectId.svc.id.goog[$namespace/$ksaName]&#34; \
    $gsaAccountName
kubectl annotate serviceaccount \
    $ksaName \
    iam.gke.io/gcp-service-account=$gsaAccountName
roles=&#34;roles/cloudtrace.agent roles/monitoring.metricWriter roles/cloudprofiler.agent roles/clouddebugger.agent&#34;
for r in $roles; do gcloud projects add-iam-policy-binding $projectId --member &#34;serviceAccount:$gsaAccountName&#34; --role $r; done

# Update the Kubernetes manifests with this service account
files=&#34;`pwd`/kubernetes-manifests/*&#34;
for f in $files; do sed -i &#34;s/serviceAccountName: default/serviceAccountName: $ksaName/g&#34; $f; done

# Deploy the solution
kubectl apply \
    -f ./kubernetes-manifests
kubectl get all,secrets,configmaps,sa
kubectl get service frontend-external | awk &#39;{print $4}&#39;
</code></pre><h2 id=replace-the-in-cluster-redis-database-by-google-cloud-memorystore>Replace the in-cluster redis database by Google Cloud Memorystore
<a href=#replace-the-in-cluster-redis-database-by-google-cloud-memorystore class=h-anchor aria-hidden=true>#</a></h2><p>Important notes:</p><ul><li>You can connect to a Memorystore (redis) instance only from GKE clusters that are in the same region and use the same network as your instance.</li><li>You cannot connect to a Memorystore (redis) instance from a GKE cluster without VPC-native/IP aliasing enabled. For this you should create a GKE cluster with this option <code>--enable-ip-alias</code>.</li></ul><pre tabindex=0><code># Create the Memorystore (redis) instance
gcloud services enable redis.googleapis.com
gcloud redis instances create redis-cart --size=1 --region=$clusterRegion --zone=$clusterZone --redis-version=redis_6_x
gcloud redis instances list --region $clusterRegion

# Update the Kubernetes manifests
REDIS_IP=$(gcloud redis instances describe redis-cart --region=$clusterRegion --format=&#39;get(host)&#39;)
sed -i &#34;s/value: \&#34;redis-cart:6379\&#34;/value: \&#34;${REDIS_IP}\&#34;/g&#34; ./release/kubernetes-manifests.yaml
# You could also remove the `Deployment` and `Service` related to the not needed anymore `redis-cart`.

# Deploy the solution
kubectl apply -f ./release/kubernetes-manifests.yaml
kubectl get pods
kubectl delete deployment redis-cart
kubectl detele service redis-cart
kubectl get service frontend-external | awk &#39;{print $4}&#39;
</code></pre><p>That&rsquo;s a wrap! We now have handy scripts for the <code>Online Boutique</code> solution, ready to be deployed on both GKE w/ or w/o Workload Identity and as a bonus we also replaced the in-cluster <code>redis</code> container by Memorystore (redis).</p><p>Further and complementary resources:</p><ul><li><a href="https://www.qwiklabs.com/focuses/13066?parent=catalog">Debugging Apps on Google Kubernetes Engine with the OnlineBoutique repo</a></li><li><a href=https://cloud.google.com/blog/products/operations/on-the-road-to-sre-with-cloud-operations-sandbox>Cloud Operations Sandbox based on the OnlineBoutique repo</a></li><li><a href=https://cloud.google.com/memorystore/docs/redis/connect-redis-instance-gke>Connecting to a Redis instance from a Google Kubernetes Engine cluster</a></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2020/12/k8s-ctf/><span class=button__icon>←</span>
<span class=button__text>my capture the flag (ctf) and kubecon na 2020 experiences</span></a></span>
<span class="button next"><a href=/posts/2020/11/binauthz/><span class=button__text>binary authorization on gke</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>