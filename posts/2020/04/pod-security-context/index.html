<!doctype html><html lang=en><head><title>container security context on kubernetes ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="2020-12 - I did my first Capture The Flag (CTF) experience illustrating those concepts explained on this article, you could find more information here
While preparing my presentation with Maxime Coquerel for our 16 Security Best Practices with Kubernetes on Azure (AKS) presentation in French, I took the opportunity to learn about the Pod Security Context in Kubernetes. Here, in this blog article, are my learnings.
First of all I went through the official Kubernetes documentation: Configure a Security Context for a Pod or Container."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog.io/posts/2020/04/pod-security-context/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog.io/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="container security context on kubernetes"><meta name=twitter:description content="let's add more security context to your containers on kubernetes"><meta property="og:title" content="container security context on kubernetes"><meta property="og:description" content="let's add more security context to your containers on kubernetes"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog.io/posts/2020/04/pod-security-context/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-28T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-28T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>container security context on kubernetes</h1><div class=post-meta><span class=post-date>2020-04-28</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/dotnet/>#dotnet</a>&nbsp;</span><div class=post-content><p><em>2020-12 - I did my first Capture The Flag (CTF) experience illustrating those concepts explained on this article, you could find more information <a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/12/k8s-ctf/>here</a></em></p><p>While preparing my presentation with <a href=https://www.linkedin.com/in/maximecoquerel>Maxime Coquerel</a> for our <a href=https://youtu.be/BCDSXyrJUJQ>16 Security Best Practices with Kubernetes on Azure (AKS)</a> presentation in French, I took the opportunity to learn about the Pod Security Context in Kubernetes. Here, in this blog article, are my learnings.</p><p>First of all I went through the official Kubernetes documentation: <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>Configure a Security Context for a Pod or Container</a>.</p><p>From there I did some research to see how I could apply this for my own projects, for example <a href=https://github.com/mathieu-benoit/myblog>myblog - <code>nginx</code></a> and <a href=https://github.com/mathieu-benoit/MyMonthlyBlogArticle.Bot>MyMonthlyBlogArticle.Bot - <code>dotnetcore</code></a>.</p><p>And I found these very insightful resources:</p><ul><li><a href=https://github.com/Lybecker/k8s-friendly-aspnetcore>Sample project for a Kubernetes friendly ASP.NET core application</a></li><li><a href=https://blog.asksven.io/posts/securing-kubernetes-configuration>Securing you kubernetes configuration (with Nginx). Not so simple!</a><ul><li><em>I agree with this statement &ldquo;Not so simple!&rdquo;.</em></li></ul></li></ul><p>So here are the results of my own implementations based on this:</p><ul><li><a href=https://github.com/mathieu-benoit/myblog/pull/6>PR to implement this with myblog</a><ul><li><code>Dockerfile</code> to have the official base image <code>nginxinc/nginx-unprivileged</code></li><li>Container&rsquo;s port as <code>8080</code> instead of <code>80</code></li><li><code>podSecurityContext</code> with <code>securityContext.capabilities.drop: all</code>, <code>runAsNonRoot: true</code>, <code>allowPrivilegeEscalation: false</code>, <code>automountServiceAccountToken: false</code> and <code>readOnlyRootFilesystem: true</code></li><li>Mount <code>tmp</code> as <code>emptyDir</code> on Kubernetes</li></ul></li><li><a href=https://github.com/mathieu-benoit/MyMonthlyBlogArticle.Bot/pull/35>PR to implement this with MyMonthlyBlogArticle.Bot</a><ul><li><code>Dockerfile</code> to have these environment variables: <code>ENV ASPNETCORE_URLS=http://+:5000</code> and <code>COMPlus_EnableDiagnostics=0</code></li><li>Container&rsquo;s port as <code>5000</code> instead of <code>80</code></li><li><code>podSecurityContext</code> with <code>securityContext.capabilities.drop: all</code>, <code>runAsNonRoot: true</code>, <code>allowPrivilegeEscalation: false</code>, <code>automountServiceAccountToken: false</code> and <code>readOnlyRootFilesystem: true</code></li></ul></li></ul><p>Notes: you could locally test your Docker container with:</p><ul><li><code>docker run --read-only --cap-drop=ALL --user=1000</code> to anticipate few options on Kubernetes listed above</li><li><code>docker diff</code> on your running container to see if there is any folder it is writing in that you could mount as <code>emptyDir</code> on Kubernetes</li><li>If you are using Istio, you will get an issue with the <code>istio-proxy</code> sidecar if you are using <code>automountServiceAccountToken: false</code>. The sidecar needs a <a href=https://github.com/istio/istio/issues/22193>service account token to talk to the control plane</a></li></ul><p>Now on a policy or governance standpoint, how to control this across your kubernetes deployments? That&rsquo;s where you could <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster#admission_controllers>Use admission controllers to enforce policy</a>.</p><p>As an illustration, you could also read <a href=https://cloud.google.com/blog/products/containers-kubernetes/how-gvisor-protects-google-cloud-services-from-cve-2020-14386>here about the CVE-2020-14386</a>, uses the <code>CAP_NET_RAW</code> capability of the Linux kernel to cause memory corruption, allowing an attacker to gain root access when they should not have. And that&rsquo;s also a good opportunity to learn more about the investments and innovations Google is doing on an open source and security perspectives: the <a href=https://cloud.google.com/blog/products/gcp/open-sourcing-gvisor-a-sandboxed-container-runtime><code>gVisor</code> project</a> is a great example.</p><p>Hope you enjoyed and learned something with this blog article and you will be able to leverage these resources for your own context and security posture!</p><p>Cheers! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/05/myblog/><span class=button__icon>←</span>
<span class=button__text>hello, cloud native hugo blog!</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/03/private-aks-and-acr/><span class=button__text>private aks and private acr, safer you are</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>