<!doctype html><html lang=en><head><title>demo bank on gke ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Today we&amp;rsquo;ll deploy the Demo Bank source code on a GKE cluster. This source code was leveraged during one of the keynotes of Google Next OnAir 2020, App Modernization week: Hands-on Keynote: Building trust for speedy innovation.
Demo Bank (aka Bank of Anthos) is a sample HTTP-based web app that simulates a bank&amp;rsquo;s payment processing network, allowing users to create artificial bank accounts and complete transactions.
Service Language Description frontend Python Exposes an HTTP server to serve the website."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=mathieu-benoit.github.io/posts/2020/10/demo-bank/><link rel=stylesheet href=mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=mathieu-benoit.github.io/img/favicon.png><link href=mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="demo bank on gke"><meta name=twitter:description content="let's see how to deploy the demo bank (aka bank of anthos) solution on gke, w/ or w/o workload identity"><meta property="og:title" content="demo bank on gke"><meta property="og:description" content="let's see how to deploy the demo bank (aka bank of anthos) solution on gke, w/ or w/o workload identity"><meta property="og:type" content="article"><meta property="og:url" content="mathieu-benoit.github.io/posts/2020/10/demo-bank/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-29T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-29T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=mathieu-benoit.github.io/about/>about</a></li><li><a href=mathieu-benoit.github.io/presentations/>presentations</a></li><li><a href=mathieu-benoit.github.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=mathieu-benoit.github.io/about/>about</a></li><li><a href=mathieu-benoit.github.io/presentations/>presentations</a></li><li><a href=mathieu-benoit.github.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>demo bank on gke</h1><div class=post-meta><span class=post-date>2020-10-29</span></div><span class=post-tags><a href=mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;</span><div class=post-content><p><img src=https://github.com/GoogleCloudPlatform/bank-of-anthos/raw/main/docs/architecture.png alt="Architecture diagram of the Demo Bank demo repository showing the 8 microservices and their dependencies."></p><p>Today we&rsquo;ll deploy the <a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/><code>Demo Bank</code> source code</a> on a GKE cluster. This source code was leveraged during one of the keynotes of <a href=mathieu-benoit.github.io/posts/2020/08/app-modernization-google-next-2020/>Google Next OnAir 2020, App Modernization week</a>: <a href=https://youtu.be/7QR1z35h_yc>Hands-on Keynote: Building trust for speedy innovation</a>.</p><blockquote><p><code>Demo Bank</code> (aka <code>Bank of Anthos</code>) is a sample HTTP-based web app that simulates a bank&rsquo;s payment processing network, allowing users to create artificial bank accounts and complete transactions.</p></blockquote><table><thead><tr><th>Service</th><th>Language</th><th>Description</th></tr></thead><tbody><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/frontend>frontend</a></td><td>Python</td><td>Exposes an HTTP server to serve the website. Contains login page, signup page, and home page</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/ledgerwriter>ledger-writer</a></td><td>Java</td><td>Accepts and validates incoming transactions before writing them to the ledger</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/balancereader>balance-reader</a></td><td>Java</td><td>Provides efficient readable cache of user balances, as read from <code>ledger-db</code></td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/transactionhistory>transaction-history</a></td><td>Java</td><td>Provides efficient readable cache of past transactions, as read from <code>ledger-db</code></td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/ledger-db>ledger-db</a></td><td>PostgreSQL</td><td>Ledger of all transactions. Option to pre-populate with transactions for demo users</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/userservice>user-service</a></td><td>Python</td><td>Manages user accounts and authentication. Signs JWTs used for authentication by other services</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/contacts>contacts</a></td><td>Python</td><td>Stores list of other accounts associated with a user. Used for drop down in &ldquo;Send Payment&rdquo; and &ldquo;Deposit&rdquo; forms</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/accounts-db>accounts-db</a></td><td>PostgreSQL</td><td>Database for user accounts and associated data. Option to pre-populate with demo users</td></tr><tr><td><a href=https://github.com/GoogleCloudPlatform/bank-of-anthos/tree/main/src/loadgenerator>loadgenerator</a></td><td>Python/Locust</td><td>Continuously sends requests imitating users to the frontend. Periodically creates new accounts and simulates transactions between them</td></tr></tbody></table><pre tabindex=0><code>git clone https://github.com/GoogleCloudPlatform/bank-of-anthos.git
cd bank-of-anthos

# Assumption here that you already have a GCP project and a GKE cluster in it
projectId=FIXME
clusterName=FIXME
clusterZone=FIXME
gcloud config set project $projectId
gcloud container clusters get-credentials $clusterName \
    --zone $clusterZone

# Create a dedicated namespace
namespace=bank
kubectl create ns $namespace
kubectl config set-context \
    --current \
    --namespace $namespace
</code></pre><p>Now, I provide 3 options with associated script to deploy this solution on GKE:</p><ul><li><a href=#deployment-on-gke-with-pre-built-images>With pre-built images</a></li><li><a href=#deployment-on-gke-with-custom-and-private-images>With custom and private images</a></li><li><a href=#deployment-on-gke-with-workload-identity>With Workload Identity</a></li></ul><h2 id=deployment-on-gke-with-pre-built-images>Deployment on GKE with pre-built images
<a href=#deployment-on-gke-with-pre-built-images class=h-anchor aria-hidden=true>#</a></h2><pre tabindex=0><code>kubectl apply \
    -f ./extras/jwt/jwt-secret.yaml
kubectl apply \
    -f ./kubernetes-manifests
kubectl get all,secrets,configmaps
kubectl get service frontend | awk &#39;{print $4}&#39;
</code></pre><h2 id=deployment-on-gke-with-custom-and-private-images>Deployment on GKE with custom and private images
<a href=#deployment-on-gke-with-custom-and-private-images class=h-anchor aria-hidden=true>#</a></h2><p>In some cases you may need to only deploy container images coming from your own private container registry, for example if you have your GKE cluster leveraging <a href=mathieu-benoit.github.io/posts/2020/11/binauthz/>Binary Authorization</a>.</p><pre tabindex=0><code>publicContainerRegistry=gcr.io/bank-of-anthos-ci
privateContainerRegistry=us-east4-docker.pkg.dev/$projectId/containers/bank-of-anthos
services=&#34;accounts-db balancereader contacts frontend ledger-db ledgerwriter loadgenerator transactionhistory userservice&#34;
imageTag=$(curl -s https://api.github.com/repos/GoogleCloudPlatform/bank-of-anthos/releases | jq -r &#39;[.[]] | .[0].tag_name&#39;)

# Copy the pre-built images into your own private GCR:
for s in $services; do docker pull $publicContainerRegistry/$s:$imageTag; docker tag $publicContainerRegistry/$s:$imageTag $privateContainerRegistry/$s:$imageTag; docker push $privateContainerRegistry/$s:$imageTag; done

# Update the Kubernetes manifests with these new container images
cd kubernetes-manifests
mv transaction-history.yaml transactionhistory.yaml; mv ledger-writer.yaml ledgerwriter.yaml; mv balance-reader.yaml balancereader.yaml # tmp to have consistent namings to properly execute the next command.
for s in $services; do sed -i &#34;s,image: $publicContainerRegistry/$s:$imageTag,image: $privateContainerRegistry/$s:$imageTag,g&#34; $s.yaml; done
cd ..

# Deploy the solution
kubectl apply \
    -f ./extras/jwt/jwt-secret.yaml
kubectl apply \
    -f ./kubernetes-manifests
kubectl get all,secrets,configmaps,sa
kubectl get service frontend | awk &#39;{print $4}&#39;
</code></pre><p><em>Note: Instead of moving the container images from the public registry to your own private registry, you may want to leverage both <code>Docker</code> and <a href=https://github.com/GoogleContainerTools/jib#jib><code>Jib</code></a> to build your own container images from the source code.</em></p><h2 id=deployment-on-gke-with-workload-identity>Deployment on GKE with Workload Identity
<a href=#deployment-on-gke-with-workload-identity class=h-anchor aria-hidden=true>#</a></h2><p><em>Note: It&rsquo;s highly recommended to have your GKE clusters with Workload Identity enabled, I discussed about the why and how if you are interested in knowing more, here: <a href=mathieu-benoit.github.io/posts/2020/10/gke-service-account/>GKE’s service account</a>.</em></p><pre tabindex=0><code># Create a dedicated service account
ksaName=bank-ksa
kubectl create serviceaccount $ksaName
gsaName=$projectId-bank-gsa
gsaAccountName=$gsaName@$projectId.iam.gserviceaccount.com
gcloud iam service-accounts create $gsaName
gcloud iam service-accounts add-iam-policy-binding \
    --role roles/iam.workloadIdentityUser \
    --member &#34;serviceAccount:$projectId.svc.id.goog[$namespace/$ksaName]&#34; \
    $gsaAccountName
kubectl annotate serviceaccount \
    $ksaName \
    iam.gke.io/gcp-service-account=$gsaAccountName
roles=&#34;roles/cloudtrace.agent roles/monitoring.metricWriter&#34;
for r in $roles; do gcloud projects add-iam-policy-binding $projectId --member &#34;serviceAccount:$gsaAccountName&#34; --role $r; done

# Update the Kubernetes manifests with this service account
files=&#34;`pwd`/kubernetes-manifests/*&#34;
for f in $files; do sed -i &#34;s/serviceAccountName: default/serviceAccountName: $ksaName/g&#34; $f; done

# Deploy the solution
kubectl apply \
    -f ./extras/jwt/jwt-secret.yaml
kubectl apply \
    -f ./kubernetes-manifests
kubectl get all,secrets,configmaps,sa
kubectl get service frontend | awk &#39;{print $4}&#39;
</code></pre><p>That&rsquo;s a wrap! We now have handy scripts for the <code>Demo Bank</code> (aka <code>Bank of Anthos</code>) solution, ready to be deployed on both GKE w/ or w/o Workload Identity.</p><p>Hope you enjoyed that one, happy sailing, cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=mathieu-benoit.github.io/posts/2020/11/binauthz/><span class=button__icon>←</span>
<span class=button__text>binary authorization on gke</span></a></span>
<span class="button next"><a href=mathieu-benoit.github.io/posts/2020/10/confidential-computing/><span class=button__text>confidential computing with gke</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=mathieu-benoit.github.io/assets/main.js></script>
<script src=mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>