<!doctype html><html lang=en><head><title>gke's service account ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I just went through the description of this CVE-2020-15157 &amp;ldquo;ContainerDrip&amp;rdquo; Write-up. I found these information very insightful especially since there is some illustrations and great story with GKE.
CVE-2020-15157: If an attacker publishes a public image with a crafted manifest that directs one of the image layers to be fetched from a web server they control and they trick a user or system into pulling the image, they can obtain the credentials used by ctr/containerd to access that registry."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2020/10/gke-service-account/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="gke's service account"><meta name=twitter:description content="let's discuss about how to deal with gke's service account and few tips to improve your security posture, especially with fine-grained identity and authorization for applications with workload identity"><meta property="og:title" content="gke's service account"><meta property="og:description" content="let's discuss about how to deal with gke's service account and few tips to improve your security posture, especially with fine-grained identity and authorization for applications with workload identity"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2020/10/gke-service-account/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-18T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-18T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>gke&rsquo;s service account</h1><div class=post-meta><span class=post-date>2020-10-18</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;</span><div class=post-content><p><img src=https://storage.googleapis.com/gweb-cloudblog-publish/images/GCP_Security_kLUG9v5.max-2200x2200.jpg alt="Representation of security with a shield and a padlock on it."></p><p>I just went through the description of this <a href=https://darkbit.io/blog/cve-2020-15157-containerdrip>CVE-2020-15157 &ldquo;ContainerDrip&rdquo; Write-up</a>. I found these information very insightful especially since there is some illustrations and great story with GKE.</p><blockquote><p><a href=https://nvd.nist.gov/vuln/detail/CVE-2020-15157>CVE-2020-15157</a>: If an attacker publishes a public image with a crafted manifest that directs one of the image layers to be fetched from a web server they control and they trick a user or system into pulling the image, they can obtain the credentials used by <code>ctr/containerd</code> to access that registry. In some cases, this may be the user’s username and password for the registry. In other cases, this may be the credentials attached to the cloud virtual instance which can grant access to other cloud resources in the account.</p></blockquote><p>Interesting! By going through the description of this CVE you could find that it&rsquo;s an old version of <code>containerd</code> (i.e. <code>1.2.x</code>) which is impacted. With GKE, if you are using the <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/using-containerd><code>cos_containerd</code> or <code>ubuntu_containerd</code> node images</a>, it&rsquo;s an old <code>1.16</code> version which might be impacted too.</p><p>How to check if you are impacted if you are using a <code>containerd</code> node image, you could simply check the <code>containerd</code>&rsquo;s version of your GKE cluster by running this command: <code>kubectl get nodes -o wide</code>. As an example, for my own cluster I got:</p><ul><li><code>OS-IMAGE</code>: <code>Container-Optimized OS from Google</code></li><li><code>CONTAINER-RUNTIME</code>: <code>containerd://1.4.1</code></li></ul><p>So all good here, but nonetheless the goal of this article today is to see what are the features you could leverage to make a robust security posture.</p><p>There is already 2 important aspects to improve your security posture here:</p><ul><li><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-upgrades>Auto-upgrading nodes</a><ul><li><em>Keeping the version of Kubernetes up to date is one of the simplest things you can do to improve your security. Kubernetes frequently introduces new security features and provides security patches.</em></li></ul></li><li><a href=https://cloud.google.com/container-optimized-os/docs/concepts/security><code>cos_containerd</code></a><ul><li><em><code>cos_containerd</code> is the preferred image for GKE as it has been custom built, optimized, and hardened specifically for running containers.</em></li></ul></li></ul><p>I also watched the video below which is referenced in the <a href=https://darkbit.io/blog/cve-2020-15157-containerdrip>first article I mentioned</a>. As I&rsquo;m improving my knowledge and skills with cloud security principles, such approach and point of view from an hacker perspective is really insightful. Here below, they are talking about <a href=https://youtu.be/Z-JFVJZ-HDA>lateral movement and privilege escalation in GCP</a>:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/Z-JFVJZ-HDA style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="DEF CON Safe Mode - Dylan Ayrey and Allison Donovan - Lateral Movement & Privilege Escalation in GCP"></iframe></div><p>There is 3 important aspects to improve your security posture here:</p><ul><li><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster#use_least_privilege_sa>Default node service account and Workload Identity</a><ul><li><em>This <code>Compute Engine default service account</code> is overprivileged by default as the <a href=https://cloud.google.com/iam/docs/understanding-roles#primitive_role_definitions>Editor role</a> allows you to access and edit essentially everything in the project.</em></li><li>You could <a href=https://cloud.google.com/resource-manager/docs/organization-policy/restricting-service-accounts#disable_service_account_default_grants>disable automatic grants to default service accounts</a> at your Organization Policies level.</li><li>Here, I would like to call out <a href=https://code.kiwi.com/towards-secure-by-default-google-cloud-platform-service-accounts-244ad9fc772>this very well written article</a> to see the impacts of this and some real life examples of companies hacked because they didn&rsquo;t pay attention of this least privilege principle for the identity of their clusters or applications.</li></ul></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity>Workload Identity</a><ul><li><em>Workload Identity is the recommended way to access Google Cloud services from applications running within GKE due to its improved security properties and manageability.</em></li></ul></li><li><a href=https://cloud.google.com/iam/docs/recommender-overview>IAM Recommender</a><ul><li><em>IAM recommender helps you enforce the principle of least privilege by ensuring that members have only the permissions that they actually need.</em></li><li>Great story here where the 2 authors provided improvements to the product group team managing the new IAM Recommender service. Love it!</li></ul></li></ul><p>Let&rsquo;s translate this least privilege setup for the identity of your nodes and workloads with few <code>gcloud</code> commands:</p><pre tabindex=0><code>projectId=FIXME
clusterName=FIXME

# First we need to enable the Kubernetes API on the current project
gcloud services enable container.googleapis.com
# Delete the default compute engine service account if you don&#39;t have have the Org policy iam.automaticIamGrantsForDefaultServiceAccounts in place
projectNumber=&#34;$(gcloud projects describe $projectId --format=&#39;get(projectNumber)&#39;)&#34;
gcloud iam service-accounts delete $projectNumber-compute@developer.gserviceaccount.com --quiet

# Then we need to create a dedicated service account (instead of the default one with Editor role on the project) with the least privilege:
gcloud services enable cloudresourcemanager.googleapis.com
saId=$clusterName@$projectId.iam.gserviceaccount.com
gcloud iam service-accounts create $clusterName \
    --display-name=$clusterName
roles=&#34;roles/logging.logWriter roles/monitoring.metricWriter roles/monitoring.viewer&#34;
for r in $roles; do gcloud projects add-iam-policy-binding $projectId --member &#34;serviceAccount:$saId&#34; --role $r; done

# Now you could create your cluster with this service account:
gcloud container clusters create $clusterName \
    --service-account=$saId

# Interestingly, you could have a different service account by nodepool (important if you would like to have different workloads on different node pools):
gcloud container node-pools create \
    --service-account=$saId

# And ultimately, you could enable Workload Identity on your cluster (which is even more important for fine-grained identity and authorization for applications):
gcloud container clusters create $clusterName \
    --service-account $saId \
    --workload-pool=$projectId.svc.id.goog
</code></pre><p>Then you could easily <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#authenticating_to>follow these instructions</a> to allow your applications authenticate to Google Cloud using Workload Identity, typically by assigning a Kubernetes service account to the application and configure it to act as a Google service account.</p><blockquote><p>With <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity>Workload Identity</a>, you can configure a Kubernetes service account to act as a Google service account. Any application running as the Kubernetes service account automatically authenticates as the Google service account when accessing Google Cloud APIs. This enables you to assign fine-grained identity and authorization for applications in your cluster.</p></blockquote><p><em>Note: there is <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#limitations>few limitations currently with Workload Identity</a> that you should be aware of.</em></p><p>You could learn more about <a href=https://cloud.google.com/blog/products/containers-kubernetes/introducing-workload-identity-better-authentication-for-your-gke-applications>Workload Identity with this session when it was launched on 2019</a>:<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/s4NYEJDFc0M style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="Keyless Entry: Securely Access GCP Services From Kubernetes (Cloud Next '19)"></iframe></div></p><p>In addition to this, here are 3 other aspects to still improve and complete your security posture that you may want to leverage:</p><ul><li><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/shielded-gke-nodes>Shielded GKE Nodes</a><ul><li><em>Without Shielded GKE Nodes an attacker can exploit a vulnerability in a Pod to exfiltrate bootstrap credentials and impersonate nodes in your cluster, giving the attackers access to cluster secrets.</em></li></ul></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/private-cluster-concept>Private clusters</a><ul><li><em>Private clusters give you the ability to isolate nodes from having inbound and outbound connectivity to the public internet. This isolation is achieved as the nodes have internal IP addresses only.</em></li></ul></li><li><a href=https://cloud.google.com/binary-authorization>Binary Authorization</a><ul><li><em>Binary Authorization is a deploy-time security control that ensures only trusted container images are deployed on GKE.</em></li></ul></li></ul><p>Complementary resources:</p><ul><li><a href=https://blog.aquasec.com/cve-2020-15157-containerd-container-vulnerability>CVE-2020-15157: Vulnerability in Containerd Can Leak Cloud Credentials</a></li><li><a href=https://cloud.google.com/solutions/prep-kubernetes-engine-for-prod>Preparing a Google Kubernetes Engine environment for production</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster>Hardening your cluster&rsquo;s security</a></li><li><a href=https://cloud.google.com/blog/products/identity-security/preventing-lateral-movement-in-google-compute-engine>Preventing lateral movement in Google Compute Engine</a></li><li><a href=https://cloud.google.com/blog/products/identity-security/dont-get-pwned-practicing-the-principle-of-least-privilege>Don&rsquo;t get pwned: practicing the principle of least privilege</a></li><li><a href=https://cloud.google.com/blog/products/containers-kubernetes/how-gvisor-protects-google-cloud-services-from-cve-2020-14386>gVisor: Protecting GKE and serverless users in the real world</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/security-bulletins>GKE Security bulletins</a></li><li><a href=https://medium.com/@jryancanty/stop-downloading-google-cloud-service-account-keys-1811d44a97d9>Stop Downloading Google Cloud Service Account Keys!</a></li></ul><p>That&rsquo;s a wrap! We discussed about features you could enable on your GKE cluster (especially with Workload Identity) and more importantly the concept of least privilege service account instead of the default one for your GKE clusters. Yeah for sure, you could say to yourself &ldquo;how an hacker could get my cluster credentials to be able to operate such attack?&rdquo;. Yeah that&rsquo;s for sure something which won&rsquo;t happen every day, but it&rsquo;s only a matter of worst case scenario + making sure you have different security layers in place to improve your security posture. How do you think data leaks and exfiltrations happen? How do you make sure you could prevent data leaks and exfiltrations in your organization?</p><p><em>Important note: this article got illustrations with GKE, but they apply for any Kubernetes, on any Cloud provider since they got very similar implementation, principles and features.</em></p><p>Hope you enjoyed that one. Sharing is caring, stay safe! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2020/10/gcp-caf/><span class=button__icon>←</span>
<span class=button__text>cloud adoption framework with gcp</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2020/10/the-lean-startup/><span class=button__text>the lean startup</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>