<!doctype html><html lang=en><head><title>secure your apps and your cluster with anthos service mesh ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Even if I already covered how to protect your service mesh with an HTTPS GCLB and Cloud Armor, I thought I will describe in more details what are your other options to protect your workloads on GKE thanks to Anthos Service Mesh (ASM) and Istio.
Here are 7 easy steps to accomplish this:
Install ASM on your cluster Enable ASM for your apps Enable mTLS STRICT for your apps Configure a Sidecar for your mesh Define AuthorizationPolicies for your apps Leverage an HTTPS GCLB and Cloud Armor in front of your IngressGateway Complementary considerations Let&amp;rsquo;s see those in actions."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog/posts/2021/11/asm-security/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="secure your apps and your cluster with anthos service mesh"><meta name=twitter:description content="let's see how you could protect and secure both your apps and your cluster with anthos service mesh (asm)"><meta property="og:title" content="secure your apps and your cluster with anthos service mesh"><meta property="og:description" content="let's see how you could protect and secure both your apps and your cluster with anthos service mesh (asm)"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog/posts/2021/11/asm-security/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-11T00:00:00+00:00"><meta property="article:modified_time" content="2021-11-11T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog/about/>about</a></li><li><a href=/myblog/presentations/>presentations</a></li><li><a href=/myblog/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog/about/>about</a></li><li><a href=/myblog/presentations/>presentations</a></li><li><a href=/myblog/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>secure your apps and your cluster with anthos service mesh</h1><div class=post-meta><span class=post-date>2021-11-11</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/service-mesh/>#service-mesh</a>&nbsp;</span><div class=post-content><p>Even if I already covered how to <a href=https://mathieu-benoit.github.io/myblog/posts/2021/04/cloud-armor/>protect your service mesh with an HTTPS GCLB and Cloud Armor</a>, I thought I will describe in more details what are your other options to protect your workloads on GKE thanks to Anthos Service Mesh (ASM) and Istio.</p><p>Here are 7 easy steps to accomplish this:</p><ol><li>Install ASM on your cluster</li><li>Enable ASM for your apps</li><li>Enable mTLS <code>STRICT</code> for your apps</li><li>Configure a <code>Sidecar</code> for your mesh</li><li>Define <code>AuthorizationPolicies</code> for your apps</li><li>Leverage an HTTPS GCLB and Cloud Armor in front of your <code>IngressGateway</code></li><li>Complementary considerations</li></ol><p>Let&rsquo;s see those in actions.</p><h2 id=install-asm>Install ASM
<a href=#install-asm class=h-anchor aria-hidden=true>#</a></h2><p><a href=https://cloud.google.com/service-mesh/docs/overview>Anthos Service Mesh</a> has a suite of features and tools that help you observe and manage secure, reliable services in a unified way.</p><pre tabindex=0><code>curl https://storage.googleapis.com/csm-artifacts/asm/asmcli_1.12 &gt; ~/asmcli
chmod +x ~/asmcli
cat &lt;&lt;EOF &gt; ditroless-proxy.yaml
---
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  meshConfig:
    defaultConfig:
      image:
        imageType: distroless
EOF
~/asmcli install \
    --project_id $projectId \
    --cluster_name $clusterName \
    --cluster_location $zone \
    --enable-all \
    --option cni-gcp \
    --custom_overlay distroless-proxy.yaml
</code></pre><p>Using <code>--custom_overlay distroless-proxy.yaml</code> to define <code>meshConfig.defaultConfig.image.imageType: distroless</code> is new <a href=https://mathieu-benoit.github.io/myblog/posts/2021/12/distroless-asm-proxy/>since ASM 1.12</a>. The distroless base image ensures that the proxy image contains the minimal number of packages required to run the proxy. This improves security posture by reducing the overall attack surface of the image.</p><p>Using <code>--option cni-gcp</code> is giving you more security because the <a href=https://istio.io/latest/docs/setup/additional-setup/cni/>Istio CNI</a> plugin replaces the functionality provided by the <code>istio-init</code> container (which has elevated permissions).</p><h2 id=enable-asm>Enable ASM
<a href=#enable-asm class=h-anchor aria-hidden=true>#</a></h2><p>In order to take advantage of all of ASM/Istio’s features, pods in the mesh must be running an ASM <a href=https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/>sidecar proxy</a>.</p><pre tabindex=0><code>namespace=onlineboutique
asmRevision=$(kubectl get deploy -n istio-system -l app=istiod -o jsonpath={.items[*].metadata.labels.&#39;istio\.io\/rev&#39;}&#39;{&#34;\n&#34;}&#39;)
kubectl label namespace $namespace \
    istio-injection- istio.io/rev=$asmRevision \
    --overwrite
</code></pre><p>To actually inject the sidecar proxy, we need to force a deployment of your apps on this specific namespace:</p><pre tabindex=0><code>kubectl rollout restart deployments -n $namespace
</code></pre><h2 id=enable-mtls-strict>Enable mTLS STRICT
<a href=#enable-mtls-strict class=h-anchor aria-hidden=true>#</a></h2><p>Istio <a href=https://istio.io/latest/docs/reference/config/security/peer_authentication/><code>PeerAuthentication</code></a> defines how traffic will be tunneled (or not) to the sidecar.</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -n $namespace -f -
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
 name: default
spec:
 mtls:
   mode: STRICT
EOF
</code></pre><h2 id=configure-a-sidecar>Configure a Sidecar
<a href=#configure-a-sidecar class=h-anchor aria-hidden=true>#</a></h2><p>Istio <a href=https://istio.io/latest/docs/reference/config/networking/sidecar/><code>Sidecar</code></a> describes the configuration of the sidecar proxy that mediates inbound and outbound communication to the workload instance it is attached to. This feature is quite easy to configure and has two large benefits: Security and Performance. I explain this in more details <a href=https://mathieu-benoit.github.io/myblog/posts/2021/12/istio-sidecar/>here</a>.</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -n istio-system -f -
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: default
spec:
  egress:
  - hosts:
    - &#34;./*&#34;
    - &#34;istio-system/*&#34;
EOF
</code></pre><h2 id=define-authorizationpolicies>Define AuthorizationPolicies
<a href=#define-authorizationpolicies class=h-anchor aria-hidden=true>#</a></h2><p>Istio <a href=https://istio.io/latest/docs/reference/config/security/authorization-policy/><code>AuthorizationPolicy</code></a> enables access control on workloads in the mesh.</p><p>First, we need to deny all the ingress traffic to any pod in that namespace:</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -n $namespace -f -
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
spec:
  {}
EOF
</code></pre><p>Then, we need to granularly give access to certain pods to communicate between each others, only where needed. The following example gives both <code>frontend</code> and <code>checkoutservice</code> to reach out to <code>cartservice</code> only on specific operations:</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -n $namespace -f -
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: cartservice
spec:
  selector:
    matchLabels:
      app: cartservice
  rules:
  - from:
    - source:
        principals: [&#34;cluster.local/ns/onlineboutique/sa/frontend&#34;, &#34;cluster.local/ns/onlineboutique/sa/checkoutservice&#34;]
    to:
      - operation:
          paths: [&#34;/hipstershop.CartService/AddItem&#34;, &#34;/hipstershop.CartService/GetCart&#34;, &#34;/hipstershop.CartService/EmptyCart&#34;]
          methods: [&#34;POST&#34;]
EOF
</code></pre><p>You could see that we identify the sources with a specific <code>ServiceAccount</code> for each pod/app. You could find other <code>AuthorizationPolicy</code> and <code>ServiceAccount</code> definitions for each app of the OnlineBoutique <a href=https://github.com/mathieu-benoit/my-kubernetes-deployments/tree/main/namespaces/onlineboutique>in there</a>.</p><h2 id=leverage-an-https-gclb-and-cloud-armor-in-front-of-your-ingressgateway>Leverage an HTTPS GCLB and Cloud Armor in front of your IngressGateway
<a href=#leverage-an-https-gclb-and-cloud-armor-in-front-of-your-ingressgateway class=h-anchor aria-hidden=true>#</a></h2><p>To start let&rsquo;s create a Cloud Armor policy:</p><pre tabindex=0><code>policyName=asm-ingressgateway
gcloud compute security-policies create $policyName \
    --description &#34;Block XSS attacks&#34;
gcloud compute security-policies rules create 1000 \
    --security-policy $policyName \
    --expression &#34;evaluatePreconfiguredExpr(&#39;xss-stable&#39;)&#34; \
    --action &#34;deny-403&#34; \
    --description &#34;XSS attack filtering&#34;
</code></pre><p>Then, let&rsquo;s create a public static IP address:</p><pre tabindex=0><code>ipName=asm-ingressgateway
gcloud compute addresses create $ipName --global
ipAddress=$(gcloud compute addresses describe $ipName --global --format=json | jq -r &#39;.address&#39;)
echo $ipAddress
</code></pre><p>From here, you could bring your own DNS and set the IP address provisioned previously, or as an example you could run the following commands to get a DNS from Cloud Endpoint:</p><pre tabindex=0><code>projectId=FIXME
hostName=onlineboutique.endpoints.$projectId.cloud.goog
cat &lt;&lt;EOF &gt; dns-spec.yaml
swagger: &#34;2.0&#34;
info:
  description: &#34;Cloud Endpoints DNS&#34;
  title: &#34;Cloud Endpoints DNS&#34;
  version: &#34;1.0.0&#34;
paths: {}
host: &#34;${hostName}&#34;
x-google-endpoints:
- name: &#34;${hostName}&#34;
  target: &#34;${ipAddress}&#34;
EOF
gcloud endpoints services deploy dns-spec.yaml
</code></pre><p>With that, we could now deploy our <a href=https://gist.github.com/mathieu-benoit/19c020c9a1cbe19e0541316502358f91>Kubernetes manifest</a> containing all the object needed to deploy our ingress gateway (<code>Deployment</code>, <code>Service</code>, <code>Ingress</code>, <code>BackendConfig</code>, <code>ManagedCertificate</code> and <code>Gateway</code>):</p><pre tabindex=0><code>ingressNamespace=asm-ingress
kubectl create ns $ingressNamespace
kubectl label namespace $ingressNamespace istio-injection- istio.io/rev=$asmRevision --overwrite
curl https://gist.githubusercontent.com/mathieu-benoit/19c020c9a1cbe19e0541316502358f91/raw/9481474a45b12b14c9b21403e0d472140b5cd448/asm-ingress.yaml &gt; asm-ingress.yaml
sed -i &#34;s,SECURITY_POLICY,${policyName},g;s,HOST_NAME,${hostName},g;s,IP_NAME,${ipName},g&#34; asm-ingress.yaml
kubectl apply -n $ingressNamespace -f asm-ingress.yaml
</code></pre><p><em>Note: Gateways are generally owned by the platform admins or network admins team. Therefore, the <a href=https://istio.io/latest/docs/setup/additional-setup/gateway/#shared-gateway>shared <code>Gateway</code></a> resource is created in the <code>asm-ingress</code> namespace owned by the platform admin.</em></p><p>Finally, we need to apply a <code>VirtualService</code> configuration to the <code>asm-ingressgateway</code> proxy to manage inbound traffic for the OnlineBoutique&rsquo;s <code>frontend</code> service:</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -n $namespace -f -
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend
spec:
  hosts:
  - &#34;${hostName}&#34;
  gateways:
  - frontend
  http:
  - route:
    - destination:
        host: frontend
        port:
          number: 80
EOF
</code></pre><p><em>Note: The <code>VirtualService</code> is created in the application namespace. Typically, the application owner decides and configures how and what traffic gets routed to the application so <code>VirtualService</code> is deployed by the app owner.</em></p><p>After waiting for a couple of minutes, all the infrastructure will be provisioned and you should be able to successfully reach your DNS (i.e. https://$hostName), on a secure manner ;)</p><p><em>Note: there is two other scenario you could leverage by exposing your <code>IngressGateway</code>, either via an <a href=https://cloud.google.com/service-mesh/docs/unified-install/options/enable-optional-features#enable_an_internal_load_balancer>internal load balancer</a> or even via a <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/internal-load-balancing#ilb_psc>private service connect</a>, if you don&rsquo;t want to publicly expose your apps via the <code>IngressGateway</code>.</em></p><p>And voila, that&rsquo;s a wrap!</p><p>Ultimately, here is the secure setup we have been describing with this blog article, the OnlineBoutique demo is now more secured. Hope you will be able to leverage this for your own apps/setup.</p><p><img src=https://raw.githubusercontent.com/mathieu-benoit/my-images/main/asm-security.png alt="Secured OnlineBoutique with advanced ASM setup discussed throughout that blog article."></p><h2 id=complementary-considerations>Complementary considerations
<a href=#complementary-considerations class=h-anchor aria-hidden=true>#</a></h2><ul><li>Explore <a href=https://cloud.google.com/service-mesh/docs/observability/explore-dashboard>ASM in the Cloud Console</a> (Topology, SLIs/SLOs, etc.)</li><li>Configure OPA Gatekeeper policies with <a href=https://mathieu-benoit.github.io/myblog/posts/2021/03/policy-controller/>Policy Controller</a> for more governance and security</li><li>Configure <a href=https://mathieu-benoit.github.io/myblog/posts/2021/04/gke-cilium/>Network Policies</a> for a strong defense in depth strategy</li></ul><p>Hope you enjoyed that one, stay safe out there! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog/posts/2021/11/policy-controller-ci/><span class=button__icon>←</span>
<span class=button__text>opa gatekeeper and policy controller during continuous integration (ci) pipelines</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog/posts/2021/09/gke-cos-version/><span class=button__text>gke cos version</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>