<!doctype html><html lang=en><head><title>opa gatekeeper and policy controller during continuous integration (ci) pipelines ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Policies are an important part of the security and compliance of an organization. Policy Controller, which is part of Anthos Config Management, allows your organization to manage those policies centrally and declaratively for all your clusters.
Catching policy violations as early as possible in your development workflow and in your CI pipeline instead of during the deployment has two main advantages: it lets you shift left on security, and it tightens the feedback loop, reducing the time and cost necessary to fix those violations."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2021/11/policy-controller-ci/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="opa gatekeeper and policy controller during continuous integration (ci) pipelines"><meta name=twitter:description content="let's see how to shift left on security by catching opa gatekeeper policy violations during continuous integration (ci) pipelines."><meta property="og:title" content="opa gatekeeper and policy controller during continuous integration (ci) pipelines"><meta property="og:description" content="let's see how to shift left on security by catching opa gatekeeper policy violations during continuous integration (ci) pipelines."><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2021/11/policy-controller-ci/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-27T00:00:00+00:00"><meta property="article:modified_time" content="2021-11-27T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>opa gatekeeper and policy controller during continuous integration (ci) pipelines</h1><div class=post-meta><span class=post-date>2021-11-27</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/policies/>#policies</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;</span><div class=post-content><p>Policies are an important part of the security and compliance of an organization. <a href=https://mathieu-benoit.github.io/posts/2021/03/policy-controller/>Policy Controller</a>, which is part of Anthos Config Management, allows your organization to manage those policies centrally and declaratively for all your clusters.</p><p>Catching policy violations as early as possible in your development workflow and in your CI pipeline instead of during the deployment has two main advantages: it lets you shift left on security, and it tightens the feedback loop, reducing the time and cost necessary to fix those violations.</p><p><em>Note: OPA <a href=https://github.com/open-policy-agent/gatekeeper/releases/tag/v3.7.0>Gatekeeper version 3.7</a> just brought the <a href=https://medium.com/@LachlanEvenson/testing-gatekeeper-constraints-with-gator-cli-da31050a6564><code>gator</code> CLI</a> to setup tests suite against Gatekeeper <code>Constraint</code> resources. Interesting, something to keep in mind, but I won&rsquo;t cover this in this blog article today. We will use <code>kpt</code> in our case.</em></p><h2 id=context>Context
<a href=#context class=h-anchor aria-hidden=true>#</a></h2><p>Let&rsquo;s take a simple example that we will use throughout this blog article.</p><p>Let&rsquo;s have a dedicated folder to store the files needed:</p><pre tabindex=0><code>mkdir workdir
</code></pre><p>Let&rsquo;s create a <code>Deployment</code> file:</p><pre tabindex=0><code>cat &lt;&lt;EOF &gt; workdir/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deploy
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: backend
          image: nginx
      securityContext:
        runAsNonRoot: false
EOF
</code></pre><p>Let&rsquo;s then define a <code>ConstraintTemplate</code> file which will catch any deployment running as <code>root</code>:</p><pre tabindex=0><code>cat &lt;&lt;EOF &gt; workdir/template.yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: disallowroot
spec:
  crd:
    spec:
      names:
        kind: DisallowRoot
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |-
        package disallowroot
        violation[{&#34;msg&#34;: msg}] {
          not input.review.object.spec.template.spec.securityContext.runAsNonRoot
          msg := &#34;Containers must not run as root&#34;
        }
EOF
</code></pre><p>Finally we need a <code>Constraint</code> file which will instanciate this <code>ConstraintTemplate</code>:</p><pre tabindex=0><code>cat &lt;&lt;EOF &gt; workdir/constraint.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: DisallowRoot
metadata:
  name: disallowroot
spec:
  match:
    kinds:
      - apiGroups:
          - &#39;apps&#39;
        kinds:
          - Deployment
EOF
</code></pre><h2 id=test-with-kpt>Test with kpt
<a href=#test-with-kpt class=h-anchor aria-hidden=true>#</a></h2><blockquote><p><code>kpt</code> is a Git-native, schema-aware, extensible client-side tool for packaging, customizing, validating, and applying Kubernetes resources.</p></blockquote><p>Let&rsquo;s install <code>kpt</code>:</p><pre tabindex=0><code>curl -L https://github.com/GoogleContainerTools/kpt/releases/download/v1.0.0-beta.9/kpt_linux_amd64 --output kpt
chmod +x kpt
sudo mv kpt /usr/local/bin/kpt
</code></pre><p>We could now test locally our <code>Constraint</code> against our <code>Deployment</code> defined previously with the <a href=https://catalog.kpt.dev/gatekeeper/v0.2/><code>gatekeeper</code> function</a>:</p><pre tabindex=0><code>kpt fn eval --image gcr.io/kpt-fn/gatekeeper:v0.2 workdir/
</code></pre><p>The output will be:</p><pre tabindex=0><code>[RUNNING] &#34;gcr.io/kpt-fn/gatekeeper:v0.2&#34;
[FAIL] &#34;gcr.io/kpt-fn/gatekeeper:v0.2&#34; in 21.2s
  Results:
    [ERROR] Containers must not run as root violatedConstraint: disallowroot in object &#34;apps/v1/Deployment/nginx-deploy&#34; in file &#34;deployment.yaml&#34;
  Stderr:
    &#34;[error] apps/v1/Deployment/nginx-deploy : Containers must not run as root&#34;
    &#34;violatedConstraint: disallowroot&#34;
    &#34;&#34;
  Exit code: 1
</code></pre><p>And voila, that&rsquo;s it! That&rsquo;s how easy it is. The idea is to have all the files needed in one place/folder: the Kubernetes manifests of your apps and both your <code>Constraint</code> and <code>ConstraintTemplate</code> files, as mutilple files or combined in one file.</p><h2 id=integration-with-config-sync>Integration with Config Sync
<a href=#integration-with-config-sync class=h-anchor aria-hidden=true>#</a></h2><p>Now let&rsquo;s say you are using <a href=https://mathieu-benoit.github.io/posts/2021/01/config-sync/>Config Sync</a> to deploy your Kubernetes manifests on a GitOps way. In this case, we need to run a command to hydrate the Git repo with all the Kubernetes manifests.</p><pre tabindex=0><code>nomos hydrate --flat --no-api-server-check --output workdir/hydrated-manifests.yaml
</code></pre><p>And then we could run the following command on this file:</p><pre tabindex=0><code>kpt fn eval --image gcr.io/kpt-fn/gatekeeper:v0.2 workdir/
</code></pre><p><em>Note: If you are enabling <code>templateLibraryInstalled</code> or <code>referentialRulesEnabled</code> when installing Policy Controller on your cluster, the <code>ConstraintTemplate</code> resources are in your cluster. If you have access to your cluster you may want to run this command <code>kubectl get constrainttemplates -o yaml</code> in order to grab the <code>ConstraintTemplate</code> manifest files. But if you don&rsquo;t have access to your cluster (which is the recommended approach if you are doing GitOps), you have to have those manifest files in your repository. That&rsquo;s what I&rsquo;m doing with <a href=https://github.com/mathieu-benoit/my-kubernetes-deployments/tree/main/cluster/policies/templates>my own setup in there</a>.</em></p><h2 id=integration-in-ci-pipelines>Integration in CI pipelines
<a href=#integration-in-ci-pipelines class=h-anchor aria-hidden=true>#</a></h2><p>In your CI pipeline with GitHub actions, here is how it could look like:</p><pre tabindex=0><code>- uses: google-github-actions/setup-gcloud
- name: install kpt and nomos	
  run: gcloud components install kpt nomos --quiet
- name: hydration	
  run: mkdir tmp &amp;&amp; nomos hydrate --flat --no-api-server-check --output tmp/hydrated-manifests.yaml
- name: gatekeeper
  run: kpt fn eval --image gcr.io/kpt-fn/gatekeeper:v0.2 tmp/
</code></pre><p>In your CI pipeline with Cloud Build, here is how it could look like:</p><pre tabindex=0><code>- id: hydration
  name: gcr.io/cloud-builders/gcloud
  entrypoint: &#39;bash&#39;
  args:
  - &#39;-eEuo&#39;
  - &#39;pipefail&#39;
  - &#39;-c&#39;
  - |
    mkdir tmp &amp;&amp; nomos hydrate --flat --no-api-server-check --output tmp/hydrated-manifests.yaml
- id: gatekeeper
  name: gcr.io/cloud-builders/gcloud
  entrypoint: &#39;bash&#39;
  args:
  - &#39;-eEuo&#39;
  - &#39;pipefail&#39;
  - &#39;-c&#39;
  - |
    kpt fn eval --image gcr.io/kpt-fn/gatekeeper:v0.2 tmp/
</code></pre><p>The two resources below give other illustrations with Cloud Build:</p><ul><li><a href=https://cloud.google.com/anthos-config-management/docs/tutorials/policy-agent-ci-pipeline>Use Policy Controller in a CI pipeline</a></li><li><a href=https://cloud.google.com/anthos-config-management/docs/tutorials/app-policy-validation-ci-pipeline>Validate apps against company policies in a CI pipeline</a></li></ul><p>And voila, that&rsquo;s a wrap!</p><h2 id=complementary-and-further-resources>Complementary and further resources
<a href=#complementary-and-further-resources class=h-anchor aria-hidden=true>#</a></h2><ul><li><a href=https://github.com/open-policy-agent/gatekeeper-library>OPA Gatekeeper policies library</a></li><li><a href=https://cloud.google.com/anthos-config-management/docs/reference/constraint-template-library>Constraint template library provided by Google</a></li><li><a href=https://kpt.dev/book/>The kpt Book</a></li><li><a href=https://cloud.google.com/architecture/policy-compliant-resources>Creating policy-compliant Google Cloud resources</a></li></ul><p>Hope you enjoyed that one, stay safe out there! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2021/12/istio-sidecar/><span class=button__icon>←</span>
<span class=button__text>istio sidecar to reduce istio proxy resource consumption</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2021/11/asm-security/><span class=button__text>secure your apps and your cluster with anthos service mesh</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>