<!doctype html><html lang=en><head><title>lessons learned from the log4shell cves ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Wow, the IT security world was on fire. LinkedIn and Twitter feeds were almost just talking about that: The commonly used Apache Log4j 2 library has been compromised. 5 CVEs have been reported to date: CVE-2021-44228, CVE-2021-45046, CVE-2021-45105, CVE-2021-4104 and CVE-2021-44832.
Google has been providing their findings of ongoing investigations for both Google and Google Cloud products and services:
The Google Cybersecurity Action Team provides recommendations and solutions available to Google Cloud customers and security teams to manage the risk of the Apache Log4j 2 vulnerability."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog.io/posts/2021/12/log4shell/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog.io/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="lessons learned from the log4shell cves"><meta name=twitter:description content="let's see what we could learn on a kubernetes point of view from the log4shell cves"><meta property="og:title" content="lessons learned from the log4shell cves"><meta property="og:description" content="let's see what we could learn on a kubernetes point of view from the log4shell cves"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog.io/posts/2021/12/log4shell/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-23T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-23T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog.io/about/>about</a></li><li><a href=/myblog.io/presentations/>presentations</a></li><li><a href=/myblog.io/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>lessons learned from the log4shell cves</h1><div class=post-meta><span class=post-date>2021-12-23</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog.io/tags/security/>#security</a>&nbsp;</span><div class=post-content><p>Wow, the IT security world was on fire. LinkedIn and Twitter feeds were almost just talking about that: The commonly used <a href=https://logging.apache.org/log4j/2.x/security.html>Apache Log4j 2 library has been compromised</a>. 5 CVEs have been reported to date: <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-44228>CVE-2021-44228</a>, <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-45046>CVE-2021-45046</a>, <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-45105>CVE-2021-45105</a>, <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-4104>CVE-2021-4104</a> and <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-44832>CVE-2021-44832</a>.</p><p>Google has been providing their findings of ongoing investigations for both <a href=https://security.googleblog.com/2021/12/apache-log4j-vulnerability.html>Google</a> and <a href=https://cloud.google.com/log4j2-security-advisory>Google Cloud</a> products and services:</p><p>The <a href=https://cloud.google.com/blog/products/identity-security/recommendations-for-apache-log4j2-vulnerability>Google Cybersecurity Action Team provides recommendations and solutions</a> available to Google Cloud customers and security teams to manage the risk of the Apache Log4j 2 vulnerability. You will find in there concrete examples with Cloud Armor, Chronicle, Cloud IDS, Security Command Center, Container scanning, Binary Authorization, Cloud Logging and Apigee.</p><p>Impacted or not by those current events, there is some lessons learned that we could leverage to make sure that whatever languages used by the developers, there is tools in place to detect, protect and remediate such compromised dependencies. In the context of containers and Kubernetes, here are 4 easy ways to help with this:</p><ul><li><a href=#update-dependencies>Update dependencies</a></li><li><a href=#scan-containers>Scan containers</a></li><li><a href=#protect-ingress>Protect Ingress</a></li><li><a href=#restrict-egress>Restrict Egress</a></li></ul><h2 id=update-dependencies>Update dependencies
<a href=#update-dependencies class=h-anchor aria-hidden=true>#</a></h2><p>The second section of the recent article <a href=https://cloud.google.com/blog/products/containers-kubernetes/the-rise-and-future-of-kubernetes-and-open-source-at-google>The past, present, and future of Kubernetes with Eric Brewer</a> highlights a very important security aspect regarding to the dependencies of applications:</p><blockquote><p>As the number of dependencies used in software development grows, the security risks multiply. Investing in software supply chain security is imperative, and a move towards managed services is actually safer than self-managed solutions.</p></blockquote><blockquote><p>99% of our vulnerabilities are not in the code you write in your application. They’re in a very deep tree of dependencies, some of which you may know about, some of which you may not know about.</p></blockquote><p>If you are using GitHub, you could leverage <a href=https://github.blog/2021-12-14-using-githubs-security-features-identify-log4j-exposure-codebase/>GitHub’s security features like <code>dependabot</code> and <code>CodeQL</code></a> to help identify exposure in your codebase.</p><p>As an example, you could leverage <code>dependabot</code> on any GitHub repository just by creating this <code>.github/dependabot.yml</code> file to check updates on both your containers base images in your <code>Dockerfile</code> as well as your <code>gradle</code> packages (<a href=https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#package-ecosystem>here is the list of all available packages ecosystem</a>):</p><pre tabindex=0><code>cat &lt;&lt;EOF &gt; .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: &#34;docker&#34;
    directory: &#34;/&#34;
    schedule:
      interval: &#34;daily&#34;
  - package-ecosystem: &#34;gradle&#34;
    directory: &#34;/&#34;
    schedule:
      interval: &#34;daily&#34;
EOF
</code></pre><p>You could read and learn more <a href=https://security.googleblog.com/2021/12/understanding-impact-of-apache-log4j.html>here</a> about the impact of Apache Log4j 2 vulnerabilities and the packages depending on it. In addition to understand how widespread are those vulnerabilities, you will also learn more about the initiatives such as <a href=https://sos.dev/>Secure Open Source Rewards</a> and <a href=https://deps.dev/>Open Source Insights</a> driven by Google.</p><h2 id=scan-containers>Scan containers
<a href=#scan-containers class=h-anchor aria-hidden=true>#</a></h2><p>Scanning your containers as early as possible, at least from within your <a href=https://mathieu-benoit.github.io/myblog.io/posts/2021/09/container-scanning/>Continuous Integration pipelines</a> to block any critical vulnerabilities, is also very key to secure and trust your software supply chain.</p><p>If you <a href=https://cloud.google.com/container-analysis/docs/java-scanning>scan a Java container</a> having those Log4j 2 vulnerabilities by running this command <code>gcloud artifacts docker images scan --additional-package-types=MAVEN</code>, you will be able to get the following information:</p><pre tabindex=0><code>CRITICAL            9.3         projects/goog-vulnz/notes/CVE-2021-44228    org.apache.logging.log4j:log4j-api    2.13.3        2.15.0
CRITICAL            5.1         projects/goog-vulnz/notes/CVE-2021-45046    org.apache.logging.log4j:log4j-api    2.13.3        2.16.0
HIGH                4.3         projects/goog-vulnz/notes/CVE-2021-45105    org.apache.logging.log4j:log4j-api    2.13.3        2.17.0
MEDIUM              6.0         projects/goog-vulnz/notes/CVE-2021-44832    org.apache.logging.log4j:log4j-api    2.13.3        2.17.1
</code></pre><p>In addition to that, you could use <a href=https://mathieu-benoit.github.io/myblog.io/posts/2020/11/binauthz/>Binary Authorization</a> by leveraging the <a href=https://cloud.google.com/binary-authorization/docs/creating-attestations-kritis>vulnerability-based attestations feature</a> too.</p><p>Another important aspect is to scan your containers actually running on your Kubernetes clusters, for example with GKE you could leverage the <a href=https://cloud.google.com/security-command-center/docs/concepts-container-threat-detection-overview>Container Thread Detection</a> feature from Security Command Center. A new <a href=https://cloud.google.com/release-notes#December_21_2021>Active Scan: Log4j Vulnerable to RCE rule</a> has been launched too.</p><h2 id=protect-ingress>Protect Ingress
<a href=#protect-ingress class=h-anchor aria-hidden=true>#</a></h2><p>Web Application Firewalls (WAF) are often the first option for protecting and mitigating vulnerabilities that require HTTP transport. <a href=https://mathieu-benoit.github.io/myblog.io/posts/2021/04/cloud-armor/>Google Cloud Armor</a> helps protect your applications and websites against denial of service (DDOS) and web attacks (WAF).</p><p>Google Cloud Armor customers can now deploy a <a href=https://cloud.google.com/blog/products/identity-security/cloud-armor-waf-rule-to-help-address-apache-log4j-vulnerability>new preconfigured WAF rule</a> that will help detect and, optionally, block attempted exploits of CVE-2021-44228 and CVE-2021-45046:</p><pre tabindex=0><code>gcloud compute security-policies rules create 12345 \
    --security-policy $securityPolicyName \
    --expression &#34;evaluatePreconfiguredExpr(&#39;cve-canary&#39;)&#34; \
    --action &#34;deny-403&#34; \
    --description &#34;CVE-2021-44228 and CVE-2021-45046&#34;
</code></pre><p>From there, you could look at the denied logs generated by this rule via <a href=https://cloud.google.com/logging/docs/log4j2-vulnerability>Cloud Logging</a>:</p><pre tabindex=0><code>filter=&#34;resource.type=\&#34;http_load_balancer\&#34; &#34;\
&#34;jsonPayload.enforcedSecurityPolicy.name=\&#34;${securityPolicyName}\&#34; &#34;\
&#34;httpRequest.requestUrl=~\&#34;jndi\&#34; &#34;\
&#34;OR httpRequest.userAgent=~\&#34;jndi\&#34; &#34;\
&#34;OR httpRequest.referer=~\&#34;jndi\&#34;&#34;
gcloud logging read \
    --project $projectId \
    &#34;$filter&#34; \
    --format=&#39;table(httpRequest.requestUrl)&#39;
</code></pre><h2 id=restrict-egress>Restrict Egress
<a href=#restrict-egress class=h-anchor aria-hidden=true>#</a></h2><p>Because the compromised Apache Log4j 2 fetches malicious variables over the network, filtering your workload&rsquo;s egress connections is key to mitigate and protect your entire platform. To accomplish a defense in depth security setup, there is three layers of features you could leverage: Private GKE cluster with NAT Gateway, Kubernetes Network Policies and Istio Egress Gateway.</p><p>First, <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/private-cluster-concept>Private GKE clusters</a> will guarantee that your nodes don&rsquo;t have any public IPs which will avoid any egress communications. To define outbound internet access for certain private nodes you can use <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters#private-nodes-outbound>Cloud NAT</a>.</p><p>Second, <a href=https://mathieu-benoit.github.io/myblog.io/posts/2019/09/calico/>Kubernetes Network Policies</a> will allow you to restrict egress from your applications. For example, the following example illustrates how to deny all egress in the namespace <code>your-namespace</code>:</p><pre tabindex=0><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: your-namespace
spec:
  podSelector: {}
  policyTypes:
  - Egress
</code></pre><p>With GKE Dataplane V2 you could even leverage the logging capabilities to get the <code>deny</code> logs, I illustrated this in my blog <a href=https://mathieu-benoit.github.io/myblog.io/posts/2021/04/gke-cilium/>ebpf and cilium, to bring more security and more networking capabilities in gke</a>.</p><p><em>Note: if you want to set DNS based policies, you will need to leverage <a href=https://isovalent.com/blog/post/2021-12-log4shell>Cilium Network Policy</a> or the <a href=https://github.com/GoogleCloudPlatform/gke-fqdnnetworkpolicies-golang>FQDNNetworkPolicies</a>.</em></p><p>Third, <a href=https://istio.io/latest/blog/2019/egress-traffic-control-in-istio-part-3/#performance-considerations>Egress Gateway with your service mesh</a>, directing all the egress traffic through it, and allocating public IPs to the egress gateway nodes allows the application nodes to access external services in a controlled way.
The most important security aspect for a service mesh is probably ingress traffic like we saw earlier in this blog article. You definitely must prevent attackers from penetrating the cluster through ingress APIs. Having said that, securing the traffic leaving the mesh is also very important. Once your cluster is compromised, and you must be prepared for that scenario, you want to reduce the damage as much as possible and prevent the attackers from using the cluster for further attacks on external services and legacy systems outside of the cluster. To achieve that goal, you need secure control of egress traffic.</p><p>Looking for a concrete implementation with the 3 of them together with GKE? Here is the <a href=https://cloud.google.com/service-mesh/docs/security/egress-gateways-best-practices>high-level guide</a> and its <a href=https://cloud.google.com/service-mesh/docs/security/egress-gateway-gke-tutorial>tutorial companion</a>.</p><h2 id=complementary-and-further-resources>Complementary and further resources
<a href=#complementary-and-further-resources class=h-anchor aria-hidden=true>#</a></h2><ul><li><a href=https://cloudonair.withgoogle.com/events/container-security>Container Security: Building trust in your software supply chain</a></li><li><a href=https://www.govcert.ch/blog/zero-day-exploit-targeting-popular-java-library-log4j/>Zero-Day Exploit Targeting Popular Java Library Log4j by GovCERT.ch</a></li><li><a href=https://blog.aquasec.com/log4j-vulnerabilities-overview>The Nightmare Before Christmas: Looking Back at Log4j Vulnerabilities</a></li><li><a href=https://blog.aquasec.com/cve-2021-44228-log4shell-vulnerability-explained>CVE-2021-44228 aka Log4Shell Vulnerability Explained by Aqua</a></li><li><a href=https://snyk.io/blog/log4shell-in-a-nutshell/>Log4Shell in a nutshell (for non-developers & non-Java developers) by Snyk</a></li><li><a href=https://snyk.io/blog/log4shell-remediation-cheat-sheet/>Log4Shell remediation cheat sheet by Snyk</a></li><li><a href=https://blog.aquasec.com/real-world-log4j-attacks-analysis>Threat Alert: Tracking Real-World Log4j Attacks by Aqua</a></li><li><a href=https://cloud.google.com/blog/products/identity-security/cloud-ids-to-help-detect-cve-2021-44228-apache-log4j-vulnerability>Google Cloud IDS signature updates help detect Apache Log4j vulnerabilities</a></li><li><a href=https://chroniclesec.medium.com/detecting-and-responding-to-apache-log4j-2-cve-2021-44228-using-google-chronicle-ec77d676eaea>Detecting and responding to Apache “Log4j 2” using Google Chronicle</a></li></ul><p>Hope you enjoyed that one to improve your security posture, sail safe out there!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2021/12/gke-2021/><span class=button__icon>←</span>
<span class=button__text>gke and anthos in 2021, a year of innovations</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog.io/posts/2021/12/distroless-asm-proxy/><span class=button__text>distroless asm proxy</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>