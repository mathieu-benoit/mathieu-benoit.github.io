<!doctype html><html lang=en><head><title>istio sidecar to reduce istio proxy resource consumption ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sidecar describes the configuration of the sidecar proxy that mediates inbound and outbound communication to the workload instance it is attached to. By default, Istio will program all sidecar proxies in the mesh with the necessary configuration required to reach every workload instance in the mesh, as well as accept traffic on all the ports associated with the workload. The Sidecar configuration provides a way to fine tune the set of ports, protocols that the proxy will accept when forwarding traffic to and from the workload."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2021/12/istio-sidecar/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="istio sidecar to reduce istio proxy resource consumption"><meta name=twitter:description content="let's see how you could leverage the istio sidecar to reduce istio proxy resource consumption"><meta property="og:title" content="istio sidecar to reduce istio proxy resource consumption"><meta property="og:description" content="let's see how you could leverage the istio sidecar to reduce istio proxy resource consumption"><meta property="og:type" content="article"><meta property="og:url" content="/posts/2021/12/istio-sidecar/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-01T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>istio sidecar to reduce istio proxy resource consumption</h1><div class=post-meta><span class=post-date>2021-12-01</span></div><span class=post-tags><a href=/tags/security/>#security</a>&nbsp;
<a href=/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=/tags/service-mesh/>#service-mesh</a>&nbsp;</span><div class=post-content><blockquote><p><a href=https://istio.io/latest/docs/reference/config/networking/sidecar/><code>Sidecar</code></a> describes the configuration of the sidecar proxy that mediates inbound and outbound communication to the workload instance it is attached to. By default, Istio will program all sidecar proxies in the mesh with the necessary configuration required to reach every workload instance in the mesh, as well as accept traffic on all the ports associated with the workload. The <code>Sidecar</code> configuration provides a way to fine tune the set of ports, protocols that the proxy will accept when forwarding traffic to and from the workload. In addition, it is possible to restrict the set of services that the proxy can reach when forwarding outbound traffic from workload instances.</p></blockquote><p>Typically, if you run this command below, you will find out that any pod in your mesh will have all the services endpoints on its proxy configuration, which could land with performance (CPU and memory) issues as you will scale with the number of workloads in your cluster:</p><pre tabindex=0><code>namespace=your-namespace
app=your-app-label
istioctl proxy-config clusters $(kubectl -n $namespace get pod -l app=$app -o jsonpath={.items..metadata.name}) \
    -n $namespace
</code></pre><p>This video shows you concretely in action how the <code>Sidecar</code> resource could help you with high resource consumption of the Istio proxy:<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/JcfLUHdntN4 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="Istio 1.1 Review: Istio Sidecar resource to reduce memory overhead"></iframe></div></p><p>Based on that, you should at least have this <code>Sidecar</code> for your cluster, it will apply for all of your namespaces:</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: default
  namespace: istio-system
spec:
  egress:
  - hosts:
    - &#34;istio-system/*&#34;
    - &#34;./*&#34;
EOF
</code></pre><p>You could then apply other more fine-grained <code>Sidecar</code> resources per namespace if you need other configuration in there. For example if you have an application with the label <code>app: app-1</code> who needs to talk to a service <code>svc-1</code> in the namespace <code>ns-1</code>, you will have this <code>Sidecar</code> resource:</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: app-1-to-svc-2
  namespace: ns-1
spec:
  workloadSelector:
    labels:
      app: app-1
  egress:
  - hosts:
    - &#34;istio-system/*&#34;
    - &#34;./svc-2.ns-1.svc.cluster.local&#34;
EOF
</code></pre><p>If you run again the previous <code>istioctl pc c</code> command you will now see that the list of endpoints is very small.</p><p>You could find below additional resources to illustrate this:</p><ul><li><a href=https://karlstoney.com/2020/10/03/istio-at-scale-sidecar/>Istio at Scale: Sidecar</a></li><li><a href=https://medium.com/geekculture/watch-out-for-this-istio-proxy-sidecar-memory-pitfall-8dbd99ea7e9d>Watch Out for This Istio Proxy Sidecar Memory Pitfall</a></li><li><a href=https://banzaicloud.com/blog/istio-sidecar/>Reducing Istio proxy resource consumption with outbound traffic restrictions</a></li></ul><p><em>Note: <code>Sidecar</code> is not supported yet by Istio <code>Gateway</code> resources, so this is not working with <a href=https://github.com/mathieu-benoit/my-kubernetes-deployments/tree/main/namespaces/asm-ingress>my <code>asm-ingress</code> namespace</a>.</em></p><p>In addition to this, since Istio 1.10, you could use discovery selectors to configure namespaces for your Istio service mesh, to see how they intersect with Sidecar resources, <a href=https://istio.io/latest/blog/2021/discovery-selectors/>checkout that resource here</a>.</p><p>Hope you enjoyed that one, sail safe and healthy out there!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2021/12/crfa-v2/><span class=button__icon>←</span>
<span class=button__text>crfa v2 with asm</span></a></span>
<span class="button next"><a href=/posts/2021/11/policy-controller-ci/><span class=button__text>opa gatekeeper and policy controller during continuous integration (ci) pipelines</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>