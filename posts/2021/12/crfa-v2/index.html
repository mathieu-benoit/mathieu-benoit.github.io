<!doctype html><html lang=en><head><title>crfa v2 with asm ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Update on March 2022, CRfAv2 got Knative service version 1.1.2 and ASM MCP can be installed via the Fleet API.
On July 2021 I was blogging about Cloud Run for Anthos (CRfA), but today I will go through its new version, CRfA v2, and its new integration with Anthos Service Mesh (ASM).
That&amp;rsquo;s the same experience based on Knative like illustrated during this recent session about CRfA during Google Cloud Next 2021: So, what&amp;rsquo;s new?"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2021/12/crfa-v2/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="crfa v2 with asm"><meta name=twitter:description content="let's see how the new crfa v2 is leveraging asm"><meta property="og:title" content="crfa v2 with asm"><meta property="og:description" content="let's see how the new crfa v2 is leveraging asm"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2021/12/crfa-v2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-06T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-06T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>crfa v2 with asm</h1><div class=post-meta><span class=post-date>2021-12-06</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/service-mesh/>#service-mesh</a>&nbsp;</span><div class=post-content><p><em>Update on March 2022, <a href=https://cloud.google.com/anthos/run/docs/release-notes#February_23_2022>CRfAv2 got Knative service version 1.1.2</a> and <a href=https://cloud.google.com/service-mesh/docs/managed/auto-control-plane-with-fleet>ASM MCP can be installed via the Fleet API</a>.</em></p><p><a href=https://mathieu-benoit.github.io/posts/2021/07/crfa/>On July 2021</a> I was blogging about Cloud Run for Anthos (CRfA), but today I will go through its new version, CRfA v2, and its new integration with Anthos Service Mesh (ASM).</p><p>That&rsquo;s the same experience based on Knative like illustrated during this recent session about CRfA during Google Cloud Next 2021:<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/uNhgTQw8sUc style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="Using Cloud Run for Anthos for hybrid and multicloud architectures"></iframe></div></p><p>So, what&rsquo;s new? What are the differences between v1 and v2? <a href=https://cloud.google.com/anthos/run/docs/install#newandchanged>Here you are</a>. What I will illustrate today and the most excited update according to me is the integration with ASM.</p><blockquote><p>ASM now decouples CRfA from your service mesh administration and maintenance tasks. It brings your installation to parity with the rest of Anthos and also removes the dependencies and limitations of the previously bundled Istio version.</p></blockquote><p>If you have GKE clusters running CRfA v1, <a href=https://cloud.google.com/anthos/run/docs/install/on-gcp/upgrade>here the upgrade guide to v2</a>.</p><p>What I will cover today is creating from scratch a brand new GKE cluster with ASM and CRfA, let&rsquo;s see this in actions!</p><p>Let&rsquo;s use a given project:</p><pre tabindex=0><code>projectId=FIXME
gcloud config set project $projectId
projectNumber=$(gcloud projects describe $projectId --format=&#39;get(projectNumber)&#39;)
</code></pre><p>Create a GKE cluster:</p><pre tabindex=0><code>zone=FIXME
clusterName=FIXME
gcloud services enable container.googleapis.com
gcloud container clusters create $clusterName \
    --zone=$zone \
    --workload-pool=$projectId.svc.id.goog \
    --labels mesh_id=proj-$projectNumber
</code></pre><p>Register the GKE cluster as an Anthos Fleet:</p><pre tabindex=0><code>gcloud services enable \
    anthos.googleapis.com \
    gkehub.googleapis.com
gcloud container hub memberships register $clusterName \
    --gke-cluster $zone/$clusterName \
    --enable-workload-identity
</code></pre><p><a href=https://cloud.google.com/service-mesh/docs/managed/auto-control-plane-with-fleet>Install ASM MCP</a> for this GKE cluster:</p><pre tabindex=0><code>gcloud services enable \
    mesh.googleapis.com
gcloud container hub mesh enable
gcloud alpha container hub mesh update \
    --control-plane automatic \
    --membership $clusterName
</code></pre><p>After a few minutes, verify that the control plane <code>state</code> is <code>ACTIVE</code> and <code>code</code> is <code>REVISION_READY</code>:</p><pre tabindex=0><code>gcloud alpha container hub mesh describe
</code></pre><p>Take note of the revision label in the <code>description:</code> field, <code>asm-managed</code> in the provided output. That&rsquo;s the <a href=https://cloud.google.com/service-mesh/docs/managed/select-a-release-channel>ASM release channel</a> your GKE cluster is in.</p><p>Deploy a public <a href=https://cloud.google.com/service-mesh/docs/gateways>Ingress Gateway</a>:</p><pre tabindex=0><code>ingressNamespace=asm-ingress
ingressName=asm-ingressgateway
ingressLabel=&#39;asm: ingressgateway&#39;
asmRevision=asm-managed
cat &lt;&lt;EOF | kubectl apply -n $ingressNamespace -f -
apiVersion: v1
kind: Namespace
metadata:
  name: asm-ingress
  labels:
    istio.io/rev: ${asmRevision}
---
apiVersion: v1
kind: Service
metadata:
  name: ${ingressName}
  labels:
    ${ingressLabel}
spec:
  ports:
  - name: http
    port: 80
    targetPort: 80
  selector:
    ${ingressLabel}
  type: LoadBalancer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${ingressName}
spec:
  selector:
    matchLabels:
      ${ingressLabel}
  template:
    metadata:
      annotations:
        inject.istio.io/templates: gateway
      labels:
        ${ingressLabel}
    spec:
      containers:
      - name: istio-proxy
        image: auto
EOF
</code></pre><p><a href=https://cloud.google.com/anthos/run/docs/install/on-gcp/custom>Install CRfA</a> in our GKE cluster:</p><pre tabindex=0><code>gcloud container hub cloudrun enable
cat &lt;&lt;EOF &gt; cloudrun.yaml
apiVersion: operator.run.cloud.google.com/v1alpha1
kind: CloudRun
metadata:
  name: cloud-run
spec:
  serving:
    ingressService:
      name: ${ingressName}
      namespace: ${ingressNamespace}
      labels:
        ${ingressLabel}
EOF
gcloud container hub cloudrun apply \
    --gke-cluster $zone/$clusterName \
    --config=cloudrun.yaml
</code></pre><p>Deploy a sample app:</p><pre tabindex=0><code>namespace=helloworld
kubectl create ns $namespace
kubectl label namespace $namespace istio-injection- istio.io/rev=$asmRevision --overwrite
gcloud run deploy helloworld \
    --platform gke \
    --image gcr.io/knative-samples/helloworld-go \
    --cluster=$clusterName \
    --cluster-location=$zone \
    --namespace $namespace
curl http://helloworld.$namespace.kuberun.$elbIp.nip.io/
</code></pre><p>Here you are, that&rsquo;s a wrap!</p><p>From here you could now leverage advanced ASM/Istio features for more security like I described in this <a href=https://mathieu-benoit.github.io/posts/2021/11/asm-security/>secure your apps and your cluster with ASM</a> blog article, where I talk about Istio CNI, mTLS <code>STRICT</code>, <code>AuthorizationPolicy</code>, <code>Sidecar</code>, HTTPS GCLB with Cloud Armor, etc.</p><p>Complementary and further resources:</p><ul><li><a href=https://cloud.google.com/anthos/run/docs/release-notes>CRfA release notes</a></li><li><a href=https://cloud.google.com/anthos/run/docs/setup>Additional setups with CRfA like internal ingress gateway, workload identity, etc.</a></li><li><a href=https://static.sched.com/hosted_files/kccnceu19/5f/Knative-on-Istio.pdf>Knative on Istio - KubeCon Europe 2019</a></li><li><a href=https://events.istio.io/istiocon-2021/slides/b7p-PerformanceTuningKnative-GongZhang-YuZhuang.pdf>Performance tuning and best practices in a Knative based, large-scale serverless platform with Istio</a></li></ul><p>Hope you enjoyed that one, cheers! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2021/12/distroless-asm-proxy/><span class=button__icon>←</span>
<span class=button__text>distroless asm proxy</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2021/12/istio-sidecar/><span class=button__text>istio sidecar to reduce istio proxy resource consumption</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>