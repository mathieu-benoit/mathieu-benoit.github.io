<!doctype html><html lang=en><head><title>container scanning ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Container scanning on both Container Registry or Artifact Registry is a very important feature in order to improve your security posture when dealing with containers.
Software vulnerabilities are weaknesses that can either cause an accidental system failure or be intentionally exploited.
Container Analysis provides automated and manual vulnerability scanning for containers in Artifact Registry and Container Registry.
Automated scanning # Automated scanning scans new images when they&amp;rsquo;re uploaded, and it&amp;rsquo;s really easy to enable it:"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2021/09/container-scanning/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="container scanning"><meta name=twitter:description content="let's see how to scan your containers with gcp"><meta property="og:title" content="container scanning"><meta property="og:description" content="let's see how to scan your containers with gcp"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2021/09/container-scanning/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-16T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-16T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>container scanning</h1><div class=post-meta><span class=post-date>2021-09-16</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;</span><div class=post-content><p><a href=https://cloud.google.com/container-analysis/docs/container-scanning-overview>Container scanning</a> on both <a href=https://cloud.google.com/container-registry>Container Registry</a> or <a href=https://cloud.google.com/artifact-registry>Artifact Registry</a> is a very important feature in order to improve your security posture when dealing with containers.</p><blockquote><p>Software vulnerabilities are weaknesses that can either cause an accidental system failure or be intentionally exploited.</p></blockquote><blockquote><p>Container Analysis provides automated and manual vulnerability scanning for containers in Artifact Registry and Container Registry.</p></blockquote><h2 id=automated-scanning>Automated scanning
<a href=#automated-scanning class=h-anchor aria-hidden=true>#</a></h2><p>Automated scanning scans new images when they&rsquo;re uploaded, and it&rsquo;s really easy to enable it:</p><pre tabindex=0><code>gcloud services enable containerscanning.googleapis.com
</code></pre><p>The important feature included is the Continuous analysis. After the initial scan, the metadata for scanned images are continuously monitors for new vulnerabilities. As Container Analysis receives new and updated vulnerability information from vulnerability sources, it updates the metadata of the scanned images to keep it up-to-date, creating new vulnerability occurrences for new notes and deleting vulnerability occurrences that are no longer valid.</p><p><em>Important: Container Analysis only updates the vulnerability metadata for images that were pulled in the last 30 days. If you pull an image after this 30-day window, it can take additional time for Container Analysis to update the vulnerability occurrences.</em></p><h2 id=manual-scanning>Manual scanning
<a href=#manual-scanning class=h-anchor aria-hidden=true>#</a></h2><p>Manual (on-demand) scanning is a great way to scan your containers from your local environment or during your Continuous Integration (CI) pipeline in order to shift-left your security checkpoints.</p><p>Let&rsquo;s see in actions how it works:</p><pre tabindex=0><code># Install the required gcloud&#39;s component
gcloud components install local-extract

# Enable the on-demand scanning feature
gcloud services enable ondemandscanning.googleapis.com

# Actually scan a given container image locally
imageName=FIXME
gcloud artifacts docker images scan --format=&#39;value(response.scan)&#39; $imageName &gt; scan_id.txt
# You could add the --remote parameter if your image is not present locally but is in Container Registry or Artifact Registry.

# Display the list of vulnerabilities found
gcloud artifacts docker images list-vulnerabilities $(cat scan_id.txt) --format=&#39;table(vulnerability.effectiveSeverity, vulnerability.cvssScore, noteName, vulnerability.packageIssue[0].affectedPackage, vulnerability.packageIssue[0].affectedVersion.name, vulnerability.packageIssue[0].fixedVersion.name)&#39;

# If you want to integrate a failure in a bash script, here is an example of how to do it
severity=CRITICAL
gcloud artifacts docker images list-vulnerabilities $(cat scan_id.txt) \
    --format=&#39;value(vulnerability.effectiveSeverity)&#39; | if grep -Fxq $severity; \
    then echo &#39;Failed vulnerability check&#39; &amp;&amp; exit 1; else exit 0; fi
</code></pre><p>And that&rsquo;s it, that&rsquo;s how simple it is to scan on-demand your container images.</p><p><em>Note: if you have Java applications you could also leverage this <a href=https://cloud.google.com/container-analysis/docs/java-scanning>Java containers scanning</a> <code>gcloud artifacts docker images scan --additional-package-types=MAVEN</code> to get more informations about your dependencies, especially insightful with the events in December 2021 with the <a href=https://mathieu-benoit.github.io/posts/2021/12/log4shell/>log4j2&rsquo;s CVEs</a>.</em></p><h2 id=manual-scanning-in-ci>Manual scanning in CI
<a href=#manual-scanning-in-ci class=h-anchor aria-hidden=true>#</a></h2><p>Based on what we just saw, let&rsquo;s see if there is anything else we should do to integrate this part either in Cloud Build pipelines or GitHub actions.</p><p>First, you need to make sure the service account used by your CI tool has the proper role:</p><pre tabindex=0><code>projectId=FIXME
cloudBuildSa=FIXME
gcloud projects add-iam-policy-binding $projectId \
    --member=serviceAccount:$cloudBuildSa \
    --role=roles/ondemandscanning.admin
</code></pre><h3 id=cloud-build>Cloud Build
<a href=#cloud-build class=h-anchor aria-hidden=true>#</a></h3><p>Nothing special to do, here is the associated step you should include between your <code>docker build</code> and <code>docker push</code> steps:</p><pre tabindex=0><code>- id: container scanning
  name: gcr.io/cloud-builders/gcloud
  entrypoint: &#39;bash&#39;
  args:
  - &#39;-eEuo&#39;
  - &#39;pipefail&#39;
  - &#39;-c&#39;
  - |
    gcloud artifacts docker images scan &#39;${_IMAGE_NAME}:$SHORT_SHA&#39; --format=&#39;value(response.scan)&#39; &gt; scan_id.txt
    gcloud artifacts docker images list-vulnerabilities $(cat scan_id.txt) --format=&#39;table(vulnerability.effectiveSeverity, vulnerability.cvssScore, noteName, vulnerability.packageIssue[0].affectedPackage, vulnerability.packageIssue[0].affectedVersion.name, vulnerability.packageIssue[0].fixedVersion.name)&#39;
    gcloud artifacts docker images list-vulnerabilities $(cat scan_id.txt) --format=&#39;value(vulnerability.effectiveSeverity)&#39; | if grep -Fxq ${_SEVERITY}; then echo &#39;Failed vulnerability check&#39; &amp;&amp; exit 1; else exit 0; fi
</code></pre><h3 id=github-actions>GitHub actions
<a href=#github-actions class=h-anchor aria-hidden=true>#</a></h3><p>At the beginning of your pipeline, you need to use the <code>GoogleCloudPlatform/github-actions/setup-gcloud</code> action right after the <code>actions/checkout</code> one:</p><pre tabindex=0><code>- uses: actions/checkout@v2
- uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
  with:
    project_id: ${{ secrets.CONTAINER_REGISTRY_PROJECT_ID }}
    service_account_key: ${{ secrets.CONTAINER_REGISTRY_PUSH_PRIVATE_KEY }}
</code></pre><p>This <code>GoogleCloudPlatform/github-actions/setup-gcloud</code> is necessary in order to successfully run the following <code>gcloud components install local-extract</code> command.</p><p>Then here is the associated step you should include between your <code>docker build</code> and <code>docker push</code> steps:</p><pre tabindex=0><code>- name: container scanning
  run: |
    gcloud components install local-extract --quiet
    gcloud artifacts docker images scan ${IMAGE_NAME} --format=&#39;value(response.scan)&#39; &gt; scan_id.txt
    gcloud artifacts docker images list-vulnerabilities $(cat scan_id.txt) --format=&#39;table(vulnerability.effectiveSeverity, vulnerability.cvssScore, noteName, vulnerability.packageIssue[0].affectedPackage, vulnerability.packageIssue[0].affectedVersion.name, vulnerability.packageIssue[0].fixedVersion.name)&#39;
    gcloud artifacts docker images list-vulnerabilities $(cat scan_id.txt) --format=&#39;value(vulnerability.effectiveSeverity)&#39; | if grep -Fxq ${{ env.SEVERITY }}; then echo &#39;Failed vulnerability check&#39; &amp;&amp; exit 1; else exit 0; fi
</code></pre><p>And that&rsquo;s it, you are now able to integrate your container images scanning within your CI pipeline.</p><h2 id=further-and-complementary-resources>Further and complementary resources
<a href=#further-and-complementary-resources class=h-anchor aria-hidden=true>#</a></h2><ul><li><a href=https://cloud.google.com/container-analysis/docs/container-scanning-overview#sources>Vulnerabilities sources</a></li><li><a href=https://cloud.google.com/container-analysis/pricing#vulnz>Pricing</a></li></ul><p>Hope you enjoyed that one, stay safe out there! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2021/09/gke-cos-version/><span class=button__icon>←</span>
<span class=button__text>gke cos version</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2021/07/crfa/><span class=button__text>mix both internal and external load balancers to expose your crfa services</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>