<!doctype html><html lang=en><head><title>ebpf and cilium, to bring more security and more networking capabilities in gke ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="As of May 10th, 2021, GKE Dataplane V2 and Kubernetes Network Policy logging are generally available starting with GKE version 1.20.6-gke.700 and gcloud 340.0.0.
Extended Berkeley Packet Filter (eBPF) is a new Linux networking paradigm that exposes programmable hooks to the network stack inside the Linux kernel. The ability to enrich the kernel with user-space information—without jumping back and forth between user and kernel spaces—enables context-aware operations on network packets at high speeds."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/posts/2021/04/gke-cilium/><link rel=stylesheet href=https://mathieu-benoit.github.io/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/img/favicon.png><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="ebpf and cilium, to bring more security and more networking capabilities in gke"><meta name=twitter:description content="let's see ebpf and cilium on gke and how they are bringing more security and networking capabilities"><meta property="og:title" content="ebpf and cilium, to bring more security and more networking capabilities in gke"><meta property="og:description" content="let's see ebpf and cilium on gke and how they are bringing more security and networking capabilities"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/posts/2021/04/gke-cilium/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-17T00:00:00+00:00"><meta property="article:modified_time" content="2021-04-17T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>about</a></li><li><a href=/presentations/>presentations</a></li><li><a href=/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>ebpf and cilium, to bring more security and more networking capabilities in gke</h1><div class=post-meta><span class=post-date>2021-04-17</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/tags/gcp/>#gcp</a>&nbsp;</span><div class=post-content><p><em>As of May 10th, 2021, GKE Dataplane V2 and Kubernetes Network Policy logging are generally available starting with GKE version <code>1.20.6-gke.700</code> and <code>gcloud 340.0.0</code>.</em></p><p><img src=https://cilium.io/static/1a5e48f755419401103235a6a01de4fd/b04cd/ogimage.png alt="Google, GKE, eBF and Cilium logo."></p><blockquote><p>Extended Berkeley Packet Filter (eBPF) is a new Linux networking paradigm that exposes programmable hooks to the network stack inside the Linux kernel. The ability to enrich the kernel with user-space information—without jumping back and forth between user and kernel spaces—enables context-aware operations on network packets at high speeds.</p></blockquote><blockquote><p>Cilium is an open source project that has been designed on top of eBPF to address the new scalability, security and visibility requirements of container workloads. Cilium goes beyond a traditional Container Networking Interface (CNI) to provide service resolution, policy enforcement and much more as seen in the picture below.</p></blockquote><p><img src=https://storage.googleapis.com/gweb-cloudblog-publish/images/Container_Networking_Interface.max-1100x1100.jpg alt="Cilium, beyond the traditional Kubernetes CNI."></p><p>Last August 2020, I wrote a blog article about <a href=https://mathieu-benoit.github.io/posts/2020/09/container-native-networking/>4 main networking features GCP is providing for your GKE clusters</a>, the GKE Dataplane V2 was one of them. I haven&rsquo;t tested this feature until today, but today is the day! ;)</p><blockquote><p><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/dataplane-v2>GKE Dataplane V2</a> is an opinionated dataplane that harnesses the power of eBPF and Cilium.</p></blockquote><p>On <a href=https://cilium.io/blog/2020/08/19/google-chooses-cilium-for-gke-networking>Cilium’s blog article for the announcement</a>, you could also read the story behind that partnership between Cilium, Google and actually the broad open source community, I love that!</p><blockquote><p>Google clearly has incredible technical chops and could have just built their dataplane directly on eBPF, instead, the GKE team has decided to leverage Cilium and contribute back. This is of course a huge honor for everybody who has contributed to Cilium over the years and shows Google’s commitment to open collaboration.</p></blockquote><p>First, let&rsquo;s create a new cluster <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/dataplane-v2>using Dataplane V2</a>:</p><pre tabindex=0><code>gcloud container clusters create \
    --enable-dataplane-v2
</code></pre><p><em>Note: Dataplane V2 comes with network policy enforcement built-in. This means that you don&rsquo;t need to enable network policy in clusters that use Dataplane V2. As of today, if you try to explicitly enable or disable network policy enforcement in a cluster that uses Dataplane V2, the request will fail.</em></p><p>From here, you could apply your <a href=https://mathieu-benoit.github.io/posts/2019/09/calico/><code>NetworkPolicies</code></a> like you used to do with any Kubernetes cluster. But there is more. You could actually leverage the associated <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/network-policy-logging>network policy logging</a> (both <code>allow</code> and <code>deny</code>). For this you need to enable them with the below example:</p><pre tabindex=0><code>kind: NetworkLogging
apiVersion: networking.gke.io/v1alpha1
metadata:
  name: default
spec:
  cluster:
    allow:
      log: true
      delegate: false
    deny:
      log: true
      delegate: false
</code></pre><p>And from here for any <code>deny</code> logs for example, you will be able to see them via Cloud Logging:</p><pre tabindex=0><code>projectName=FIXME
clusterLocation=FIXME
clusterName=FIXME

filter=&#34;resource.type=\&#34;k8s_node\&#34; &#34;\
&#34;jsonPayload.disposition=\&#34;deny\&#34; &#34;\
&#34;resource.labels.location=\&#34;${clusterLocation}\&#34; &#34;\
&#34;resource.labels.cluster_name=\&#34;${clusterName}\&#34; &#34;\
&#34;logName=\&#34;projects/${projectId}/logs/policy-action\&#34;&#34;

gcloud logging read --project $projectId &#34;$filter&#34;
</code></pre><p><em>Tips: if your cluster is enrolled with Anthos, you will also be able to see the number of those <code>deny</code> logs on the <a href=https://cloud.google.com/service-mesh/docs/observability/explore-dashboard><strong>Anthos > Security > Policy Summary > Kubernetes network policy</strong></a> page.</em></p><p>And that&rsquo;s it, that&rsquo;s how easy Cilium (eBPF) on GKE is bringing more security and more visibility for containers. I don&rsquo;t know for you, but the <code>NetworkLogging</code> is game changer for me, I finally and easily have visibility on <code>deny</code> logs with my <code>NetworkPolicies</code>!</p><p>Further and complementary resources:</p><ul><li><a href=https://cilium.io/blog/2020/11/10/ebpf-future-of-networking/>eBPF - The Future of Networking & Security</a></li><li><a href=https://cloud.google.com/blog/products/containers-kubernetes/bringing-ebpf-and-cilium-to-google-kubernetes-engine>New GKE Dataplane V2 increases security and visibility for containers</a></li></ul><p>Hope you enjoyed that one, stay safe out there, cheers!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/posts/2021/04/cloud-armor/><span class=button__icon>←</span>
<span class=button__text>cloud armor to protect your apps deployed on gke</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/posts/2021/03/policy-controller/><span class=button__text>opa gatekeeper with policy controller</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>