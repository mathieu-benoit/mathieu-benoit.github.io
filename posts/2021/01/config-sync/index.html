<!doctype html><html lang=en><head><title>gitops on gke with config sync ::
always up, always on</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Today, let&amp;rsquo;s see a GitOps setup in actions on GKE with Config Sync. I won&amp;rsquo;t go with the definition of what is GitOps, but if you are new with the concept, Weavework is doing a great job on explaining and illustrating what GitOps is. Another way to understand what is GitOps is to watch and listen to Kelsey Hightower during the last GitHub Universe conference:
What I love about GitOps:"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mathieu-benoit.github.io/myblog/posts/2021/01/config-sync/><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog/assets/style.css><link rel=stylesheet href=https://mathieu-benoit.github.io/myblog/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mathieu-benoit.github.io/myblog/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mathieu-benoit.github.io/myblog/img/favicon.png><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mathieu-benoit.github.io/myblog/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="gitops on gke with config sync"><meta name=twitter:description content="let's see gitops in actions with gke's config sync"><meta property="og:title" content="gitops on gke with config sync"><meta property="og:description" content="let's see gitops in actions with gke's config sync"><meta property="og:type" content="article"><meta property="og:url" content="https://mathieu-benoit.github.io/myblog/posts/2021/01/config-sync/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-20T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-20T00:00:00+00:00"><meta property="og:site_name" content="always up, always on"><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/myblog/about/>about</a></li><li><a href=/myblog/presentations/>presentations</a></li><li><a href=/myblog/tags/>tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/myblog/about/>about</a></li><li><a href=/myblog/presentations/>presentations</a></li><li><a href=/myblog/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>gitops on gke with config sync</h1><div class=post-meta><span class=post-date>2021-01-20</span></div><span class=post-tags><a href=https://mathieu-benoit.github.io/myblog/tags/containers/>#containers</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/security/>#security</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/gcp/>#gcp</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://mathieu-benoit.github.io/myblog/tags/gitops/>#gitops</a>&nbsp;</span><div class=post-content><p>Today, let&rsquo;s see a GitOps setup in actions on GKE with <a href=https://cloud.google.com/anthos-config-management/docs/config-sync-overview>Config Sync</a>. I won&rsquo;t go with the definition of what is GitOps, but if you are new with the concept, <a href=https://www.weave.works/technologies/gitops/>Weavework is doing a great job on explaining and illustrating what GitOps is</a>. Another way to understand what is GitOps is to watch and listen to Kelsey Hightower during the last GitHub Universe conference:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/yIAa5wHsfw4 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="Kelsey, Kubernetes, and GitOps - GitHub Universe 2020"></iframe></div><p>What I love about GitOps:</p><ul><li>Everything-as-Code in a Git repository: infrastructure, platform, config, policies, etc. as code</li><li>Git flow as the continuous deployments workflow via Pull Requests and branches</li><li>Continuous deployments by pulling Kubernetes manifests instead of having agent/tool pushing stuffs in Kubernetes: more secure, more centralized and way more simplified setup and control.</li></ul><p>Now we have the concepts, what we would like to do here is creating a Git repository ready to host the Kubernetes manifests associated to the applications I would like to deploy on my Kubernetes cluster(s).</p><h2 id=prepare-the-git-repository>Prepare the Git repository
<a href=#prepare-the-git-repository class=h-anchor aria-hidden=true>#</a></h2><p>Install <code>nomos</code>:</p><pre tabindex=0><code>gsutil cp gs://config-management-release/released/latest/linux_amd64/nomos nomos
chmod +x nomos
sudo mv nomos /usr/local/bin/nomos
nomos version
</code></pre><p>Initialize your Git repo:</p><pre tabindex=0><code>nomos init
nomos status
# git add, git push...
</code></pre><p>You now have this structure in your Git repository:</p><pre tabindex=0><code>cluster/
clusterregistry/
namespaces/ # configs that are scoped to namespaces
system/
└── README.md
└── repo.yaml
</code></pre><p>Let&rsquo;s create our first Kubernetes manifest:</p><pre tabindex=0><code>mkdir namespaces/hello
cat &gt; namespaces/hello/policy.yaml &lt;&lt; EOF
kind: Namespace
apiVersion: v1
metadata:
  name: hello
EOF
# git add, git push...
</code></pre><p>You could check the syntax and validity of the configs in your repository:</p><pre tabindex=0><code>nomos vet
</code></pre><h2 id=prepare-your-gke-cluster>Prepare your GKE cluster
<a href=#prepare-your-gke-cluster class=h-anchor aria-hidden=true>#</a></h2><p>Register your GKE cluster with an Anthos entitlement:</p><pre tabindex=0><code>projectId=FIXME
gcloud config set project $projectId

# ACM comes with Anthos
gcloud services enable anthos.googleapis.com
gcloud beta container hub config-management enable

# Add our cluster as a Hub membership
clusterName=FIXME
zone=FIXME
gcloud container hub memberships register $clusterName \
  --gke-cluster $zone/$clusterName \
  --enable-workload-identity
</code></pre><h2 id=setup-the-continuous-deployments>Setup the continuous deployments
<a href=#setup-the-continuous-deployments class=h-anchor aria-hidden=true>#</a></h2><p>Setup Config Sync to actually synchronised that repo in your GKE cluster:</p><pre tabindex=0><code>syncRepo=FIXME
branch=FIXME
cat &gt; configsync-config.yaml &lt;&lt; EOF
applySpecVersion: 1
spec:
  configSync:
    enabled: true
    sourceFormat: hierarchy
    syncRepo: $syncRepo
    syncBranch: $branch
    secretType: none
    policyDir: .
EOF

gcloud beta container hub config-management apply \
  --membership=$clusterName \
  --config=configsync-config.yaml
</code></pre><p>Wait for few seconds, and check everything is deployed and synchronized properly:</p><pre tabindex=0><code># You should see your cluster&#39;s status as SYNCED:
nomos status
gcloud alpha container hub config-management status

# You should now see the hello namespace we defined earlier:
kubectl get ns

# This hello namespace should be tagged as managed by Config Sync too:
kubectl get ns -l app.kubernetes.io/managed-by=configmanagement.gke.io
</code></pre><p>And that&rsquo;s it! Now, any update on this repository with any Kubernetes manifests will be synchronized and applied by Config Sync for you. From here, you may want to have different branches pointing to different clusters and having in place a solid and easy continuous deployments workflow via Pull Requests and branches.</p><p>Notes:</p><ul><li>I used a public GitHub repository, in the real life you will need to <a href=https://cloud.google.com/anthos-config-management/docs/how-to/installing-config-sync#git-creds-secret>grant the Config Sync Operator access to your private Git repository</a>.</li><li>If you delete the Kubernetes objects managed and synchronized by Config Sync in your cluster, they will be recreated by Config Sync.</li><li>You could manage the deployments on multi-clusters from within the same Git repository by using the concept of <a href=https://cloud.google.com/anthos-config-management/docs/how-to/cluster-scoped-objects>Cluster selectors</a>.</li><li>For the upgrade of <code>nomos</code> and Config Sync, it&rsquo;s respectively documented <a href=https://cloud.google.com/anthos-config-management/docs/how-to/nomos-command#installing>here</a> and <a href=https://cloud.google.com/anthos-config-management/docs/how-to/upgrading-config-sync>here</a>.</li><li><code>Helm</code> and <code>Kustomize</code> are not yet supported by Config Sync.</li></ul><p>Complementary and further resources:</p><ul><li><a href=https://www.cncf.io/blog/2022/01/07/top-gitops-tactics-to-build-secure-cloud-native-infrastructure/>Top GitOps Tactics to Build Secure Cloud-Native Infrastructure</a></li><li><a href=https://youtu.be/_MrHbQKbPDY>Managing Kubernetes with Config Sync</a></li><li><a href=https://cloud.google.com/anthos-config-management/docs/downloads>Config Management downloads</a></li><li><a href=https://cloud.google.com/anthos-config-management/docs/reference/errors>Config Sync errors reference</a></li><li><a href=https://www.weave.works/technologies/gitops/>Guide to GitOps by Weavework</a></li><li><a href=https://github.com/GoogleCloudPlatform/csp-config-management>More Anthos Config Management samples</a></li><li><a href=https://seroter.com/2021/01/12/how-gitops-and-the-krm-make-multi-cloud-less-scary/>How GitOps and the KRM make multi-cloud less scary</a></li><li><a href=https://www.arctiq.ca/our-blog/2021/1/18/cicd-pipelines-using-gitlab-ci-argo-cd-with-anthos-config-management/>GitLab CI and ArgoCD with Anthos Config Management</a></li></ul><p>Hope you enjoyed that one, happy sailing! ;)</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mathieu-benoit.github.io/myblog/posts/2021/03/autopilot/><span class=button__icon>←</span>
<span class=button__text>fasten your seatbelt, and turn autopilot mode on</span></a></span>
<span class="button next"><a href=https://mathieu-benoit.github.io/myblog/posts/2021/01/oci-artifact-registry/><span class=button__text>host helm charts and oci artifacts in google artifact registry</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>always up, always on</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mathieu-benoit.github.io/myblog/assets/main.js></script>
<script src=https://mathieu-benoit.github.io/myblog/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8536XT21V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8536XT21V",{anonymize_ip:!1})}</script></body></html>